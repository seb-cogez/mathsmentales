import utils from"./utils.js";import math from"./math.js";import Figure from"./figure.js";import library from"./library.js";export default class activity{constructor(obj){_.isObject(obj)?this.setParams(obj):_.isString(obj)&&(this.id=obj)}setParams(obj){this.id=obj.id||obj.ID,this.type=obj.type,this.figure=obj.figure,this.title=obj.title,this.description=obj.description,this.vars=obj.vars,this.consts=obj.consts,this.repeat=obj.repeat||!1,this.options=utils.clone(obj.options)||void 0,this.questionPatterns=utils.clone(obj.questionPatterns)||obj.question,this.shortQuestionPatterns=utils.clone(obj.shortQuestionPatterns)||obj.shortq||!1,this.answerPatterns=utils.clone(obj.answerPatterns)||obj.answer,this.valuePatterns=utils.clone(obj.valuePatterns)||obj.value,this.questions=utils.clone(obj.questions)||[],this.shortQuestions=utils.clone(obj.shortQuestions)||[],this.answers=utils.clone(obj.answers)||[],this.samples=utils.clone(obj.samples)||[],this.values=utils.clone(obj.values)||[],this.figures=utils.clone(obj.figures)||[],this.examplesFigs={},this.chosenOptions=utils.clone(obj.chosenOptions)||[],this.chosenQuestions=utils.clone(obj.chosenQuestions)||{},this.chosenQuestionTypes=utils.clone(obj.chosenQuestionTypes)||[],this.tempo=utils.clone(obj.tempo)||this.Tempo,this.nbq=utils.clone(obj.nbq)||this.nombreQuestions,this.getOptionHistory=[],this.getPatternHistory={global:[]},this.keys=obj.keys||[],this.textSize=obj.textSize||!1,this.valueType=obj.valueType||!1}initialize(){this.questions=[],this.shortQuestions=[],this.answers=[],this.values=[],this.figures=[],this.examplesFigs={},this.intVarsHistoric={},this.getOptionHistory=[],this.getPatternHistory={global:[]}}get nombreQuestions(){return document.getElementById("nbq-slider")?Number(document.getElementById("nbq-slider").value):10}set nombreQuestions(value){this.nbq=Number(value)}get Tempo(){return document.getElementById("tempo-slider")?Number(document.getElementById("tempo-slider").value):8}set Tempo(value){this.tempo=Number(value)}export(){return"i="+this.id+"~o="+utils.tableToText(this.chosenOptions)+"~q="+utils.objToText(this.chosenQuestions)+"~p="+this.chosenQuestionTypes+"~t="+this.tempo+"~n="+this.nbq}static import(obj,id){let regexp,level,url="N"+/^(\d{1,2}|T|G)/.exec(obj.i)[0]+"/"+obj.i+".json";return library.import(url).then(json=>{let act=new this(json);return act.chosenOptions=obj.o,act.chosenQuestionTypes=obj.p,act.chosenQuestions=obj.q,act.tempo=obj.t,act.nbq=obj.n,[id,act]},err=>{utils.debug(err)})}getOption(){if(!this.options)return!1;let ret=0;return 0===this.getOptionHistory.length&&(1===this.chosenOptions.length?this.getOptionHistory=utils.clone(this.chosenOptions):this.chosenOptions.length>1?this.getOptionHistory=utils.shuffle(utils.clone(this.chosenOptions)):this.getOptionHistory=utils.shuffle(Array.from(Array(this.options.length).keys()))),ret=this.getOptionHistory[0],this.getOptionHistory.shift(),ret}setMath(content){return void 0===this.type||"latex"===this.type?'<span class="math">'+content+"</span>":content}display(cle="sample"){this.initialize(),document.getElementById("param-title-act").innerHTML=this.id,document.getElementById("activityTitle").innerHTML=this.title,this.description?document.getElementById("activityDescription").innerHTML=this.description:document.getElementById("activityDescription").innerHTML="";let examples=document.getElementById("activityOptions");if(examples.innerHTML="",utils.setSeed(cle),void 0!==this.options&&this.options.length>0){let colors=[""," red"," orange"," blue"," green"," grey"],p=utils.create("span",{className:"bold"}),hr=utils.create("hr"),input=utils.create("input",{type:"checkbox",id:"checkalloptions",className:"checkbox blue",id:"chckallopt"});p.appendChild(input),p.appendChild(document.createTextNode(" Tout (dé)sélectionner")),examples.appendChild(p),examples.appendChild(hr);let optionsLen=0;for(let i=0;i<this.options.length;i++){this.generate(1,i,!1);let p=utils.create("span"),input=utils.create("input",{id:"o"+i,type:"checkbox",value:i,defaultChecked:this.chosenOptions.indexOf(i)>-1,className:"checkbox"+colors[i%colors.length]});p.appendChild(input),p.innerHTML+=" "+this.options[i].name+" :";let ul=document.createElement("ul");if(Array.isArray(this.questions[0])){if(this.figures[0]){let div=utils.create("div");this.examplesFigs[i]=new Figure(utils.clone(this.figures[0]),"fig-ex"+i,div),p.appendChild(div)}for(let jj=0;jj<this.questions[0].length;jj++){optionsLen++;let li=utils.create("li",{className:"tooltip"}),checked="";this.chosenQuestions[i]&&this.chosenQuestions[i].indexOf(jj)>-1&&(checked="checked"),li.innerHTML="<input class='checkbox"+colors[i%colors.length]+"' type='checkbox' id='o"+i+"-"+jj+"' value='"+i+"-"+jj+"'"+checked+"> "+this.setMath(this.questions[0][jj]);let span=utils.create("span",{className:"tooltiptext"});Array.isArray(this.answers[0])?span.innerHTML=this.setMath(String(this.answers[0][jj]).replace(this.questions[0],this.questions[0][jj])):span.innerHTML=this.setMath(String(this.answers[0]).replace(this.questions[0],this.questions[0][jj])),li.appendChild(span),ul.appendChild(li)}}else{optionsLen++;let li=utils.create("li",{className:"tooltip",innerHTML:this.setMath(this.questions[0])});this.figures[0]&&(this.examplesFigs[i]=new Figure(utils.clone(this.figures[0]),"fig-ex"+i,li));let span=utils.create("span",{className:"tooltiptext"});Array.isArray(this.answers[0])?span.innerHTML=this.setMath(this.answers[0][0]):span.innerHTML=this.setMath(this.answers[0]),li.appendChild(span),ul.appendChild(li)}p.appendChild(ul),examples.appendChild(p)}optionsLen>3&&""===document.getElementById("phantom").className&&utils.addClass(document.getElementById("divparams"),"colsx2")}else{this.generate(1);let p=document.createElement("span"),ul=document.createElement("ul");if(Array.isArray(this.questions[0]))for(let jj=0;jj<this.questions[0].length;jj++){let li=document.createElement("li");li.className="tooltip",li.innerHTML="<input type='checkbox' class='checkbox' value='"+jj+"' onclick='MM.editedActivity.setQuestionType(this.value, this.checked);' ><span class='math'>"+this.questions[0][jj]+"</span>";let span=document.createElement("span");span.className="tooltiptext",Array.isArray(this.answers[0])?span.innerHTML=this.setMath(this.answers[0][jj].replace(this.questions[0],this.questions[0][jj])):span.innerHTML=this.setMath(this.answers[0].replace(this.questions[0],this.questions[0][jj])),li.appendChild(span),ul.appendChild(li)}else{let li=document.createElement("li");li.className="tooltip",li.innerHTML=this.setMath(this.questions[0]),this.figures[0]&&(this.examplesFigs[0]=new Figure(utils.clone(this.figures[0]),"fig-ex0",li));let span=document.createElement("span");span.className="tooltiptext",span.innerHTML=this.setMath(this.answers[0]),li.appendChild(span),ul.appendChild(li)}p.appendChild(ul),examples.appendChild(p)}utils.isEmpty(this.examplesFigs)||setTimeout(()=>{for(let i in this.examplesFigs)this.examplesFigs[i].display()},300),utils.mathRender()}getPattern(option){if(this.chosenQuestionTypes.length>0){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(utils.clone(this.chosenQuestionTypes)));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(!1===option&&Array.isArray(this.questionPatterns)){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(Array.from(Array(this.questionPatterns.length).keys())));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(!1===option)return!1;if(Array.isArray(this.chosenQuestions[option])||(this.chosenQuestions[option]=[]),Array.isArray(this.getPatternHistory[option])||(this.getPatternHistory[option]=[]),0===this.chosenQuestions[option].length&&Array.isArray(this.options[option].question)){0===this.getPatternHistory[option].length&&(this.getPatternHistory[option]=utils.shuffle(Array.from(Array(this.options[option].question.length).keys())));let ret=this.getPatternHistory[option][0];return this.getPatternHistory[option].shift(),ret}if(0===this.chosenQuestions[option].length&&!this.options[option].question&&Array.isArray(this.questionPatterns)){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(Array.from(Array(this.questionPatterns.length).keys())));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(this.chosenQuestions[option].length>0){0===this.getPatternHistory[option].length&&(this.getPatternHistory[option]=utils.shuffle(utils.clone(this.chosenQuestions[option])));let ret=this.getPatternHistory[option][0];return this.getPatternHistory[option].shift(),ret}return!1}setOption(value,check){var optionId,renderId;if("all"===value){this.chosenOptions=[];for(let i=0,len=this.options.length;i<len;i++){this.chosenQuestions[i]=[];let lenq=0;if("object"==typeof this.options[i].question?lenq=this.options[i].question.length:"object"==typeof this.questionPatterns&&(lenq=this.questionPatterns.length),check){this.chosenOptions.push(i);for(let j=0;j<lenq;j++)this.chosenQuestions[i].push(j),document.getElementById("o"+i+"-"+j).checked=!0;document.getElementById("o"+i).checked=!0}else{for(let j=0;j<lenq;j++)document.getElementById("o"+i+"-"+j).checked=!1;document.getElementById("o"+i).checked=!1}}}else if(value.indexOf("-")>-1){let Ids=value.split("-");optionId=Number(Ids[0]),renderId=Number(Ids[1]),check?(document.getElementById("o"+optionId).checked=!0,this.chosenOptions.indexOf(optionId)<0&&this.chosenOptions.push(optionId),Array.isArray(this.chosenQuestions[optionId])?this.chosenQuestions[optionId].indexOf(renderId)<0&&this.chosenQuestions[optionId].push(renderId):this.chosenQuestions[optionId]=[renderId]):this.chosenQuestions[optionId].removeValue(renderId)&&0===this.chosenQuestions[optionId].length&&(this.chosenOptions.removeValue(optionId),document.getElementById("o"+optionId).checked=!1)}else if(optionId=Number(value),check){if(this.chosenOptions.indexOf(optionId)<0&&this.chosenOptions.push(optionId),this.chosenQuestions[optionId]=[],"object"==typeof this.options[optionId].question)for(let i=0;i<this.options[optionId].question.length;i++)this.chosenQuestions[optionId].push(i),document.getElementById("o"+optionId+"-"+i).checked=!0;else if(Array.isArray(this.questionPatterns))for(let i=0;i<this.questionPatterns.length;i++)this.chosenQuestions[optionId].push(i),document.getElementById("o"+optionId+"-"+i).checked=!0}else if(this.chosenOptions.removeValue(optionId))if("object"==typeof this.options[optionId].question){for(let i=0;i<this.options[optionId].question.length;i++)document.getElementById("o"+optionId+"-"+i).checked=!1;delete this.chosenQuestions[optionId]}else if(Array.isArray(this.questionPatterns)){for(let i=0;i<this.questionPatterns.length;i++)document.getElementById("o"+optionId+"-"+i).checked=!1;delete this.chosenQuestions[optionId]}let boxes=document.querySelectorAll("#activityOptions input[type=checkbox]"),tocheck=!0;for(const checkbox of boxes)if("chckallopt"!==checkbox.id&&!checkbox.checked){tocheck=!1;break}document.getElementById("chckallopt").checked=tocheck}setQuestionType(value,check){let questionId=Number(value);check?this.chosenQuestionTypes.indexOf(questionId)<0&&this.chosenQuestionTypes.push(questionId):this.chosenQuestionTypes.removeValue(questionId)}replaceVars(chaine,questiontext){function onlyVarw(all,p1,p2,decal,chaine){return"this.wVars['"+p1+"']"+p2}function onlyVarc(all,p1,p2,decal,chaine){return"this.cConsts['"+p1+"']"+p2}if("string"==typeof chaine){for(const c in this.wVars){let regex=new RegExp(":("+c+")([^\\w\\d])","g");chaine=chaine.replace(regex,onlyVarw)}for(const c in this.cConsts){let regex=new RegExp(":("+c+")([^\\w\\d])","g");chaine=chaine.replace(regex,onlyVarc)}if(void 0!==questiontext){let regex=/:question/g;chaine=chaine.replace(regex,questiontext)}let result="";try{result=eval("`"+chaine.replace(/\\/g,"\\\\")+"`")}catch(error){utils.debug(error,"Erreur avec "+chaine)}return isNaN(result)?result:parseFloat(result)}if("object"==typeof chaine){if(_.isArray(chaine))for(let i=0;i<chaine.length;++i)chaine[i]=this.replaceVars(chaine[i],questiontext);else for(const i in chaine)chaine[i]=this.replaceVars(chaine[i],questiontext);return chaine}return chaine}generate(n=this.nbq,opt,patt,sample){let optionNumber,patternNumber,lenQ=!1;this.wVars={};let loopProtect=0,maxLoop=100;this.figures=[],this.intVarsHistoric={};for(let i=0;i<n;i++){this.cFigure=void 0,optionNumber=void 0!==opt?opt:this.getOption(),patternNumber=void 0!==patt?patt:this.getPattern(optionNumber),!1!==optionNumber?(void 0===this.options[optionNumber].vars?this.cVars=this.vars:this.cVars=this.options[optionNumber].vars,void 0===this.options[optionNumber].consts?this.cConsts=utils.clone(this.consts):this.cConsts=utils.clone(this.options[optionNumber].consts),!1!==patternNumber?void 0!==this.options[optionNumber].question?(this.cQuestion=this.options[optionNumber].question[patternNumber],lenQ=this.options[optionNumber].question.length,void 0!==this.options[optionNumber].shortq&&(this.cShortQ=this.options[optionNumber].shortq[patternNumber]||!1)):(this.cQuestion=this.questionPatterns[patternNumber],this.cShortQ=this.shortQuestionPatterns[patternNumber]||!1,lenQ=this.questionPatterns.length):void 0===this.options[optionNumber].question?(this.cQuestion=this.questionPatterns,this.cShortQ=this.shortQuestionPatterns||!1):(this.cQuestion=this.options[optionNumber].question,this.cShortQ=this.options[optionNumber].shortq||!1),void 0===this.options[optionNumber].answer?this.cAnswer=this.answerPatterns:this.cAnswer=this.options[optionNumber].answer,void 0===this.options[optionNumber].value?this.cValue=this.valuePatterns:this.cValue=this.options[optionNumber].value,Array.isArray(this.cAnswer)&&lenQ&&(this.cAnswer.length===lenQ?this.cAnswer=this.cAnswer[patternNumber]:this.cAnswer=this.cAnswer[math.aleaInt(0,this.cAnswer.length-1)],this.cValue.length===lenQ&&(this.cValue=this.cValue[patternNumber])),void 0!==this.options[optionNumber].figure?this.cFigure=utils.clone(this.options[optionNumber].figure):void 0!==this.figure&&(this.cFigure=utils.clone(this.figure))):(this.cVars=this.vars,this.cConsts=utils.clone(this.consts),!1!==patternNumber?(this.cQuestion=this.questionPatterns[patternNumber],this.cShortQ=this.shortQuestionPatterns[patternNumber]||!1):(this.cQuestion=this.questionPatterns,this.cShortQ=this.shortQuestionPatterns||!1),Array.isArray(this.answerPatterns)&&this.answerPatterns.length===this.questionPatterns.length?this.cAnswer=this.answerPatterns[patternNumber]:this.cAnswer=this.answerPatterns,this.cValue=this.valuePatterns,void 0!==this.figure&&(this.cFigure=utils.clone(this.figure)));for(const name in this.cVars)if(this.wVars[name]=this.cVars[name],"string"==typeof this.wVars[name]&&this.wVars[name].indexOf("${")>-1&&(this.wVars[name]=this.replaceVars(this.wVars[name])),"object"==typeof this.wVars[name])this.wVars[name]=this.replaceVars(this.wVars[name][math.aleaInt(0,this.wVars[name].length-1)]);else if("string"==typeof this.wVars[name]&&this.wVars[name].indexOf("_")>-1){var bornes=this.wVars[name].split("_");if(bornes[0].indexOf("d")>-1)this.wVars[name]=math.aleaFloat(Number(bornes[0].substring(1)),Number(bornes[1]),Number(bornes[2]),bornes[3],bornes[4]);else{if(void 0===this.intVarsHistoric[name]){let nbValues=Math.abs(Number(bornes[1])-Number(bornes[0]))+1,max=Math.max(Number(bornes[0]),Number(bornes[1])),min=Math.min(Number(bornes[0]),Number(bornes[1])),primes=[],objContraintes=!1;if(bornes[2]&&bornes[2].indexOf("^")>-1&&(objContraintes=bornes[2]),bornes[3]&&bornes[3].indexOf("^")>-1&&(objContraintes=bornes[3]),objContraintes){let liste=objContraintes.substring(1).split(",");if(liste.indexOf("prime")>-1)for(let i=0;i<math.premiers.length;i++)if(math.premiers[i]<=max&&math.premiers[i]>=min)primes.push(math.premiers[i]);else if(math.premiers[i]>max)break;nbValues=nbValues-liste.length-primes.length+(liste.indexOf("prime")>-1?1:0)+(liste.indexOf("&")>-1?1:0)}this.intVarsHistoric[name]=[],this.intVarsHistoric[name+"-length"]=nbValues}let entier,protectionLoop=0;do{if(entier=math.aleaInt(Number(bornes[0]),Number(bornes[1]),bornes[2],bornes[3]),protectionLoop++,protectionLoop>100)break}while(this.intVarsHistoric[name].indexOf(entier)>-1);this.intVarsHistoric[name].push(entier),this.intVarsHistoric[name].length>=this.intVarsHistoric[name+"-length"]&&this.intVarsHistoric[name].splice(0),this.wVars[name]=entier}}if(void 0!==this.cConsts&&(this.cConsts=this.replaceVars(this.cConsts)),sample)this.sample={question:this.replaceVars(this.cQuestion)},this.cShortQ&&(this.sample.shortQuestion=this.replaceVars(this.cShortQ)),this.sample.answer=this.replaceVars(this.cAnswer,this.sample.question),void 0!==this.cFigure&&(this.sample.figure={type:this.cFigure.type,content:this.replaceVars(this.cFigure.content),boundingbox:this.cFigure.boundingbox,axis:this.cFigure.axis,grid:!!this.cFigure.grid,keepAspect:void 0===this.cFigure.keepAspect||this.cFigure.keepAspect});else{let thequestion=this.replaceVars(utils.clone(this.cQuestion)),thevalue=this.replaceVars(utils.clone(this.cValue)),theshort=!1;if(this.cShortQ&&(theshort=this.replaceVars(utils.clone(this.cShortQ))),loopProtect++,!(this.questions.indexOf(thequestion)<0||this.values.indexOf(thevalue)<0||this.repeat)){if(i--,loopProtect<100)continue;utils.debug("Pas assez de données pour éviter les répétitions");break}if("number"==typeof this.repeat){let last2Values=this.values.slice(-this.repeat),count=0;for(let i=0;i<last2Values.length;i++)last2Values[i]===thevalue&&count++;if(count>=2){if(i--,loopProtect<100)continue;utils.debug("To many loops");break}}else if(this.repeat){let last5Questions=this.questions.slice(-5),last5values=this.values.slice(-5);if(last5Questions.indexOf(thequestion)>-1&&last5values.indexOf(thevalue)>-1){if(i--,loopProtect<100)continue;utils.debug("Pas assez de données pour éviter les répétitions");break}}this.questions[i]=thequestion,this.shortQuestions[i]=theshort,this.answers[i]=this.replaceVars(utils.clone(this.cAnswer),thequestion),this.values[i]=thevalue,void 0!==this.cFigure&&(this.figures[i]={type:this.cFigure.type,content:this.replaceVars(utils.clone(this.cFigure.content)),boundingbox:this.cFigure.boundingbox,axis:this.cFigure.axis,grid:!!this.cFigure.grid,keepAspect:void 0===this.cFigure.keepAspect||this.cFigure.keepAspect})}}}generateSample(){let option=this.getOption();this.generate(1,option,this.getPattern(option),!0)}}
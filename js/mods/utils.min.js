import MM from"./MM.js";import cart from"./cart.js";import library from"./library.js";import draw from"./draw.js";import sound from"./sound.js";export{utils as default};const moisFR=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],joursFR=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],utils={baseURL:window.location.href.split("?")[0].split("#")[0],seed:"sample",security:300,modeDebug:!0,debug:function(){utils.modeDebug&&console.log(arguments)},create:function(type,props){const elt=document.createElement(type);for(const p in props)elt[p]=props[p];return elt},copy(DOMel){let text=DOMel.value;navigator.clipboard.writeText(text).then(()=>{DOMel.className="copied",setTimeout(()=>{DOMel.className=""},3e3)}).catch(err=>{console.log("erreur de copie dans le presse papier")})},pageWidth:()=>null!=window.innerWidth?window.innerWidth:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientWidth:null!=document.body?document.body.clientWidth:null,goToOldVersion(){window.location.href=utils.baseURL+"old/"+/(^.*\/)(.*)/.exec(window.location.href)[2]},setHistory(pageName,params){let url=MM.setURL(params);history.pushState({id:"Homepage"},pageName,url)},checkRadio(name,value){let domElt=document.querySelector("input[type=radio][name='"+name+"'][value='"+value+"']");if(!domElt)return!1;domElt.click()},selectOption(id,value){let domElt=document.getElementById(id);for(let i=0;i<domElt.options.length;i++)if(domElt.options[i].value===value){domElt.selectedIndex=i;break}},getTypeOfURL:url=>url.indexOf("exercices.html")>-1?"paramsexos":url.indexOf("courseauxnombres.html")>-1?"paramscourse":url.indexOf("dominos.html")>-1?"paramsdominos":url.indexOf("duel.html")>-1?"paramsduel":"paramsdiapo",countValue(array,value){let count=0;for(let i=0,j=array.length;i<j;i++)array[i]===value&&count++;return count},checkURL(urlString=!1,start=!0,edit=!1){const vars=utils.getUrlVars(urlString);if(vars.cor&&vars.ex&&location.href.indexOf("exercices.html")<0&&!edit){let url=new URL(location.href);location.href=url.origin+url.pathname.replace("index.html","")+"exercices.html"+url.search}if(void 0!==vars.embed){let expression,regex=new RegExp(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0===vars.n||void 0!==vars.cd||edit)if(void 0===vars.u||void 0!==vars.cd||edit){if(void 0!==vars.c){let alert=utils.create("div",{id:"messageinfo",className:"message",innerHTML:"Chargement de l'activité MathsMentales.<br>Merci pour la visite."});if(document.getElementById("tab-accueil").appendChild(alert),"yes"!==vars.o||edit)setTimeout(()=>{utils.closeMessage("messageinfo")},3e3);else{start=!1,alert.innerHTML+="<br><br>";let button=utils.create("button",{innerHTML:"Commencer !"});button.onclick=()=>{utils.closeMessage("messageinfo"),MM.checkLoadedCarts(!0)},alert.appendChild(button)}if(MM.introType=vars.i,MM.endType=vars.e,"string"==typeof vars.colors){let couleurs=vars.colors.split("~");for(let i=0;i<couleurs.length;i++)MM.colors[i]=couleurs[i].replace(/_/g,","),document.getElementById("sddiv"+(i+1)).style.background=MM.colors[i]}vars.o&&(MM.onlineState=vars.o),vars.f&&(MM.faceToFace=vars.f),vars.s&&(MM.slidersNumber=Number(vars.s)),void 0!==vars.snd&&"null"!==vars.snd&&sound.setSound(Number(vars.snd)),(vars.a&&"no"===MM.onlineState||edit)&&(utils.setSeed(vars.a),document.getElementById("aleaInURL").checked=!0),MM.resetCarts(),vars.so&&(MM.slidersOrientation=vars.so);let json=vars.c;"string"==typeof vars.c&&(json=JSON.parse(decodeURIComponent(vars.c)));let allcarts=[];for(const i in json)MM.carts[i]=new cart(i),allcarts.push(MM.carts[i].import(json[i],start));Promise.all(allcarts).then(data=>{if(MM.resetInterface(),MM.restoreCartsInterface(),(MM.carts[0].activities.length>1||MM.carts.length>1)&&MM.showCartInterface(),MM.carts[0].activities.length>1||MM.carts.length>1?(MM.showCart(1),MM.editActivity(0)):(MM.editedActivity=MM.carts[0].activities[0],MM.editedActivity.display()),edit){let element;utils.showTab("tab-parameters"),utils.selectOption("chooseParamType",utils.getTypeOfURL(urlString)),document.getElementById("chooseParamType").dispatchEvent(new Event("change",{bubbles:!0}))}}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger les paniers :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert),setTimeout(()=>{let div=document.getElementById("messageerreur");div.parentNode.removeChild(div)},3e3)})}else if(void 0!==vars.cd||void 0!==vars.panier){let alert=utils.create("div",{className:"message",innerHTML:"Ceci est le nouveau MathsMentales, les anciennes adresses ne sont malheureusement plus compatibles.<hr class='center w50'>Vous allez être redirigé vers l'ancienne version de MathsMentales dans 6 s. <a href='javascript:utils.goToOldVersion();'>Go !</a>"});document.getElementById("tab-accueil").appendChild(alert),setTimeout(utils.goToOldVersion,6e3)}}else{let regexp=/(\d+|T|G)/;if(_.isArray(vars.u)){let listeURLs=[];for(let i=0;i<vars.u.length;i++){let url=vars.u[i],level=regexp.exec(url)[0];listeURLs.push({u:"N"+level+"/"+url+".json",t:""})}library.displayContent(listeURLs)}else if(void 0!==vars.u){let level=regexp.exec(vars.u)[0];library.load("N"+level+"/"+vars.u+".json")}else{let alert=utils.create("div",{className:"message",innerHTML:"Cette activité n'a pas de correspondance dans cette nouvelle version de MathsMentales.<hr class='center w50'>Vous allez être redirigé vers l'ancienne version dans 10s. <a href='javascript:utils.goToOldVersion();'>Go !</a>"});document.getElementById("tab-accueil").appendChild(alert),setTimeout(utils.goToOldVersion,1e4)}}else library.displayContent(vars.n,!0)},superEncodeURI:function(url){for(var encodedStr="",encodeChars=["(",")","{","}"],i=0,len=(url=encodeURIComponent(url)).length;i<len;i++){var hex;if(encodeChars.indexOf(url[i])>=0)encodedStr+="%"+parseInt(url.charCodeAt(i)).toString(16);else encodedStr+=url[i]}return encodedStr},getUrlVars:function(urlString){urlString||(urlString=window.location.href);var vars={},hash;if(urlString.indexOf("#")>0&&urlString.indexOf("?")<0){let idExo=urlString.substring(urlString.indexOf("#")+1,urlString.length);void 0!==MM1toMM2[idExo].new&&(vars.u=MM1toMM2[idExo].new)}var hashes=urlString.replace(/\|/g,"/").slice(urlString.indexOf("?")+1).split("&"),len=hashes.length;if(urlString.indexOf("~")<0)for(var i=0;i<len;i++)vars[(hash=hashes[i].split("="))[0]]=hash[1];else{hash=hashes[0].split(",");for(let i=0;i<hash.length;i++){let data=hash[i].split("=");vars[data[0]]=!!data[1]&&data[1]}vars.c={};for(let i=1;i<len;i++)if(0===hashes[i].indexOf("p")){let parts=hashes[i].split("_"),data=parts[0].split("~"),datas={};for(let j=0;j<data.length;j++){let dataparts=data[j].split("=");datas[dataparts[0]]=decodeURI(dataparts[1])}let id=datas.p;vars.c[id]={i:datas.p,t:datas.t,c:datas.c,o:datas.o,a:{}};for(let j=1;j<parts.length;j++){let datasActivity=parts[j].split("~");vars.c[id].a[j-1]={};for(let k=0;k<datasActivity.length;k++){let dataparts=datasActivity[k].split("=");"o"===dataparts[0]?vars.c[id].a[j-1][dataparts[0]]=utils.textToTable(dataparts[1]):"q"===dataparts[0]?vars.c[id].a[j-1][dataparts[0]]=utils.textToObj(dataparts[1]):vars.c[id].a[j-1][dataparts[0]]=dataparts[1]}}}else if(0===hashes[i].indexOf("embed")){let parts=hashes[i].split("=");vars.embed=parts[1]}}return vars},getDate(){let ladate=new Date,lheure=ladate.getHours(),lesminutes=ladate.getMinutes(),lessecondes=ladate.getSeconds(),ladateComplete;return joursFR[ladate.getDay()]+" "+ladate.getDate()+" "+moisFR[ladate.getMonth()]+" "+ladate.getFullYear()+" - "+(lheure<10?"0"+lheure:lheure)+":"+(lesminutes<10?"0"+lesminutes:lesminutes)+":"+(lessecondes<10?"0"+lessecondes:lessecondes)},timeToSeconds(timeValue){let elems=timeValue.split(":");return 60*Number(elems[0])+Number(elems[1])},seedGenerator:function(){let str="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",code="";for(let i=0;i<6;i++)code+=str[Math.floor(Math.random()*str.length)];return code},setSeed(value){if(void 0!==value&&"sample"!==value&&"checkSwitched"!==value)MM.seed=value,document.getElementById("aleaKey").value=value;else if("sample"===value)MM.seed=utils.seedGenerator();else if(!0===document.getElementById("aleaInURL").checked)""===document.getElementById("aleaKey").value?(MM.seed=utils.seedGenerator(),document.getElementById("aleaKey").value=MM.seed):MM.seed=document.getElementById("aleaKey").value;else{if("checkSwitched"===value)return!1;MM.seed=utils.seedGenerator(),document.getElementById("aleaKey").value=MM.seed}utils.initializeAlea(MM.seed)},addClass:function(elt,newClass){var n=0;newClass=newClass.split(",");for(let i=0;i<newClass.length;i++)-1==(" "+elt.className+" ").indexOf(" "+newClass[i]+" ")&&(elt.className+=" "+newClass[i],n++);return n},getTargetWithImageInside(evt){let target=evt.target;return"img"===evt.target.nodeName.toLowerCase()&&(target=evt.target.parentNode),target},createCeintureTitres(qty){if(qty<1||qty>5)return!1;const dest=document.getElementById("ceintcolumnTitle"),champs=dest.querySelectorAll("input"),labels=dest.querySelectorAll("label"),br=dest.querySelectorAll("br");champs.length<qty?(dest.appendChild(utils.create("br")),dest.appendChild(utils.create("label",{for:"ceinttitlecol"+qty,innerHTML:"Colonne "+qty+" : "})),dest.appendChild(utils.create("input",{type:"text",id:"ceinttitlecol"+qty,placeholder:"Texte, ou rien"}))):champs.length>qty&&(dest.removeChild(labels[champs.length-1]),dest.removeChild(champs[champs.length-1]),dest.removeChild(br[champs.length-1]))},getRadioChecked:function(name){let radio=document.getElementsByName(name);for(let i=0,length=radio.length;i<length;i++)if(radio[i].checked)return radio[i].value;return!1},getSelectValue:function(id){try{let select=document.getElementById(id);return select[select.selectedIndex].value}catch(err){console.log(err)}},numberIfNumber:function(value){return String(Number(value))===value?Number(value):value},isEmpty:function(obj){var x;for(x in obj)return!1;return!0},shuffle:function(arr){if(!Array.isArray(arr))return!1;let curId=arr.length;for(;0!==curId;){let randId=Math.floor(utils.alea()*curId);curId-=1;let tmp=arr[curId];arr[curId]=arr[randId],arr[randId]=tmp}return arr},createTuiles(){let grille;const ordre=library.ordre;function setContent(id,obj){const elt=utils.create("article",{className:"tuile",title:"Cliquer pour afficher toutes les activités du niveau"}),titre=utils.create("h3",{innerHTML:obj.nom});elt.appendChild(titre);const nba=utils.create("div",{innerHTML:obj.activitiesNumber+" activités"});elt.onclick=()=>{library.displayContent(id,!0)},elt.appendChild(nba),grille.appendChild(elt)}for(const o in ordre){grille=document.getElementById(o);for(let i=0;i<ordre[o].length;i++)void 0!==MM.content[ordre[o][i]].activitiesNumber&&0!==MM.content[ordre[o][i]].activitiesNumber&&"activitiesNumber"!==i&&setContent(ordre[o][i],MM.content[ordre[o][i]])}},closeMessage(id){let div=document.getElementById(id);div.parentNode.removeChild(div),document.body.removeEventListener("click",evt=>{"btn-messagefin-close"===evt.target.id&&(utils.closeMessage("messagefin"),utils.showTab("tab-corrige"))})},createSearchCheckboxes(){let dest=document.getElementById("searchLevels");const ordre=library.ordre;for(const o in ordre)for(let i=0;i<ordre[o].length;i++){if(void 0===MM.content[ordre[o][i]].activitiesNumber||0===MM.content[ordre[o][i]].activitiesNumber||"activitiesNumber"===i)continue;const div=utils.create("div"),input=utils.create("input",{type:"checkbox",name:"searchlevel",value:ordre[o][i],className:"checkbox",id:"ccbs"+ordre[o][i]});input.onclick=()=>{library.displayContent(document.getElementById("searchinput").value)};const label=utils.create("label",{for:"ccbs"+ordre[o][i],innerText:MM.content[ordre[o][i]].nom});label.onclick=evt=>{document.getElementById(evt.target.for).click()},div.appendChild(input),div.appendChild(label),dest.appendChild(div)}},deploy(elt){let destClass="hideup",eltClass="pointer plus";if("H3"===elt.nodeName){let dest=elt.nextSibling;elt.className===eltClass&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass,dest.className=destClass}else if("H2"===elt.nodeName)for("pointer plus"===elt.className&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass;null!==elt.nextSibling&&"H2"!==(elt=elt.nextSibling).nodeName;)"UL"===elt.nodeName?elt.className=destClass:"H3"===elt.nodeName&&(elt.className=eltClass);else if("H1"===elt.nodeName){"pointer plus"===elt.className&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass;const h2=document.querySelectorAll("#resultat-chercher h2"),h3=document.querySelectorAll("#resultat-chercher h3"),ul=document.querySelectorAll("#resultat-chercher ul");h2.forEach(el=>el.className=eltClass),h3.forEach(el=>el.className=eltClass),ul.forEach(el=>el.className=destClass)}},tableToText:array=>void 0===array?"":"string"==typeof array?array:array.join(","),textToTable:string=>void 0===string||""===string?[]:string.split(",").map(Number),objToText(obj){if(void 0===obj)return"";let string="",start=!0;for(const i in obj)start?(string+=i+"."+utils.tableToText(obj[i]),start=!1):string+="-"+i+"."+utils.tableToText(obj[i]);return string},textToObj(string){let obj={},elts=string.split("-");for(let i=0;i<elts.length;i++){let subelts=elts[i].split(".");obj[subelts[0]]=utils.textToTable(subelts[1])}return obj},removeClass:function(elt,className){elt.classList.remove(className)},changeTempoValue:function(value){document.getElementById("tempo-value").innerHTML=value+" s.",MM.editedActivity&&(MM.editedActivity.Tempo=value),MM.carts[MM.selectedCart].editedActivityId>-1&&(document.querySelectorAll("#cart"+MM.selectedCart+"-list li.active span")[0].innerHTML=value)},changeNbqValue:function(value){document.getElementById("nbq-value").innerHTML=value,MM.editedActivity&&(MM.editedActivity.nombreQuestions=value),MM.carts[MM.selectedCart].editedActivityId>-1&&(document.querySelectorAll("#cart"+MM.selectedCart+"-list li.active span")[1].innerHTML=value)},checkValues:function(){utils.changeTempoValue(document.getElementById("tempo-slider").value),utils.changeNbqValue(document.getElementById("nbq-slider").value)},checkSecurity:()=>(utils.security--,!(utils.security<0)||(console.log("infinite loop"),!1)),initializeAlea:function(seed){seed?(utils.alea&&delete utils.alea,utils.alea=new Math.seedrandom(seed)):(utils.alea&&delete utils.alea,utils.alea=new Math.seedrandom(MM.seed))},showTab:function(element){let tab,el;utils.resetAllTabs(),"none"!==element&&("string"==typeof element?(tab=element,el=document.querySelector("#header-menu a[numero='#"+element+"']")):(el=element,tab=element.getAttribute("numero").substr(1)),utils.addClass(el,"is-active"),document.getElementById(tab).style.display="")},showParameters:function(id){let ids=["paramsdiapo","paramsexos","paramsinterro","paramsceinture","paramsflashcards","paramswhogots","paramsdominos","paramscourse","paramsduel"];if(ids.indexOf(id)<0)return!1;for(let i=0,len=ids.length;i<len;i++)document.getElementById(ids[i]).className="hidden";document.getElementById(id).className=""},resetAllTabs:function(){utils.annotate(!1);let tabsButtons=document.querySelectorAll("#header-menu .tabs-menu-link"),contents=document.querySelectorAll(".tabs-content-item");document.getElementById("tab-accueil").display="none",contents.forEach(element=>{element.style.display="none"}),utils.removeClass(document.getElementById("btnaccueil"),"is-active"),tabsButtons.forEach(element=>{utils.removeClass(element,"is-active")})},toDecimalFr:function(value){let parties=value.split("."),partieEntiere=parties[0],partieDecimale="";if(parties.length>1&&(partieDecimale=parties[1]),partieEntiere.length>3){let s=partieEntiere.length%3;partieEntiere=partieEntiere.substring(0,s)+"~"+partieEntiere.substring(s).match(/\d{3}/g).join("~")}if(partieDecimale.length>3){let nbgp=~~(partieDecimale.length/3);partieDecimale=partieDecimale.match(/\d{3}/g).join("~")+"~"+partieDecimale.substring(3*nbgp)}return partieDecimale.length&&(partieDecimale="{,}"+partieDecimale),partieEntiere+partieDecimale},annotate:function(target,btnId){!1===target&&void 0!==MM.annotate?(MM.annotate.destroy(),MM.annotate=void 0):void 0===MM.annotate&&_.isString(target)?MM.annotate=new draw(target,btnId):void 0!==MM.annotate&&(MM.annotate.destroy(),MM.annotate=void 0)},mathRender:function(wtarget){let contents;if(["enonce-content","corrige-content","activityOptions","activityDescription"].forEach(id=>{let content=document.getElementById(id).innerHTML;document.getElementById(id).innerHTML=content.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>')}),document.querySelectorAll(".slide").forEach(elt=>{elt.innerHTML=elt.innerHTML.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>')}),void 0!==wtarget){let content=wtarget.document.getElementById("creator-content");content.innerHTML=content.innerHTML.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>'),content.querySelectorAll(".math").forEach((function(item){var texTxt=item.innerHTML.replace(/\&amp\;/g,"&");let nbrgx=/(\d+\.*\d*)/g;texTxt=texTxt.replace(nbrgx,utils.toDecimalFr);try{katex.render(texTxt,item,{throwOnError:!1,errorColor:"#FFF",colorIsTextColor:!0}),utils.removeClass(item,"math")}catch(err){item.innerHTML="<span class='err'>"+err+" avec "+texTxt+"</span>"}}))}document.querySelectorAll(".math").forEach((function(item){var texTxt=item.innerHTML.replace(/\&amp\;/g,"&");let nbrgx=/(\d+\.*\d*)/g;texTxt=texTxt.replace(nbrgx,utils.toDecimalFr);try{katex.render(texTxt,item,{throwOnError:!1,errorColor:"#FFF",colorIsTextColor:!0}),utils.removeClass(item,"math")}catch(err){item.innerHTML="<span class='err'>"+err+" avec "+texTxt+"</span>"}}))},clone:someThing=>void 0!==someThing&&("object"==typeof someThing?JSON.parse(JSON.stringify(someThing)):someThing),toDigits(value,digits){let puissance=Number("1e"+digits)-1;for(;String(value).length<String(puissance).length;)value="0"+value;return value}};
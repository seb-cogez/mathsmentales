import math from"./math.js";import activity from"./activity.js";import MM from"./MM.js";import utils from"./utils.js";export default class cart{constructor(t){this.id=t,this.activities=[],this.ordered=!0,this.sortable=void 0,this.editedActivityId=-1,this.target=[t],this.nbq=0,this.time=0,this.title="Diapo "+(t+1),this.loaded=!1}export(){let t="&p="+this.id+"~t="+encodeURI(this.title)+"~c="+this.target+"~o="+this.ordered;for(let e=0,i=this.activities.length;e<i;e++)t+="_"+this.activities[e].export();return t}import(t,e=!1){this.title=t.t,this.target=t.c,"false"!==t.o&&t.o?this.ordered=!0:this.ordered=!1;let i=[];for(const e in t.a)i.push(activity.import(t.a[e],e));return Promise.all(i).then((t=>{t.forEach((t=>{this.activities[t[0]]=t[1]})),this.loaded=!0,null!==document.querySelector("#tab-parameters")&&this.display(),e&&MM.checkLoadedCarts()})).catch((t=>{let e=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger tous les exercices :(<br>"+t});document.getElementById("tab-accueil").appendChild(e),setTimeout((()=>{let t=document.getElementById("messageerreur");t.parentNode.removeChild(t)}),3e3)}))}duplicate(){if(MM.carts.length<4){MM.addCart();let t=MM.carts[MM.carts.length-1];for(let e=0;e<this.activities.length;e++)t.addActivity(this.activities[e]);t.display()}}addActivity(t){this.editedActivityId=-1;let e=new activity(t);this.activities.push(e),this.display()}removeActivity(t){this.activities.splice(t,1),this.display()}exchange(t,e){let i=this.activities.getKeys(),s=i[t],r=this.activities[t];this.activities.splice(t,1),i.splice(t,1),this.activities.splice(e,0,r),i.splice(e,0,s),this.editedActivityId=Number(i.indexOf(this.editedActivityId)),this.display()}display(){document.querySelector("#cart"+this.id+" h3").innerText=this.title;let t=document.getElementById("cart"+this.id+"-list");t.innerHTML="",this.time=0,this.nbq=0;let e=document.querySelector("#cart"+this.id+" span[data-ordered]");this.ordered?(e.innerHTML="ordonné",e.dataset.ordered="true"):(e.innerHTML="mélangé",e.dataset.ordered="false");for(let e=0,i=this.activities.length;e<i;e++){let i=document.createElement("li"),s=this.activities[e];this.time+=Number(s.tempo)*Number(s.nbq),this.nbq+=Number(s.nbq),i.innerHTML="<img src='img/editcart.png' align='left' data-actid='"+e+"' title=\"Editer l'activité\">"+s.title+" (<span>"+s.tempo+"</span> s. / <span>"+s.nbq+"</span> quest.)",MM.carts[this.id].editedActivityId===e&&(i.className="active"),t.appendChild(i)}let i=document.querySelectorAll("#cart"+this.id+" div.totaux span");i[0].innerHTML=math.sToMin(this.time),i[1].innerHTML=this.nbq,i[2].innerHTML=this.target,this.sortable=new Sortable(t,{animation:150,ghostClass:"ghost-movement",onEnd:t=>MM.carts[this.id].exchange(t.oldIndex,t.newIndex)})}changeOrder(t){"true"===t.dataset.ordered?(t.innerHTML="mélangé",t.title="Affichage mélangé des questions",t.dataset.ordered="false",this.ordered=!1):(t.innerHTML="ordonné",t.title="Affichage dans l'ordre des activités",t.dataset.ordered="true",this.ordered=!0)}}
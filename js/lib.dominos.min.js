import protos from"./mods/protos.js";import utils from"./mods/utils.js";import common from"./mods/common.js";import cart from"./mods/cart.js";import Zoom from"./mods/zoom.js";import Figure from"./mods/figure.js";import math from"./mods/math.js";const MM={},content=document.getElementById("creator-content"),parameters={};let zoom;function changeFond(evt){var input=evt.target,reader=new FileReader;reader.onload=function(){replaceFond(reader.result)},reader.readAsDataURL(input.files[0])}function replaceFond(imgdata){let delimgel=document.getElementById("deleteImg");if(void 0===imgdata)delete MM.bgImg,document.querySelectorAll(".dominos-carte").forEach(el=>{el.style.backgroundImage="none"}),delimgel.style.display="none";else{let img=new Image;img.src=imgdata,MM.bgImg=imgdata,delimgel.style.display="inline",document.querySelectorAll(".dominos-carte").forEach(el=>{el.style.backgroundImage="url('"+img.src+"')"})}}function changeheight(nb){let elts=document.querySelectorAll(".dominos-carte");for(let i=0;i<elts.length;i++)elts[i].style.height=nb+"mm"}function changewidth(nb){let elts=document.querySelectorAll(".dominos-carte");for(let i=0;i<elts.length;i++)elts[i].style.width=nb+"mm"}function setNumberOfDominos(){1===parameters.cart.activities.length&&(parameters.cart.activities[0].nbq=parameters.nb)}function melanger(){let content=document.querySelector(".dominos-section"),tableau=document.querySelectorAll(".dominos-carte"),cles=[...Array(tableau.length)].map((a,b)=>b);cles.sort(()=>Math.random()-.5);for(let j=0,l=cles.length;j<l;j++)content.removeChild(tableau[cles[j]]),content.appendChild(tableau[cles[j]])}function noDoublon(){parameters.doublons=!parameters.doublons,parameters.doublons?document.getElementById("btnnodoublon").innerHTML="No Doublons":document.getElementById("btnnodoublon").innerHTML="Doublons",refresh(),console.log(parameters)}function refresh(){makePage(),common.mathRender()}function makePage(){parameters.alea&&common.setSeed(parameters.alea),content.innerHTML="",MM.memory={},setNumberOfDominos();let aleaCode=utils.create("div",{className:"floatright",innerHTML:"Clé : "+parameters.alea});content.appendChild(aleaCode);let sectionCartes=utils.create("section",{className:"dominos-section"}),nbOfCards=0;common.generateQuestions(parameters);let span=document.getElementById("infoErrorDouble");parameters.errorDouble?(span.innerHTML="Impossible de supprimer les doublons",span.title="Les choix d'activité ne permettent pas de générer un ensemble de dominos sans doublon. Diminuer le nombre de questions ou modifier le choix d'activités."):(span.innerHTML="",span.title="");for(let i=0;i<parameters.cart.activities.length;i++){const activity=parameters.cart.activities[i];for(let j=0;j<activity.questions.length;j++){nbOfCards++;let carte=utils.create("article",{className:"dominos-carte",id:"domino"+nbOfCards});carte.style.width=document.getElementById("inputwidth").value+"mm",carte.style.height=document.getElementById("inputheight").value+"mm",MM.bgImg&&(carte.style.backgroundImage="url('"+MM.bgImg+"')");let hr=utils.create("div",{className:"barrev",innerHTML:"&nbsp;"});carte.appendChild(hr);let artQuestion=utils.create("article",{className:"dominos-question"}),divq=utils.create("div");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=utils.create("span",{className:"math",innerHTML:activity.questions[j]});divq.appendChild(span)}else divq.innerHTML=activity.questions[j];artQuestion.appendChild(divq),carte.appendChild(artQuestion),void 0!==activity.figures[j]&&(void 0===MM.memory.dest&&(MM.memory.dest=content),MM.memory["f"+nbOfCards]=new Figure(utils.clone(activity.figures[j]),"f"+nbOfCards,divq)),sectionCartes.appendChild(carte)}}content.appendChild(sectionCartes);let numAnswer=1;for(let i=0;i<parameters.cart.activities.length;i++){const activity=parameters.cart.activities[i];for(let j=0;j<activity.questions.length;j++){numAnswer++;let carte=document.getElementById("domino"+(numAnswer>nbOfCards?1:numAnswer)),artCorrection=utils.create("article",{className:"dominos-reponse"}),divr=utils.create("div"),answer=activity.values[j];if(_.isArray(answer)&&(answer=answer[0]),"latex"===activity.type||""===activity.type||void 0===activity.type){let spanCorrection=utils.create("span",{className:"math",innerHTML:answer});divr.appendChild(spanCorrection)}else divr.innerHTML=answer;artCorrection.appendChild(divr),carte.prepend(artCorrection)}}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression=/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi,regex=new RegExp(expression);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){vars.a?parameters.alea=vars.a:parameters.alea=common.setSeed();let json=vars.c;parameters.tailleTexte=10.5,parameters.nb=Number(vars.n),document.getElementById("nbDominos").value=parameters.nb,parameters.titreFiche=decodeURI(vars.t),parameters.doublons=eval(vars.d)||!1,parameters.doublons||(document.getElementById("btnnodoublon").innerHTML="Doublons"),document.getElementById("nbDominos").value=parameters.nb,zoom=new Zoom("changeFontSize","#thehtml",!0,"pt",parameters.tailleTexte),document.getElementById("creator-menu").appendChild(zoom.createCursor()),document.querySelector("html").style.fontSize=parameters.tailleTexte+"pt",console.log(parameters),parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{refresh()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert)})}}document.getElementById("creator-menu").onclick=evt=>{"in"===evt.target.dataset.what?zoom.plus():"out"===evt.target.dataset.what?zoom.minus():"btneditcontent"===evt.target.id?document.querySelector(".dominos-section").contentEditable=!0:"btnnodoublon"===evt.target.id?noDoublon():"btneditcontent"===evt.target.id?document.querySelectorAll("table").forEach(el=>{el.contentEditable=!0}):"btnshuffle"===evt.target.id?melanger():"deleteImg"===evt.target.id&&replaceFond()},document.getElementById("inputwidth").oninput=evt=>{changewidth(evt.target.value)},document.getElementById("inputheight").oninput=evt=>{changeheight(evt.target.value)},document.getElementById("file").onchange=evt=>{changeFond(evt)},document.getElementById("nbDominos").oninput=evt=>{1===parameters.cart.activities.length?(parameters.nb=Number(evt.target.value),setNumberOfDominos(),refresh()):alert("Plusieurs activités,\nopération impossible.")},checkURL();
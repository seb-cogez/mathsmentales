import protos from"./mods/protos.js";import utils from"./mods/utils.js";import common from"./mods/common.js";import cart from"./mods/cart.js";import Zoom from"./mods/zoom.js";import Figure from"./mods/figure.js";const MM={},content=document.getElementById("creator-content"),parameters={};let separationFiches=!1,zoom;function setNumberFiches(nb){parameters.nb=Number(nb),refresh()}function changecols(dest,nb){document.querySelectorAll("."+dest).forEach(el=>{el.className=dest+" grid g"+nb}),document.querySelectorAll("[data-dest="+dest+"]").forEach(el=>{el.value=nb})}function pagebreak(){let cor=document.querySelectorAll(".correction"),btn=document.getElementById("btn-break");if(cor[0].classList.contains("pagebreak")){for(let i=0;i<cor.length;i++)cor[i].classList.remove("pagebreak");btn.innerText="à part"}else{for(let i=0;i<cor.length;i++)cor[i].classList.add("pagebreak");btn.innerText="même feuille"}}function makePage(){parameters.alea&&common.setSeed(parameters.alea),content.innerHTML="","end"!==parameters.positionCorrection||document.getElementById("btn-break")||document.getElementById("btpCorrigePlace").appendChild(utils.create("button",{id:"btn-break",innerText:"à part"})),MM.memory={};for(let qty=0;qty<parameters.nb;qty++){common.generateQuestions(parameters),qty>0&&content.appendChild(utils.create("footer"));let aleaCode=utils.create("div",{className:"floatright",innerHTML:"Clé : "+common.seed+" p."+(qty+1)});content.appendChild(aleaCode);let sheetTitle=parameters.titreFiche||"Fiche d'exercices",header=utils.create("header",{innerHTML:sheetTitle});content.appendChild(header);let exTitle=parameters.titreExerices||"Exercice n°",correctionContent=utils.create("div",{className:"correction noprint",id:"divcorrection"});if("end"===parameters.positionCorrection){let titleCorrection=utils.create("header",{className:"clearfix",innerHTML:"Correction des exercices"});correctionContent.appendChild(titleCorrection)}let divclear=utils.create("div",{className:"clearfix"});for(let i=0;i<parameters.cart.activities.length;i++){const activity=parameters.cart.activities[i];let sectionEnonce=utils.create("section",{id:"enonce"+qty+"-"+i,className:"enonce"}),input=`<input id="nbcols${qty}-${i}" data-dest="exo${i}" class="noprint fright" value="2" title="Nb de colonnes" type="number" size="2" min="1" max="6">`;sectionEnonce.innerHTML+=input;let h3=utils.create("h3",{className:"exercice-title pointer",innerHTML:exTitle+(i+1)+" : "+activity.title,id:"titreExo"+qty+"-"+i});sectionEnonce.appendChild(h3);let ol=utils.create("ol",{id:"ol"+qty+"-"+i,className:"grid g2 exo"+i}),olCorrection=utils.create("ol",{className:"hidden corrige",id:"corrige"+qty+"-"+i});for(let j=0;j<activity.questions.length;j++){let li=utils.create("li",{className:"c3"}),liCorrection=utils.create("li"),answer=Array.isArray(activity.answers[j])?activity.answers[j][0]:activity.answers[j];if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=utils.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=utils.create("span",{className:"math",innerHTML:answer});li.appendChild(span),liCorrection.appendChild(spanCorrection)}else li.innerHTML=activity.questions[j],liCorrection.innerHTML=answer;ol.appendChild(li),void 0!==activity.figures[j]&&(MM.memory[qty+"-f"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),qty+"-f"+i+"-"+j,li)),olCorrection.appendChild(liCorrection)}sectionEnonce.appendChild(ol);let ds=divclear.cloneNode(!0);if(sectionEnonce.appendChild(ds),"each"===parameters.positionCorrection){let hr=utils.create("div",{className:"titreCorrection pointer noprint",innerHTML:"Correction",id:"idCorrige"+qty+"-"+i});sectionEnonce.appendChild(hr),sectionEnonce.appendChild(olCorrection)}else if("end"===parameters.positionCorrection){let h3correction=h3.cloneNode(!0);h3correction.classList.add("titreCorrection","noprint"),correctionContent.appendChild(h3correction),correctionContent.appendChild(olCorrection),correctionContent.appendChild(utils.create("div",{className:"clearfix"}))}content.appendChild(sectionEnonce)}if(correctionContent.hasChildNodes){content.appendChild(correctionContent);let ds=divclear.cloneNode(!0);content.appendChild(ds)}}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display()}),300)}function refresh(){makePage(),common.mathRender(),content.oninput=evt=>{"input"===evt.target.nodeName.toLowerCase()&&changecols(evt.target.dataset.dest,evt.target.value)}}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression,regex=new RegExp(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){vars.a?parameters.alea=vars.a:parameters.alea=common.setSeed();let json=vars.c;parameters.tailleTexte=Number(vars.s),parameters.nb=Number(vars.n),parameters.positionCorrection=vars.cor,parameters.titreFiche=decodeURI(vars.t),parameters.titreExerices=decodeURI(vars.ex).trim()+" ",parameters.enoncesSepares=vars.es||0,parameters.corrigeSepare=vars.cs||0,parameters.activitesColonnes=vars.cols||[],Array.isArray(parameters.activitesColonnes)||parameters.activitesColonnes.split("~"),parameters.corrigesVisibles=vars.cv||[],Array.isArray(parameters.corrigesVisibles)||parameters.corrigesVisibles.split("~"),document.getElementById("nbFiches").value=parameters.nb,zoom=new Zoom("changeFontSize","#thehtml",!0,"pt",parameters.tailleTexte),document.getElementById("creator-menu").appendChild(zoom.createCursor()),document.querySelector("html").style.fontSize=parameters.tailleTexte+"pt",parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{refresh()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert)})}}document.getElementById("creator-menu").onclick=evt=>{if("in"===evt.target.dataset.what)zoom.plus();else if("out"===evt.target.dataset.what)zoom.minus();else if("btn-break"===evt.target.id)pagebreak();else if("fichesSeparation"===evt.target.id)separationFiches?(separationFiches=!1,document.getElementById(evt.target.id).innerText="Séparer",document.querySelectorAll("footer").forEach(elt=>{elt.className=""})):(separationFiches=!0,document.getElementById(evt.target.id).innerText="Regrouper",document.querySelectorAll("footer").forEach(elt=>{elt.className="break"}));else if("toggleCorriges"===evt.target.id){let lesCorriges=document.querySelectorAll("ol.corrige");" ▼ "===evt.target.innerHTML?(evt.target.innerHTML=" ▲ ",lesCorriges.forEach(el=>{el.classList.remove("hidden")}),document.getElementById("divcorrection").classList.remove("noprint"),document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.remove("noprint")})):(evt.target.innerHTML=" ▼ ",document.getElementById("divcorrection").classList.add("noprint"),document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.add("noprint")}),lesCorriges.forEach(el=>{el.classList.add("hidden")}))}},document.getElementById("creator-menu").oninput=evt=>{"nbFiches"===evt.target.id&&setNumberFiches(evt.target.value)},document.getElementById("creator-content").onclick=evt=>{if(0===evt.target.id.indexOf("idCorrige")){let target;document.getElementById(evt.target.id.replace("idCorrige","corrige")).classList.toggle("hidden")?document.getElementById(evt.target.id).classList.add("noprint"):document.getElementById(evt.target.id).classList.remove("noprint")}else if(0===evt.target.id.indexOf("titreExo")){let target;if(document.getElementById(evt.target.id.replace("titreExo","corrige")).classList.toggle("hidden")){document.querySelector("#divcorrection #"+evt.target.id).classList.add("noprint");let invisible=!0;document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.contains("noprint")||(invisible=!1)}),invisible&&document.getElementById("divcorrection").classList.add("noprint")}else document.querySelector("#divcorrection #"+evt.target.id).classList.remove("noprint"),document.getElementById("divcorrection").classList.remove("noprint")}},checkURL();
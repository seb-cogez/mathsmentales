import protos from"./mods/protos.js";import utils from"./mods/utils.js";import common from"./mods/common.js";import cart from"./mods/cart.js";import Zoom from"./mods/zoom.js";import Figure from"./mods/figure.js";import math from"./mods/math.js";const MM={},content=document.getElementById("creator-content"),parameters={};let separationFiches=!1,zoom;function setNumberFiches(nb){parameters.nb=Number(nb),refresh()}function changecols(dest,nb){document.querySelectorAll("."+dest).forEach(el=>{el.className=dest+" grid g"+nb}),document.querySelectorAll("[data-dest="+dest+"]").forEach(el=>{el.value=nb})}function pagebreak(){let cor=document.querySelectorAll(".correction"),btn=document.getElementById("btn-break");if(cor[0].classList.contains("pagebreak")){for(let i=0;i<cor.length;i++)cor[i].classList.remove("pagebreak");btn.innerText="à part"}else{for(let i=0;i<cor.length;i++)cor[i].classList.add("pagebreak");btn.innerText="même feuille"}}function makePage(){parameters.alea&&common.setSeed(parameters.alea),content.innerHTML="";let aleaCode=utils.create("div",{className:"floatright",innerHTML:"Clé : "+common.seed});content.appendChild(aleaCode),"end"!==parameters.positionCorrection||document.getElementById("btn-break")||document.getElementById("btpCorrigePlace").appendChild(utils.create("button",{id:"btn-break",innerText:"à part"})),MM.memory={};let allCorrectionsContent=utils.create("div");for(let qty=0;qty<parameters.nb;qty++){common.generateQuestions(parameters),qty>0&&content.appendChild(utils.create("footer",{className:"break"}));let sheetTitle=(parameters.titreFiche||"Course aux nombres")+" "+(qty+1),header=utils.create("header",{innerHTML:sheetTitle});content.appendChild(header);let intro=utils.create("section",{className:"entete"});intro.appendChild(utils.create("div",{className:"classe fright",innerHTML:"Classe : ________"})),intro.appendChild(utils.create("div",{className:"nom",innerHTML:"NOM : ______________________"})),intro.appendChild(utils.create("div",{className:"prenom",innerHTML:"Prénom : ___________________"})),intro.appendChild(utils.create("div",{className:"duree",innerHTML:"Durée : <b>"+parameters.time+" min</b>"})),intro.appendChild(utils.create("div",{className:"info",innerHTML:"<i>L'usage de la calculatrice ou de brouillon est interdit.<br>Seule la réponse doit être écrite.</i>"}));let colTitle1=parameters.titreColonne1||"Énoncé",colTitle2=parameters.titreColonne2||"Réponse",colTitle3=parameters.titreColonne3||"Jury",tableenonce=utils.create("table",{id:"tableE"+qty,className:"tablee"}),tablecorrection=utils.create("table",{id:"tableC"+qty}),theade=utils.create("thead"),theadc=utils.create("thead"),tre=utils.create("tr"),trc=utils.create("tr");tre.appendChild(utils.create("th",{innerHTML:"n°"})),tre.appendChild(utils.create("th",{innerHTML:colTitle1})),tre.appendChild(utils.create("th",{innerHTML:colTitle2})),tre.appendChild(utils.create("th",{innerHTML:colTitle3})),trc.appendChild(utils.create("th",{innerHTML:"n°"})),trc.appendChild(utils.create("th",{innerHTML:colTitle1})),trc.appendChild(utils.create("th",{innerHTML:colTitle2})),theade.appendChild(tre),theadc.appendChild(trc),tableenonce.appendChild(theade),tablecorrection.appendChild(theadc);let tbodye=utils.create("tbody"),tbodyc=utils.create("tbody"),compteur=1;for(let i=0;i<parameters.cart.activities.length;i++){const activity=parameters.cart.activities[i];for(let j=0;j<activity.questions.length;j++){let tre=utils.create("tr"),trc=utils.create("tr");tre.appendChild(utils.create("td",{width:"10",innerHTML:compteur+".",className:"right"})),trc.appendChild(utils.create("td",{width:"10",innerHTML:compteur+".",className:"right"})),compteur++;let divenonce=utils.create("td",{width:"50%"}),divanswer=utils.create("td",{width:"50%"}),divenoncec=utils.create("td",{width:"50%"}),divanswerc=utils.create("td",{width:"50%"}),answer=Array.isArray(activity.answers[j])?activity.answers[j][0]:activity.answers[j];if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=utils.create("span",{className:"math",innerHTML:activity.questions[j]}),spanc=utils.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=utils.create("span",{className:"math",innerHTML:answer});divenonce.appendChild(span),divenoncec.appendChild(spanc),divanswerc.appendChild(spanCorrection)}else divenonce.appendChild(utils.create("span",{innerHTML:activity.questions[j]})),divenoncec.appendChild(utils.create("span",{innerHTML:activity.questions[j]})),divanswerc.appendChild(utils.create("span",{innerHTML:answer}));tre.appendChild(divenonce),tre.appendChild(divanswer),tre.appendChild(utils.create("td"),{width:"10"}),void 0!==activity.figures[j]&&(MM.memory[qty+"-f"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),qty+"-f"+i+"-"+j,divenonce)),trc.appendChild(divenoncec),trc.appendChild(divanswerc),tbodye.appendChild(tre),tbodyc.appendChild(trc)}}intro.appendChild(utils.create("div",{className:"info",innerHTML:"L'épreuve comporte <b>"+(compteur-1)+" questions</b>"})),content.appendChild(intro),tableenonce.appendChild(tbodye),content.appendChild(tableenonce),tablecorrection.appendChild(tbodyc);let correctionContent=utils.create("div",{className:"correction noprint",id:"divcorrection"}),titleCorrection=utils.create("header",{className:"clearfix",innerHTML:"Correction de la course n°"+(qty+1)});correctionContent.appendChild(titleCorrection),correctionContent.appendChild(tablecorrection),"each"===parameters.positionCorrection?(content.appendChild(utils.create("footer",{className:"break"})),content.appendChild(correctionContent)):"end"===parameters.positionCorrection&&(allCorrectionsContent.appendChild(utils.create("footer",{className:"break"})),allCorrectionsContent.appendChild(correctionContent))}allCorrectionsContent.hasChildNodes&&content.appendChild(allCorrectionsContent),parameters.cart.ordered||shuffleAll(),utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display()}),300)}function refresh(){makePage(),common.mathRender(),content.oninput=evt=>{"input"===evt.target.nodeName.toLowerCase()&&changecols(evt.target.dataset.dest,evt.target.value)}}function shuffleAll(){document.querySelectorAll(".tablee").forEach((el,key)=>{shuffleTable(document.getElementById("tableE"+key),document.getElementById("tableC"+key))})}function shuffleTable(tablee,tablec){if(!tablee||!tablec)return!1;let tbodye=tablee.tBodies[0],rowse=tbodye.rows,tbodyc=tablec.tBodies[0],rowsc=tbodyc.rows;for(let i=rowse.length;i;i--){let index=math.aleaInt(0,i);tbodye.appendChild(rowse[index]),tbodyc.appendChild(rowsc[index])}}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression,regex=new RegExp(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){vars.a?parameters.alea=vars.a:parameters.alea=common.setSeed();let json=vars.c;parameters.tailleTexte=10.5,parameters.nb=Number(vars.n),parameters.positionCorrection=vars.cor||"end",parameters.titreFiche=decodeURI(vars.t),parameters.titreColonne1=decodeURI(vars.t1).trim(),parameters.titreColonne2=decodeURI(vars.t2).trim(),parameters.titreColonne3=decodeURI(vars.t3).trim(),parameters.time=vars.tm||"7",document.getElementById("nbFiches").value=parameters.nb,zoom=new Zoom("changeFontSize","#thehtml",!0,"pt",parameters.tailleTexte),document.getElementById("creator-menu").appendChild(zoom.createCursor()),document.querySelector("html").style.fontSize=parameters.tailleTexte+"pt",parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{refresh()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert)})}}document.getElementById("creator-menu").onclick=evt=>{if("in"===evt.target.dataset.what)zoom.plus();else if("out"===evt.target.dataset.what)zoom.minus();else if("btn-break"===evt.target.id)pagebreak();else if("fichesSeparation"===evt.target.id)separationFiches?(separationFiches=!1,document.getElementById(evt.target.id).innerText="Séparer",document.querySelectorAll("footer").forEach(elt=>{elt.className=""})):(separationFiches=!0,document.getElementById(evt.target.id).innerText="Regrouper",document.querySelectorAll("footer").forEach(elt=>{elt.className="break"}));else if("toggleCorriges"===evt.target.id){let lesCorriges=document.querySelectorAll("ol.corrige");" ▼ "===evt.target.innerHTML?(evt.target.innerHTML=" ▲ ",lesCorriges.forEach(el=>{el.classList.remove("hidden")}),document.getElementById("divcorrection").classList.remove("noprint"),document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.remove("noprint")})):(evt.target.innerHTML=" ▼ ",document.getElementById("divcorrection").classList.add("noprint"),document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.add("noprint")}),lesCorriges.forEach(el=>{el.classList.add("hidden")}))}else if("btnedit"===evt.target.id)document.querySelector(".entete").contentEditable=!0;else if("btncopy"===evt.target.id){document.querySelector(".entete").contentEditable=!1;let content=document.querySelector(".entete").innerHTML;document.querySelectorAll(".entete").forEach(el=>{el.innerHTML=content})}else"btnshuffle"===evt.target.id&&shuffleAll()},document.getElementById("creator-menu").oninput=evt=>{"nbFiches"===evt.target.id&&setNumberFiches(evt.target.value)},document.getElementById("creator-content").onclick=evt=>{if(0===evt.target.id.indexOf("idCorrige")){let target;document.getElementById(evt.target.id.replace("idCorrige","corrige")).classList.toggle("hidden")?document.getElementById(evt.target.id).classList.add("noprint"):document.getElementById(evt.target.id).classList.remove("noprint")}else if(0===evt.target.id.indexOf("titreExo")){let target;if(document.getElementById(evt.target.id.replace("titreExo","corrige")).classList.toggle("hidden")){document.querySelector("#divcorrection #"+evt.target.id).classList.add("noprint");let invisible=!0;document.querySelectorAll("#divcorrection .titreCorrection").forEach(el=>{el.classList.contains("noprint")||(invisible=!1)}),invisible&&document.getElementById("divcorrection").classList.add("noprint")}else document.querySelector("#divcorrection #"+evt.target.id).classList.remove("noprint"),document.getElementById("divcorrection").classList.remove("noprint")}},checkURL();
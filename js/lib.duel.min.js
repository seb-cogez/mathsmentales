import protos from"./mods/protos.js";import utils from"./mods/utils.js";import common from"./mods/common.js";import cart from"./mods/cart.js";import Zoom from"./mods/zoom.js";import Figure from"./mods/figure.js";import keyBoard from"./mods/keyboard.js";import MM from"./mods/MM.js";import math from"./mods/math.js";MM.touched=!1,MM.slidersNumber=2;let calculsEnCours=!1,questionCount=0;const PERSOS=["dino1","dino2","dino3","dino4","dino5","dino6","dino7","dino8","dragon1","dragon2","dragon3","dragon4","dragon5","dragon6","dragon7","fee1","fee2","fou1","genie1","girl1","goblin1","princess1","princess2","roi1","roi2","sorcier1","pirate1","pirate2","pirate3","pirate4","pirate5","pirate6"];MM.touched="ontouchstart"in window||navigator.msMaxTouchPoints;const content=document.getElementById("creator-content"),parameters={};let zoom,typesDuel={tochoose:"",thefaster:"Lucky Luke",mortal:"mortel",normal:"Que le meilleur gagne !",roulette:"Alternatif",coop:"Coopératif"};function setChoice(type){parameters.typeduel=type,document.querySelectorAll("#typeduelchoice button").forEach(el=>{el.className=""}),document.getElementById("btn-choice-"+type).className="selected"}function setPersos(){let choix1=Math.floor(Math.random()*PERSOS.length),choix2;do{choix2=Math.floor(Math.random()*PERSOS.length)}while(choix2===choix1);PLAYER1.perso=PERSOS[choix1],PLAYER2.perso=PERSOS[choix2],displayPersos()}function setPerso(id){let choix,thisPlayer,theOther;"l"===id?(thisPlayer=PLAYER1,theOther=PLAYER2):(thisPlayer=PLAYER2,theOther=PLAYER1);do{choix=Math.floor(Math.random()*PERSOS.length)}while(PERSOS[choix]===PLAYER1.perso||PERSOS[choix]===PLAYER2.perso);thisPlayer.perso=PERSOS[choix],displayPersos()}function displayPersos(){document.getElementById("introPersol").src="library/illustrations/Persos/"+PLAYER1.perso+".png",document.getElementById("introPersor").src="library/illustrations/Persos/"+PLAYER2.perso+".png",document.getElementById("left").style.backgroundImage="url(library/illustrations/Persos/"+PLAYER1.perso+".png)",document.getElementById("right").style.backgroundImage="url(library/illustrations/Persos/"+PLAYER2.perso+".png)"}function setOrientation(type){"facetoface"===type?(document.getElementById("creator-content").classList.remove("sidebyside"),document.getElementById("creator-content").classList.add("facetoface")):"sidebyside"===type&&(document.getElementById("creator-content").classList.remove("facetoface"),document.getElementById("creator-content").classList.add("sidebyside")),document.querySelectorAll("#field-options button").forEach(el=>{el.className=""}),document.getElementById("btn-orientation-"+type).className="selected"}document.getElementById("intro").onclick=evt=>{let explain=document.getElementById("explanations");"btn-choice-normal"===evt.target.id?(setChoice("normal"),explain.innerHTML="Chacun répond à son rythme, le score final décide du vainqueur"):"btn-choice-mortal"===evt.target.id?(setChoice("mortal"),explain.innerHTML="Le premier qui fait une erreur perd. Attention au temps !"):"btn-choice-roulette"===evt.target.id?(setChoice("roulette"),explain.innerHTML="Chacun répond à son tour, premier qui rate perd."):"btn-choice-thefaster"===evt.target.id?(setChoice("thefaster"),explain.innerHTML="Le premier qui répond marque des points, pas l'autre !"):"btn-choice-coop"===evt.target.id?(setChoice("coop"),explain.innerHTML="Les points s'accumulent par la meilleure des deux réponses."):"introPersol"===evt.target.id?setPerso("l"):"introPersor"===evt.target.id?setPerso("r"):["svg-sbs","btn-orientation-sidebyside"].indexOf(evt.target.id)>-1?setOrientation("sidebyside"):["svg-ftf","btn-orientation-facetoface"].indexOf(evt.target.id)>-1?setOrientation("facetoface"):"full-screen"===evt.target.id?document.documentElement.requestFullscreen?document.documentElement.requestFullscreen().then(()=>{console.log("Fullscreen")}).catch(err=>{console.log("Erreur de fullscreen "+err)}):document.documentElement.webkitRequestFullScreen&&document.documentElement.webkitRequestFullScreen():"btn-start"===evt.target.id?(document.getElementById("intro").classList.add("hidden"),document.getElementById("countdown-container").classList.remove("hidden"),setTimeout(()=>{document.getElementById("countdown-container").classList.add("hidden"),document.getElementById("creator-container").classList.remove("hidden"),start()},3600)):"btn-infoconfig"===evt.target.id&&document.getElementById("infodebug").classList.remove("hidden")},document.body.addEventListener("touchmove",evt=>{evt.preventDefault()},!1),document.getElementById("infodebug").onclick=()=>{document.getElementById("infodebug").classList.add("hidden")},document.getElementById("btn-restart").onclick=()=>{resetAll()};class player{constructor(id){this.id=id,this.name="l"===id?"left":"right",this.nom="l"===id?"JOUEUR 1":"JOUEUR 2",this.perso="",this.score=0,this.scores=[],this.numQuestion=0,this.time=0,this.timer=!1,this.success=[],this.answers=[],this.perso="",this.ended=!1,this.timerStarted=!1,this.lastQuestion=-1}reset(){this.score=0,this.scores=[],this.numQuestion=0,this.time=0,this.timer=!1,this.success=[],this.answers=[],this.ended=!1,this.timerStarted=!1,this.lastQuestion=-1}start(){this.showQuestion(),this.updateProgressBar(),parameters.totaltime?this.timerStarted?this.timer.setDataActivity(MM.activities[this.numQuestion].time):(this.timerStarted=!0,this.timer=new timer(this.id,parameters.totaltime),this.timer.setDataActivity(MM.activities[this.numQuestion].time),this.timer.start()):(this.timer=new timer(this.id,MM.activities[this.numQuestion].time),this.timer.start())}nextQ(){return this.timer&&!parameters.totaltime&&(this.timer.stop(),this.timer=!1),this.hideQuestion(),this.ended?(document.querySelector("#chrono"+this.id).innerHTML="-:--",void WhoWon()):this.lastQuestion===this.numQuestion?(document.querySelector("#chrono"+this.id).innerHTML="-:--",this.ended=!0,void WhoWon()):void(MM.activities.length>this.numQuestion+1?(this.numQuestion++,this.start()):MM.activities.length>=this.numQuestion+1&&!1!==parameters.totaltime?(addContent(),this.numQuestion++,this.start()):(this.ended=!0,document.querySelector("#chrono"+this.id).innerHTML="-:--",document.querySelector("#jauge"+this.id).classList.add("hidden"),document.getElementById("enonces"+this.id).appendChild(utils.create("button",{innerHTML:"Terminé !",className:"selected"})),WhoWon()))}succeeded(){return!!this.success[this.success.length-1]}showQuestion(){document.getElementById("q"+this.id+this.numQuestion).classList.remove("hidden")}updateProgressBar(){if(!parameters.totaltime){let len=MM.activities.length,numQ=this.numQuestion;"roulette"===parameters.typeduel&&(len=Math.floor(MM.activities.length/2),numQ=Math.floor(this.numQuestion/2)),document.querySelector("#jauge"+this.id).classList.remove("hidden"),document.querySelector("#jauge"+this.id+" .avance").innerHTML=len-numQ+"/"+len,document.documentElement.clientHeight<document.documentElement.clientWidth?(document.querySelector("#jauge"+this.id+" .fondjauge").style.height="100%",document.querySelector("#jauge"+this.id+" .fondjauge").style.width=Math.round((len-numQ)/len*100)+"%"):(document.querySelector("#jauge"+this.id+" .fondjauge").style.width="100%",document.querySelector("#jauge"+this.id+" .fondjauge").style.height=Math.round((len-numQ)/len*100)+"%")}}hideQuestion(){document.getElementById("q"+this.id+this.numQuestion).classList.add("hidden")}goToQ(idQ){this.hideQuestion(),MM.activities.length>idQ?(this.numQuestion=idQ,this.start()):(this.ended=!0,"l"===this.id?PLAYER2.ended=!0:PLAYER1.ended=!0,document.querySelector("#chrono"+this.id).innerHTML="-:--",WhoWon())}}const PLAYER1=new player("l"),PLAYER2=new player("r");function start(){if("roulette"===parameters.typeduel)Math.random()>.5?PLAYER1.start():PLAYER2.start();else try{["normal","mortal","thefaster","coop"].indexOf(parameters.typeduel)>-1&&(PLAYER1.start(),PLAYER2.start())}catch(err){console.log("Erreur display q0 : "+err)}}function nextSlide(idSlide){let thisPlayer,theOther;calculsEnCours&&setTimeout(()=>{calculsEnCours()},50),calculsEnCours=!0,"l"===idSlide?(thisPlayer=PLAYER1,theOther=PLAYER2):"r"===idSlide&&(thisPlayer=PLAYER2,theOther=PLAYER1),verifReponse(thisPlayer),displayScore(thisPlayer),["normal","thefaster","coop"].indexOf(parameters.typeduel)>-1&&thisPlayer.nextQ(),"thefaster"===parameters.typeduel?theOther.nextQ():"mortal"===parameters.typeduel?thisPlayer.succeeded()&&!thisPlayer.ended?thisPlayer.nextQ():(thisPlayer.hideQuestion(),thisPlayer.ended=!0,theOther.lastQuestion=thisPlayer.numQuestion,WhoWon()):"roulette"===parameters.typeduel&&(thisPlayer.hideQuestion(),thisPlayer.succeeded()&&!thisPlayer.ended?theOther.goToQ(thisPlayer.numQuestion+1):(thisPlayer.ended=!0,theOther.ended=!0,WhoWon())),calculsEnCours=!1}function displayScore(player){const NQ=player.numQuestion;player.success[player.success.length-1]?(player.scores[NQ]=10*player.timer.percent||50,player.score+=10*player.timer.percent||50):(player.scores[NQ]=0,document.getElementById("score"+player.id).classList.add("shake"),document.getElementById(player.name).classList.add("shake2"),setTimeout(()=>{document.getElementById("score"+player.id).classList.remove("shake"),document.getElementById(player.name).classList.remove("shake2")},1e3)),document.getElementById("score"+player.id).innerHTML=player.score.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function WhoWon(){PLAYER1.ended&&PLAYER2.ended?setTimeout(()=>{document.getElementById("creator-container").classList.add("hidden");let thewinner,egaliteTxt,score=0,thelooz,finmessage=" points est";if("normal"===parameters.typeduel||"thefaster"===parameters.typeduel)PLAYER1.score>PLAYER2.score?(thewinner=PLAYER1,thelooz=PLAYER2):PLAYER2.score>PLAYER1.score?(thewinner=PLAYER2,thelooz=PLAYER1):(egaliteTxt="Égalité !!! Avec",score=PLAYER1.score,thewinner="both",finmessage="points");else if("mortal"===parameters.typeduel||"roulette"===parameters.typeduel)console.log(utils.clone(PLAYER1),utils.clone(PLAYER2)),PLAYER1.success.lastIndexOf(!0)>PLAYER2.success.lastIndexOf(!0)?(thewinner=PLAYER1,thelooz=PLAYER2):PLAYER1.success.lastIndexOf(!0)<PLAYER2.success.lastIndexOf(!0)?(thewinner=PLAYER2,thelooz=PLAYER1):(egaliteTxt="Égalité !!! Avec",score=PLAYER1.success.lastIndexOf(!0)+1,thewinner="both",finmessage=" réussites !");else if("coop"===parameters.typeduel){egaliteTxt="Vous avez cumulé ";for(let i=0,len=PLAYER1.scores.length;i<len;i++)score+=Math.max(PLAYER1.scores[i],PLAYER2.scores[i]);thewinner="both",finmessage="points"}let thewinnerDOM=document.getElementById("thewinnercontent");if(thewinnerDOM.innerHTML="","both"!=thewinner&&"coop"!==parameters.typeduel){let div=utils.create("div");thewinnerDOM.appendChild(utils.create("h1",{innerHTML:"Le gagnant, avec <span class='scorewinner'>"+thewinner.score+"</span> "+finmessage}));let div1=utils.create("div");div1.appendChild(utils.create("img",{src:"library/illustrations/Persos/"+thewinner.perso+".png"})),div1.appendChild(utils.create("div",{innerHTML:thewinner.nom})),div1.appendChild(utils.create("h2",{innerText:thewinner.score+" ("+utils.countValue(thewinner.success,!0)+" OK)"}));let div2=utils.create("div");div2.appendChild(utils.create("img",{src:"library/illustrations/Persos/"+thelooz.perso+".png"})),div2.appendChild(utils.create("div",{innerHTML:thelooz.nom})),div2.appendChild(utils.create("h4",{innerText:thelooz.score+" ("+utils.countValue(thelooz.success,!0)+" OK)"})),div.appendChild(div1),div.appendChild(div2),thewinnerDOM.appendChild(div)}else{thewinnerDOM.appendChild(utils.create("h1",{innerHTML:egaliteTxt+" <span class='scorewinner'>"+score+"</span> "+finmessage}));let div=utils.create("div");div.appendChild(utils.create("img",{src:"library/illustrations/Persos/"+PLAYER1.perso+".png"})),div.appendChild(utils.create("img",{src:"library/illustrations/Persos/"+PLAYER2.perso+".png"})),thewinnerDOM.appendChild(div)}document.getElementById("thewinner").classList.remove("hidden")},2e3):console.log("non terminé")}function verifReponse(player){parameters.totaltime||(player.timer.stop(),player.time+=player.timer.time);const NQ=player.numQuestion;let idq=player.success.push(!1)-1;player.answers[NQ]=MM.mf["ansInput"+player.id+"-"+NQ].value||null;let userAnswer=player.answers[NQ];if(null===userAnswer)return;if(0===userAnswer.indexOf("\\text")&&(userAnswer=userAnswer.substring(6,userAnswer.length-1)),userAnswer=userAnswer.replace("\\text{ }"," "),userAnswer=userAnswer.replace(">","\\gt"),userAnswer=userAnswer.replace("<","\\lt"),""===userAnswer)return!1;const expectedAnswer=MM.activities[NQ].value,valueType=MM.activities[NQ].valueType;if(Array.isArray(expectedAnswer))for(let i=0;i<expectedAnswer.length;i++){if(String(userAnswer).toLowerCase()==String(expectedAnswer[i]).toLowerCase()){player.success[idq]=!0;break}{const expr1=KAS.parse(expectedAnswer[i]).expr,expr2=KAS.parse(String(userAnswer).replace("²","^2")).expr;if(expr1&&expr2)try{if(KAS.compare(expr1,expr2,{form:!0,simplify:!1}).equal){player.success[idq]=!0;break}}catch(error){console.log(error)}}}else if(!1!==valueType){if("liste"===valueType){let arrayUser=userAnswer.split(";").map(value=>value.trim()).sort((a,b)=>a-b),arrayExpected=expectedAnswer.split(";").map(value=>value.trim()).sort((a,b)=>a-b);arrayUser.toString()===arrayExpected.toString()&&(player.success[idq]=!0)}else if("inInterval"===valueType){let minmax=expectedAnswer.split("-").map(value=>Number(value));Number(userAnswer)>minmax[0]&&Number(userAnswer)<minmax[1]&&(player.success[idq]=!0)}}else{if("string"==typeof expectedAnswer&&expectedAnswer.indexOf(",")>0){let expectedAnswerArray=expectedAnswer.split(",");for(let i=0;i<expectedAnswer.length;i++){if(String(userAnswer).toLowerCase()==String(expectedAnswerArray[i]).toLowerCase()){player.success[idq]=!0;break}{const expr1=KAS.parse(expectedAnswer[i]).expr,expr2=KAS.parse(String(userAnswer).replace("²","^2")).expr;if(expr1&&expr2)try{if(KAS.compare(expr1,expr2,{form:!0,simplify:!1}).equal){player.success[idq]=!0;break}}catch(error){console.log(error)}}}}if(String(userAnswer).toLowerCase()==String(expectedAnswer).toLowerCase())player.success[idq]=!0;else{const expr1=KAS.parse(String(expectedAnswer)).expr,expr2=KAS.parse(String(userAnswer).replace("²","^2")).expr;if(expr1&&expr2)try{KAS.compare(expr1,expr2,{form:!0,simplify:!1}).equal&&(player.success[idq]=!0)}catch(error){console.log(error)}}}}class timer{constructor(id,duration){this.id=id,this.time=0,this.duration=duration,this.startTime=Date.now(),this.intermediateTime=this.startTime,this.timeLeft=1e3*duration,this.endTime=this.startTime+this.timeLeft,this.percent=0,this.timer=!1,this.ended=!1,this.durationAct=0,this.endTimeAct=0}getTimeLeft(){let now=Date.now();if(this.time=now-this.startTime,this.timeLeft=this.endTime-now,parameters.totaltime){let timeLeft=this.endTimeAct-now>0?this.endTimeAct-now:0;this.percent=Math.round(timeLeft/10/this.durationAct)}else this.percent=Math.round(this.timeLeft/10/this.duration);this.display(),this.timeLeft<=0&&(this.stop(),this.timeLeft=0,!1!==parameters.totaltime&&(PLAYER1.ended=!0,PLAYER2.ended=!0),nextSlide(this.id))}start(){if(this.stop(),this.ended)return!1;this.endTime=this.startTime+this.timeLeft,this.timer&&(clearInterval(this.timer),this.timer=!1),this.timer=setInterval(this.getTimeLeft.bind(this),50)}stop(){this.timer&&(clearInterval(this.timer),this.timer=!1)}end(){this.stop(),this.ended=!0,messageEndSlide(this.id,this.durationId)}display(){let affichage=Math.round(this.timeLeft/1e3);affichage=~~(affichage/60)+":"+(affichage<10?"0":"")+affichage%60,document.querySelector("#chrono"+this.id).innerHTML=affichage}setDataActivity(duree){let now=Date.now();this.durationAct=duree,this.endTimeAct=now+1e3*this.durationAct}}function makePage(){document.body.style.backgroundImage="url(./library/illustrations/backgrounds/bg"+parameters.bg+".jpg",setPersos(),parameters.alea&&common.setSeed(parameters.alea),resetAll()}function resetAll(){PLAYER1.reset(),PLAYER2.reset(),document.getElementById("enoncesl").innerHTML="",document.getElementById("enoncesr").innerHTML="",document.getElementById("scorel").innerHTML="",document.getElementById("scorer").innerHTML="",MM.mf={},MM.keyboards={},MM.memory={},MM.activities=[],questionCount=0,document.getElementById("creator-container").classList.add("hidden"),document.getElementById("thewinner").classList.add("hidden"),document.getElementById("intro").classList.remove("hidden"),addContent()}function addContent(){let contentLeft=document.getElementById("enoncesl"),contentRight=document.getElementById("enoncesr");common.generateQuestions(parameters);let actArray=[];for(let z=0,alen=parameters.cart.activities.length;z<alen;z++)for(let j=0,qlen=parameters.cart.activities[z].questions.length;j<qlen;j++)actArray.push([z,j]);parameters.cart.ordered||(actArray=utils.shuffle(actArray));for(let i=0,len=actArray.length;i<len;i++){const activity=parameters.cart.activities[actArray[i][0]];MM.activities.push({time:Number(activity.tempo),value:activity.values[actArray[i][1]],answer:activity.answers[actArray[i][1]],valueType:activity.valueType||!1});let question=activity.questions[actArray[i][1]].replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>'),carte=utils.create("article",{className:"diapo hidden",id:"ql"+questionCount}),carted=utils.create("article",{className:"diapo hidden",id:"qr"+questionCount}),divq=utils.create("div",{className:"enonce"});if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=utils.create("span",{className:"math",innerHTML:question});divq.appendChild(span)}else divq.innerHTML=question;carte.appendChild(divq);let divqd=utils.create("div",{className:"enonce"});if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=utils.create("span",{className:"math",innerHTML:question});divqd.appendChild(span)}else divqd.innerHTML=question;carted.appendChild(divqd),void 0!==activity.figures[actArray[i][1]]&&(MM.memory["fl"+questionCount]=new Figure(utils.clone(activity.figures[actArray[i][1]]),"fl"+questionCount,divq),MM.memory["fr"+questionCount]=new Figure(utils.clone(activity.figures[actArray[i][1]]),"fr"+questionCount,divqd));try{const IDL="ansInputl-"+questionCount;MM.mf[IDL]=new MathfieldElement({smartMode:!0,virtualKeyboardMode:"off",fontsDirectory:"../katex/fonts"});let keys=activity.keys||void 0;MM.keyboards[IDL]=new keyBoard(MM.mf[IDL],keys,carte,"l","kl"+questionCount),MM.mf[IDL].id=IDL,MM.mf[IDL].target=carte,MM.mf[IDL].addEventListener("keyup",(function(event){"Enter"!==event.key&&"NumpadEnter"!==event.code||(nextSlide("l"),event.preventDefault())})),carte.appendChild(MM.mf[IDL]);const IDR="ansInputr-"+questionCount;MM.mf[IDR]=new MathfieldElement({smartMode:!0,virtualKeyboardMode:"off",fontsDirectory:"../katex/fonts"}),MM.keyboards[IDR]=new keyBoard(MM.mf[IDR],keys,carted,"r","kr"+questionCount),MM.mf[IDR].id=IDR,MM.mf[IDR].target=carted,MM.mf[IDR].addEventListener("keyup",(function(event){"Enter"!==event.key&&"NumpadEnter"!==event.code||(nextSlide("r"),event.preventDefault())})),carted.appendChild(MM.mf[IDR])}catch(error){console.log(error)}contentLeft.appendChild(carte),contentRight.appendChild(carted),questionCount++}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),500),common.mathRender("onlyMathSpan")}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression,regex=new RegExp(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){parameters.alea=common.setSeed();let json=vars.c;parameters.tailleTexte=10.5,parameters.nb=Number(vars.n),parameters.typeduel=decodeURI(vars.ty),parameters.totaltime=vars.t||!1,parameters.totaltime&&(document.getElementById("jauger").classList.add("hidden"),document.getElementById("jaugel").classList.add("hidden")),document.getElementById("duel-type").innerHTML=typesDuel[parameters.typeduel],"tochoose"===parameters.typeduel&&(document.getElementById("typeduelchoice").classList.remove("hidden"),parameters.typeduel="normal"),parameters.bg=vars.bg,zoom=new Zoom("changeFontSize","#thehtml",!0,"pt",11),document.getElementById("creator-menu").appendChild(zoom.createCursor()),document.querySelector("html").style.fontSize="11pt",parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{makePage()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("creator-menu").appendChild(alert)})}else console.log("Problème dans l'url")}checkURL();
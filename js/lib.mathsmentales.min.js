"use strict";String.prototype.minusculesSansAccent=function(){for(var accent=[/[\300-\306]/g,/[\340-\346]/g,/[\310-\313]/g,/[\350-\353]/g,/[\314-\317]/g,/[\354-\357]/g,/[\322-\330]/g,/[\362-\370]/g,/[\331-\334]/g,/[\371-\374]/g,/[\321]/g,/[\361]/g,/[\307]/g,/[\347]/g],noaccent=["A","a","E","e","I","i","O","o","U","u","N","n","C","c"],str=this,i=0;i<accent.length;i++)str=str.replace(accent[i],noaccent[i]);return str.toLowerCase()},Array.prototype.removeValue=function(value){let index=this.indexOf(value);return index>-1&&(this.splice(index,1),!0)},Array.prototype.getKeys=function(){let table=[];for(let i=0,j=this.length;i<j;i++)table.push(i);return table},String.prototype.shuffle=function(){return this.split("").sort((function(a,b){return Math.random()<.5?1:-1})).join("")};var debug=function(){modeDebug&&console.log(arguments)},moisFR=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],joursFR=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],modeDebug=!0,utils={baseURL:/^.*\//.exec(window.location.href),seed:"sample",security:300,create:function(type,props){const elt=document.createElement(type);for(const p in props)elt[p]=props[p];return elt},copy(DOMel){DOMel.select(),DOMel.setSelectionRange(0,99999),document.execCommand("copy"),DOMel.className="copied",setTimeout(()=>{DOMel.className=""},3e3)},pageWidth:()=>null!=window.innerWidth?window.innerWidth:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientWidth:null!=document.body?document.body.clientWidth:null,goToOldVersion(){window.location.href=utils.baseURL+"old/"+/(^.*\/)(.*)/.exec(window.location.href)[2]},setHistory(pageName,params){let url=MM.setURL(params);history.pushState({id:"Homepage"},pageName,url)},checkRadio(name,value){let domElt=document.querySelector("input[type=radio][name='"+name+"'][value='"+value+"']");if(!domElt)return!1;domElt.click()},checkURL(urlString=!1,start=!0,edit=!1){const vars=utils.getUrlVars(urlString);if(void 0===vars.n||void 0!==vars.cd){if(void 0!==vars.u&&void 0===vars.cd){let regexp=/(\d+|T|G)/;if(_.isArray(vars.u)){let listeURLs=[];for(let i=0;i<vars.u.length;i++){let url=vars.u[i],level=regexp.exec(url)[0];listeURLs.push({u:"N"+level+"/"+url+".json",t:""})}library.displayContent(listeURLs)}else if(void 0!==vars.u){let level=regexp.exec(vars.u)[0];library.load("N"+level+"/"+vars.u+".json")}else{let alert=utils.create("div",{className:"message",innerHTML:"Cette activité n'a pas de correspondance dans cette nouvelle version de MathsMentales.<hr class='center w50'>Vous allez être redirigé vers l'ancienne version dans 10s. <a href='javascript:utils.goToOldVersion();'>Go !</a>"});document.getElementById("tab-accueil").appendChild(alert),setTimeout(utils.goToOldVersion,1e4)}}else if(void 0!==vars.c){let alert=utils.create("div",{id:"messageinfo",className:"message",innerHTML:"Chargement de l'activité MathsMentales.<br>Merci pour la visite."});if(document.getElementById("tab-accueil").appendChild(alert),"yes"!==vars.o||edit?setTimeout(()=>{utils.closeMessage("messageinfo")},3e3):(start=!1,alert.innerHTML+="<br><br>\n                <button onclick=\"utils.closeMessage('messageinfo');MM.checkLoadedCarts(true)\"> Commencer !\n                </button>"),MM.introType=vars.i,MM.endType=vars.e,"string"==typeof vars.colors){let couleurs=vars.colors.split("~");for(let i=0;i<couleurs.length;i++)MM.colors[i]=couleurs[i].replace(/_/g,",")}vars.o&&(MM.onlineState=vars.o),vars.f&&(MM.faceToFace=vars.f),vars.s&&(MM.slidersNumber=Number(vars.s)),void 0!==vars.snd&&"null"!==vars.snd&&sound.setSound(Number(vars.snd)),vars.a&&"no"===MM.onlineState||edit?utils.setSeed(vars.a):"yes"!=MM.onlineState&&vars.a||utils.setSeed(utils.seedGenerator()),MM.resetCarts(),vars.so&&(MM.slidersOrientation=vars.so);let json=vars.c;"string"==typeof vars.c&&(json=JSON.parse(decodeURIComponent(vars.c)));let allcarts=[];for(const i in json)MM.carts[i]=new cart(i),allcarts.push(MM.carts[i].import(json[i],start));Promise.all(allcarts).then(data=>{MM.resetInterface(),MM.restoreCartsInterface(),(MM.carts[0].activities.length>1||MM.carts.length>1)&&MM.showCartInterface(),MM.carts[0].activities.length>1||MM.carts.length>1?(MM.showCart(1),MM.editActivity(0)):(MM.editedActivity=MM.carts[0].activities[0],MM.editedActivity.display()),edit&&utils.showTab("tab-parameters")}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger les paniers :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert),setTimeout(()=>{let div=document.getElementById("messageerreur");div.parentNode.removeChild(div)},3e3)})}else if(void 0!==vars.cd||void 0!==vars.panier){let alert=utils.create("div",{className:"message",innerHTML:"Ceci est le nouveau MathsMentales, les anciennes adresses ne sont malheureusement plus compatibles.<hr class='center w50'>Vous allez être redirigé vers l'ancienne version de MathsMentales dans 6 s. <a href='javascript:utils.goToOldVersion();'>Go !</a>"});document.getElementById("tab-accueil").appendChild(alert),setTimeout(utils.goToOldVersion,6e3)}}else library.displayContent(vars.n,!0)},superEncodeURI:function(url){for(var encodedStr="",encodeChars=["(",")","{","}"],i=0,len=(url=encodeURIComponent(url)).length;i<len;i++){var hex;if(encodeChars.indexOf(url[i])>=0)encodedStr+="%"+parseInt(url.charCodeAt(i)).toString(16);else encodedStr+=url[i]}return encodedStr},getUrlVars:function(urlString){urlString||(urlString=window.location.href);var vars={},hash;if(urlString.indexOf("#")>0&&urlString.indexOf("?")<0){let idExo=urlString.substring(urlString.indexOf("#")+1,urlString.length);void 0!==MM1toMM2[idExo].new&&(vars.u=MM1toMM2[idExo].new)}var hashes=urlString.replace(/\|/g,"/").slice(urlString.indexOf("?")+1).split("&"),len=hashes.length;if(urlString.indexOf("~")<0)for(var i=0;i<len;i++)vars[(hash=hashes[i].split("="))[0]]=hash[1];else{hash=hashes[0].split(",");for(let i=0;i<hash.length;i++){let data=hash[i].split("=");vars[data[0]]=!!data[1]&&data[1]}vars.c={};for(let i=1;i<len;i++)if(0===hashes[i].indexOf("p")){let parts=hashes[i].split("_"),data=parts[0].split("~"),datas={};for(let j=0;j<data.length;j++){let dataparts=data[j].split("=");datas[dataparts[0]]=decodeURI(dataparts[1])}let id=datas.p;vars.c[id]={i:datas.p,t:datas.t,c:datas.c,o:datas.o,a:{}};for(let j=1;j<parts.length;j++){let datasActivity=parts[j].split("~");vars.c[id].a[j-1]={};for(let k=0;k<datasActivity.length;k++){let dataparts=datasActivity[k].split("=");"o"===dataparts[0]?vars.c[id].a[j-1][dataparts[0]]=utils.textToTable(dataparts[1]):"q"===dataparts[0]?vars.c[id].a[j-1][dataparts[0]]=utils.textToObj(dataparts[1]):vars.c[id].a[j-1][dataparts[0]]=dataparts[1]}}}}return vars},getDate(){let ladate=new Date,lheure=ladate.getHours(),lesminutes=ladate.getMinutes(),lessecondes=ladate.getSeconds(),ladateComplete;return joursFR[ladate.getDay()]+" "+ladate.getDate()+" "+moisFR[ladate.getMonth()]+" "+ladate.getFullYear()+" - "+(lheure<10?"0"+lheure:lheure)+":"+(lesminutes<10?"0"+lesminutes:lesminutes)+":"+(lessecondes<10?"0"+lessecondes:lessecondes)},seedGenerator:function(){let str="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",code="";for(let i=0;i<6;i++)code+=str[Math.floor(Math.random()*str.length)];return code},setSeed(value){void 0!==value&&"sample"!==value?(MM.seed=value,document.getElementById("aleaKey").value=value):"sample"===value?MM.seed=utils.seedGenerator():""===document.getElementById("aleaKey").value?(MM.seed=utils.seedGenerator(),document.getElementById("aleaKey").value=MM.seed):MM.seed=document.getElementById("aleaKey").value,utils.initializeAlea(MM.seed)},addClass:function(elt,newClass){var n=0;newClass=newClass.split(",");for(let i=0;i<newClass.length;i++)-1==(" "+elt.className+" ").indexOf(" "+newClass[i]+" ")&&(elt.className+=" "+newClass[i],n++);return n},createCeintureTitres(qty){if(qty<1||qty>5)return!1;const dest=document.getElementById("ceintcolumnTitle"),champs=dest.querySelectorAll("input"),labels=dest.querySelectorAll("label"),br=dest.querySelectorAll("br");champs.length<qty?(dest.appendChild(utils.create("br")),dest.appendChild(utils.create("label",{for:"ceinttitlecol"+qty,innerHTML:"Colonne "+qty+" : "})),dest.appendChild(utils.create("input",{type:"text",id:"ceinttitlecol"+qty,placeholder:"Texte, ou rien"}))):champs.length>qty&&(dest.removeChild(labels[champs.length-1]),dest.removeChild(champs[champs.length-1]),dest.removeChild(br[champs.length-1]))},getRadioChecked:function(name){let radio=document.getElementsByName(name);for(let i=0,length=radio.length;i<length;i++)if(radio[i].checked)return radio[i].value;return!1},numberIfNumber:function(value){return String(Number(value))===value?Number(value):value},isEmpty:function(obj){var x;for(x in obj)return!1;return!0},shuffle:function(arr){return!!Array.isArray(arr)&&(arr.sort(()=>utils.alea()-.5),arr)},createTuiles(){let grille;const ordre=library.ordre;function setContent(id,obj){const elt=utils.create("article",{className:"tuile",title:"Cliquer pour afficher toutes les activités du niveau"}),titre=utils.create("h3",{innerHTML:obj.nom});elt.appendChild(titre);const nba=utils.create("div",{innerHTML:obj.activitiesNumber+" activités"});elt.onclick=()=>{library.displayContent(id,!0)},elt.appendChild(nba),grille.appendChild(elt)}for(const o in ordre){grille=document.getElementById(o);for(let i=0;i<ordre[o].length;i++)void 0!==MM.content[ordre[o][i]].activitiesNumber&&0!==MM.content[ordre[o][i]].activitiesNumber&&"activitiesNumber"!==i&&setContent(ordre[o][i],MM.content[ordre[o][i]])}},closeMessage(id){let div=document.getElementById(id);div.parentNode.removeChild(div)},createSearchCheckboxes(){let dest=document.getElementById("searchLevels");const ordre=library.ordre;for(const o in ordre)for(let i=0;i<ordre[o].length;i++){if(void 0===MM.content[ordre[o][i]].activitiesNumber||0===MM.content[ordre[o][i]].activitiesNumber||"activitiesNumber"===i)continue;const div=utils.create("div"),input=utils.create("input",{type:"checkbox",name:"searchlevel",value:ordre[o][i],className:"checkbox",id:"ccbs"+ordre[o][i]});input.onclick=()=>{library.displayContent(document.getElementById("searchinput").value)};const label=utils.create("label",{for:"ccbs"+ordre[o][i],innerText:MM.content[ordre[o][i]].nom});label.onclick=evt=>{document.getElementById(evt.target.for).click()},div.appendChild(input),div.appendChild(label),dest.appendChild(div)}},deploy(elt){let destClass="hideup",eltClass="pointer plus";if("H3"===elt.nodeName){let dest=elt.nextSibling;elt.className===eltClass&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass,dest.className=destClass}else if("H2"===elt.nodeName)for("pointer plus"===elt.className&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass;null!==elt.nextSibling&&"H2"!==(elt=elt.nextSibling).nodeName;)"UL"===elt.nodeName?elt.className=destClass:"H3"===elt.nodeName&&(elt.className=eltClass);else if("H1"===elt.nodeName){"pointer plus"===elt.className&&(eltClass="pointer moins",destClass="showdown"),elt.className=eltClass;const h2=document.querySelectorAll("#resultat-chercher h2"),h3=document.querySelectorAll("#resultat-chercher h3"),ul=document.querySelectorAll("#resultat-chercher ul");h2.forEach(el=>el.className=eltClass),h3.forEach(el=>el.className=eltClass),ul.forEach(el=>el.className=destClass)}},tableToText:array=>void 0===array?"":"string"==typeof array?array:array.join(","),textToTable:string=>void 0===string||""===string?[]:string.split(",").map(Number),objToText(obj){if(void 0===obj)return"";let string="",start=!0;for(const i in obj)start?(string+=i+"."+utils.tableToText(obj[i]),start=!1):string+="-"+i+"."+utils.tableToText(obj[i]);return string},textToObj(string){let obj={},elts=string.split("-");for(let i=0;i<elts.length;i++){let subelts=elts[i].split(".");obj[subelts[0]]=utils.textToTable(subelts[1])}return obj},removeClass:function(elt,className){if((" "+elt.className+" ").indexOf(" "+className+" ")>-1){var classes=elt.className.split(" "),newclasses="";for(let i=0;i<classes.length;i++)classes[i]!==className&&(newclasses+=" "+classes[i]);elt.className=newclasses.trim()}},changeTempoValue:function(value){document.getElementById("tempo-value").innerHTML=value+" s.",MM.editedActivity&&MM.editedActivity.setTempo(value),MM.carts[MM.selectedCart].editedActivityId>-1&&(document.querySelectorAll("#cart"+MM.selectedCart+"-list li.active span")[0].innerHTML=value)},changeNbqValue:function(value){document.getElementById("nbq-value").innerHTML=value,MM.editedActivity&&MM.editedActivity.setNbq(value),MM.carts[MM.selectedCart].editedActivityId>-1&&(document.querySelectorAll("#cart"+MM.selectedCart+"-list li.active span")[1].innerHTML=value)},checkValues:function(){utils.changeTempoValue(document.getElementById("tempo-slider").value),utils.changeNbqValue(document.getElementById("nbq-slider").value)},checkSecurity:()=>(utils.security--,!(utils.security<0)||(console.log("infinite loop"),!1)),initializeAlea:function(seed){utils.alea=seed?new Math.seedrandom(seed):new Math.seedrandom(MM.seed)},showTab:function(element){let tab,el;utils.resetAllTabs(),"none"!==element&&("string"==typeof element?(tab=element,el=document.querySelector("#header-menu a[numero='#"+element+"']")):(el=element,tab=element.getAttribute("numero").substr(1)),utils.addClass(el,"is-active"),document.getElementById(tab).style.display="")},showParameters:function(id){let ids=["paramsdiapo","paramsexos","paramsinterro","paramsceinture","paramsflashcards","paramswhogots","paramsdominos"];if(ids.indexOf(id)<0)return!1;for(let i=0,len=ids.length;i<len;i++)document.getElementById(ids[i]).className="hidden";document.getElementById(id).className=""},resetAllTabs:function(){utils.annotate(!1);let tabsButtons=document.querySelectorAll("#header-menu .tabs-menu-link"),contents=document.querySelectorAll(".tabs-content-item");document.getElementById("tab-accueil").display="none",contents.forEach(element=>{element.style.display="none"}),utils.removeClass(document.getElementById("btnaccueil"),"is-active"),tabsButtons.forEach(element=>{utils.removeClass(element,"is-active")})},toDecimalFr:function(value){let parties=value.split("."),partieEntiere=parties[0],partieDecimale="";if(parties.length>1&&(partieDecimale=parties[1]),partieEntiere.length>3){let s=partieEntiere.length%3;partieEntiere=partieEntiere.substring(0,s)+"~"+partieEntiere.substring(s).match(/\d{3}/g).join("~")}if(partieDecimale.length>3){let nbgp=~~(partieDecimale.length/3);partieDecimale=partieDecimale.match(/\d{3}/g).join("~")+"~"+partieDecimale.substring(3*nbgp)}return partieDecimale.length&&(partieDecimale="{,}"+partieDecimale),partieEntiere+partieDecimale},annotate:function(target,btnId){!1===target&&void 0!==MM.annotate?(MM.annotate.destroy(),MM.annotate=void 0):void 0===MM.annotate&&_.isString(target)?MM.annotate=new draw(target,btnId):void 0!==MM.annotate&&(MM.annotate.destroy(),MM.annotate=void 0)},mathRender:function(wtarget){let contents;if(["tab-enonce","tab-corrige","activityOptions","activityDescription"].forEach(id=>{let content=document.getElementById(id).innerHTML;document.getElementById(id).innerHTML=content.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>')}),document.querySelectorAll(".slide").forEach(elt=>{elt.innerHTML=elt.innerHTML.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>')}),void 0!==wtarget){let content=wtarget.document.getElementById("creator-content");content.innerHTML=content.innerHTML.replace(/\$\$([^$]*)\$\$/gi,'<span class="math">$1</span>'),content.querySelectorAll(".math").forEach((function(item){var texTxt=item.innerHTML.replace(/\&amp\;/g,"&");let nbrgx=/(\d+\.*\d*)/g;texTxt=texTxt.replace(nbrgx,utils.toDecimalFr);try{katex.render(texTxt,item,{throwOnError:!1,errorColor:"#FFF",colorIsTextColor:!0}),utils.removeClass(item,"math")}catch(err){item.innerHTML="<span class='err'>"+err+" avec "+texTxt+"</span>"}}))}document.querySelectorAll(".math").forEach((function(item){var texTxt=item.innerHTML.replace(/\&amp\;/g,"&");let nbrgx=/(\d+\.*\d*)/g;texTxt=texTxt.replace(nbrgx,utils.toDecimalFr);try{katex.render(texTxt,item,{throwOnError:!1,errorColor:"#FFF",colorIsTextColor:!0}),utils.removeClass(item,"math")}catch(err){item.innerHTML="<span class='err'>"+err+" avec "+texTxt+"</span>"}}))},clone:someThing=>void 0!==someThing&&("object"==typeof someThing?JSON.parse(JSON.stringify(someThing)):someThing),toDigits(value,digits){let puissance=Number("1e"+digits)-1;for(;String(value).length<String(puissance).length;)value="0"+value;return value}},sound={list:[["sounds/BELLHand_Sonnette de velo 2 (ID 0275)_LS.mp3","Sonette"],["sounds/COMCam_Un declenchement d appareil photo (ID 0307)_LS.mp3","Reflex"],["sounds/COMCell_E mail envoye (ID 1312)_LS.mp3","Email"],["sounds/COMTran_Bip aerospatial 1 (ID 2380)_LS.mp3","Bip"],["sounds/MUSCPerc_Cartoon agogo 2 (ID 2262)_LS.mp3","Agogo"],["sounds/ROBTVox_Notification lasomarie 4 (ID 2062)_LS.mp3","Notif"],["sounds/SWSH_Epee qui coupe (ID 0127)_LS.mp3","Couper"],["sounds/SWSH_Epee qui fend l air (ID 0128)_LS.mp3","Fendre"],["sounds/SWSH_Whoosh 3 (ID 1795)_LS.mp3","whoosh"],["sounds/TOONHorn_Klaxon poire double 1 (ID 1830)_LS.mp3","Pouet"],["sounds/VEHHorn_Klaxon de voiture recente 4 (ID 0260)_LS.mp3","Klaxon"],["sounds/WATRSplsh_Plouf petit 6 (ID 1534)_LS.mp3","Plouf"],["sounds/Anas_platyrhynchos_-_Mallard_-_XC62258.mp3","Coincoin"]],selected:"null",player:null,getPlayer(){this.player=document.getElementById("soundplayer");let slct=document.getElementById("playerlist");for(let i=0;i<this.list.length;i++){let option=utils.create("option",{value:i,innerText:this.list[i][1]});slct.appendChild(option)}},play(){"null"!==this.selected&&this.player.play()},next(){"null"===this.selected&&(this.selected=-1),this.setSound((this.selected+1)%this.list.length),this.play()},select(id){this.setSound(id),this.play()},setSound(id){this.selected=id,"null"!==this.selected&&(this.player.src=this.list[id][0])}},math={premiers:[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997,1009,1013,1019,1021,1031,1033,1039,1049,1051,1061,1063,1069,1087,1091,1093,1097,1103,1109,1117,1123,1129,1151,1153,1163,1171,1181,1187,1193,1201,1213,1217,1223,1229,1231,1237,1249,1259,1277,1279,1283,1289,1291,1297,1301,1303,1307,1319,1321,1327,1361,1367,1373,1381,1399,1409,1423,1427,1429,1433,1439,1447,1451,1453,1459,1471,1481,1483,1487,1489,1493,1499,1511,1523,1531,1543,1549,1553,1559,1567,1571,1579,1583,1597,1601,1607,1609,1613,1619,1621,1627,1637,1657,1663,1667,1669,1693,1697,1699,1709,1721,1723,1733,1741,1747,1753,1759,1777,1783,1787,1789,1801,1811,1823,1831,1847,1861,1867,1871,1873,1877,1879,1889,1901,1907,1913,1931,1933,1949,1951,1973,1979,1987,1993,1997,1999],round:function(nb,precision){if(void 0===precision)return Math.round(nb);if(precision<5)return Number(Math.round(Number(nb+"e"+precision))+"e"+-precision);{let z;return new Big(nb).round(precision).toFixed()}},valeurParDefaut:function(valeur,precision){return void 0===precision?Math.floor(valeur):Number(Math.floor(Number(valeur+"e"+precision))+"e"+-precision)},valeurParExces:function(valeur,precision){return void 0===precision?Math.ceil(valeur):Number(Math.ceil(Number(valeur+"e"+precision))+"e"+-precision)},aleaInt:function(min,max,...others){let qty=1,avoid=[],arrayType=!1;utils.security=300;let nodouble=!1,notPrime=!1;for(let i=0;i<others.length;i++)String(Number(others[i]))===others[i]||"number"==typeof others[i]?(qty=others[i],arrayType=!0):"string"==typeof others[i]&&"^"==others[i][0]&&(avoid=others[i].substring(1).split(","),avoid.indexOf("&")>-1&&(nodouble=!0),avoid.indexOf("prime")>-1&&(notPrime=!0),avoid=avoid.map(Number));if(min===max)return min;if(max<min&&([min,max]=[max,min]),arrayType){var integers=[];for(let i=0;i<qty;i++){let thisint=math.round(utils.alea()*(max-min))+min;if(avoid.indexOf(thisint)>-1||nodouble&&integers.indexOf(thisint)>-1||notPrime&&math.premiers.indexOf(thisint)>-1){if(i--,!utils.checkSecurity())break}else if(integers.push(thisint),!utils.checkSecurity())break}return integers}{let thisint;do{if(thisint=math.round(utils.alea()*(max-min))+min,!utils.checkSecurity())break}while(avoid.indexOf(thisint)>-1||notPrime&&math.premiers.indexOf(thisint)>-1);return thisint}},aleaFloat:function(min,max,precision,...others){let qty=1,avoid=[],nodouble=!1;utils.security=300;for(let i=0;i<others.length;i++)String(Number(others[i]))===others[i]||"number"==typeof others[i]?qty=others[i]:"string"==typeof others[i]&&"^"===others[i][0]&&(avoid=others[i].substring(1).split(","),avoid.indexOf("&")>-1&&(nodouble=!0),avoid=avoid.map(Number));if(max<min&&([min,max]=[max,min]),qty>1){let nb;var floats=[];for(let i=0;i<qty;i++)if(nb=math.round(utils.alea()*(max-min)+min,precision),avoid.indexOf(nb)>-1||nodouble&&floats.indexOf(nb)>-1){if(i--,!utils.checkSecurity())break}else if(floats.push(nb),!utils.checkSecurity())break;return floats}{let nb;do{if(nb=math.round(utils.alea()*(max-min)+min,precision),!utils.checkSecurity())break}while(avoid.indexOf(nb)>-1);return nb}},unOuNombre:value=>(value=Number(value),Math.round(Math.random())?1:value),signedNumber:function(nb){return 0===nb?"":nb>0?"+"+nb:nb},signIfOne:function(nb){return 1===nb?"":-1===nb?"-":nb},signedNumberButOne:function(nb){return 0===(nb=Number(nb))?"":1===nb?"+":-1===nb?"-":nb>0?"+"+nb:nb},nP:function(nb){return"-"===String(nb)[0]?"("+nb+")":nb},listeProduits:function(entier,max){let liste=[];void 0===max&&(max=10);for(let i=1,top=Math.floor(Math.sqrt(entier));i<=top;i++){let reste,quotient=~~(entier/i);0==entier%i&&i<=max&&quotient<=max&&liste.push(i+"\\times"+quotient)}return liste.join("; ")},listeDiviseurs:function(nb,array){let maxSearch=Math.floor(Math.sqrt(nb)),diviseurs=[],grandsdiviseurs=[];for(let i=1;i<=maxSearch;i++)nb%i==0&&(diviseurs.push(i),i!==nb/i&&grandsdiviseurs.unshift(nb/i));return diviseurs=diviseurs.concat(grandsdiviseurs),!0===array?diviseurs:diviseurs.join("; ")},plusGrandDiviseur:function(nb){const liste=math.listeDiviseurs(nb,!0);return liste[liste.length-2]},plusGrandDiviseurPremier(nb){if(nb<2)return nb;let prime=0,indice=0;for(;math.premiers[indice]<=nb;)indice++,nb%math.premiers[indice]==0&&(prime=math.premiers[indice]);return prime},listeDiviseurs10:function(nb){let diviseurs=[2,3,5,9,10],liste=[];for(let i=0,len=diviseurs.length;i<len;i++){const div=diviseurs[i];nb%div==0&&liste.push(div)}return liste.length?liste.join("; "):"aucun des nombres"},nonDiviseur(nb){let unnondiviseur=0;do{unnondiviseur=math.aleaInt(2,nb-1)}while(nb%unnondiviseur==0);return unnondiviseur},fractionDecimale(decimal){let string=decimal.toString(),pointPosition=string.indexOf(".");if(pointPosition<0)return"\\dfrac{"+decimal+"}{1}";{let nbChiffres=string.length-pointPosition-1;return"\\dfrac{"+math.round(decimal*Math.pow(10,nbChiffres),0)+"}{"+Math.pow(10,nbChiffres)+"}"}},unDiviseur(nb,notOne=!1){let diviseurs=math.listeDiviseurs(nb,!0);return notOne&&(diviseurs=_.rest(diviseurs)),diviseurs[math.aleaInt(0,diviseurs.length-1)]},unpower:function(value){let matches=value.match(/(\d*)\^(\d*)/g);if(matches)for(let i=0,l=matches.length;i<l;i+=2)value=value.replace(matches[i],math.powerToProduct(matches[i]));return value},powerToProduct(power){let nb=Number(power.substring(0,power.indexOf("^"))),puissance=Number(power.substring(power.indexOf("^")+1)),a=[];for(let i=0;i<puissance;i++)a.push(nb);return a.join("*")},sToMin(sec){let time="";return(sec=Number(sec))>3600&&(time+=~~(sec/3600)+" h ",sec%=3600),sec>60&&(time+=~~(sec/60)+" min ",sec%=60),time+sec},toTex:string=>string.replace(/\*/g,"\\times"),simplifieRacine(radicande){const factors=Algebrite.run("factor("+radicande+")").split("*");let outOfSquareR=1,inSquareR=1;for(let i=0;i<factors.length;++i){const elt=factors[i].split("^"),nb=elt[0],power=void 0===elt[1]?1:elt[1];outOfSquareR*=Math.pow(nb,Math.floor(power/2)),inSquareR*=Math.pow(nb,power%2)}return(outOfSquareR>1?outOfSquareR:"")+(inSquareR>1?"\\sqrt{"+inSquareR+"}":"")},estDivisiblePar(nb,par,type){let reponses={w:[" est divisible ","n'est pas divisible"],yn:["oui","non"]};return(nb=Number(nb))%(par=Number(par))==0?reponses[type][0]:reponses[type][1]},compare:(a,b)=>a<b?"\\lt":a>b?"\\gt":"=",pgcd:function(a,b){return Algebrite.run("gcd("+a+","+b+")")},ppcm:function(a,b){return Algebrite.run("lcm("+a+","+b+")")},inverse:function(expr,notex){let ret;return ret=void 0===notex||!1===notex?Algebrite.run("printlatex(1/("+expr+"))"):Algebrite.run("1/("+expr+")"),ret},calc:function(expr,notex){let ret;return ret=void 0===notex||!1===notex?Algebrite.run("printlatex("+expr+")").replace(/frac/g,"dfrac"):Algebrite.run(expr),ret},getHM(h,m,s){void 0===s&&(s=0);var d=new Date(2010,1,1,Number(h),Number(m),Number(s));return d.getHours()+" h "+(d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes())},getHMs(h,m,s){void 0===s&&(s=0);var d=new Date(2010,1,1,Number(h),Number(m),Number(s));return d.getHours()+" h "+(d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes())+" min "+(d.getSeconds()<10?"0"+d.getSeconds():d.getSeconds())+" s."},fractionSimplifiee(n,d){(n<0&&d<0||n>0&&d<0)&&(n=-n,d=-d);const gcd=math.pgcd(n,d);return Number.isInteger(n/d)?n/d:"\\dfrac{"+n/gcd+"}{"+d/gcd+"}"},simplifyFracDec(n,d){for(;n%10==0&&d%10==0;)n/=10,d/=10;return"\\dfrac{"+n+"}{"+d+"}"},phrase(operandes,operations,option,ordre){let x,y,r,z,phrases={"+":["la somme de ${x} et de ${y}","${x}+${y}","${x}+${y}"],"-":["la différence entre ${x} et ${y}","${x}-${y}","${x}-${y}"],"*":["le produit de ${x} par ${y}","${x}\\\\times ${y}","${x}*${y}"],"/":["le quotient de ${x} par ${y}","${x}\\\\div ${y}","${x}/${y}"],q:["le quotient de ${x} par ${y}","\\\\dfrac{${x}}{${y}}","${x}/${y}"]};switch(x=operandes[0],y=operandes[1],option){case"p":r=eval("`"+phrases[operations[0]][0]+"`");break;case"a":r=eval("`"+phrases[operations[0]][1]+"`");break;case"v":r=eval("`"+phrases[operations[0]][2]+"`")}if(operations.length>1)switch(ordre?(x=r,y=operandes[2],z=x,["*","/"].indexOf(operations[1])>-1&&["-","+"].indexOf(operations[0])>-1&&(z="("+x+")")):(x=operandes[2],y=r,z=y,(["*","/","-"].indexOf(operations[1])>-1&&["-","+"].indexOf(operations[0])>-1||"/"===operations[0])&&(z="("+y+")")),option){case"p":r=eval("`"+phrases[operations[1]][0]+"`").replace("de le","du");break;case"a":ordre?x=z:y=z,r=eval("`"+phrases[operations[1]][1]+"`");break;case"v":ordre?x=z:y=z,r=eval("`"+phrases[operations[1]][2]+"`")}return r},bigDecimal(a,op,b){let x=Big(a);return eval("x."+op+"("+b+").toString()")},montant:function(billets,entier,tot){let valeursBillets=[5,10,20,50,100],min=1/0,total=0;for(let i=0,len=billets.length;i<len;i++)min>valeursBillets[billets[i]]&&(min=valeursBillets[billets[i]]),total+=valeursBillets[billets[i]];return tot?total:entier?math.aleaInt(total-min+1,total):math.aleaFloat(total-min+1,total,2)},listeBillets:function(billets){let valeursBillets=[5,10,20,50,100],lesbillets={5:0,10:0,20:0,50:0,100:0},txt="des billets : ";for(let i=0,len=billets.length;i<len;i++)lesbillets[valeursBillets[billets[i]]]++;for(let val in lesbillets)lesbillets[val]>1?txt+=lesbillets[val]+" de "+val+" €, ":lesbillets[val]>0&&(txt+=val+" €, ");return txt}};window.onload=function(){let listener=function(evt){MM.touched=!0,window.removeEventListener("touchstart",listener,!1)},tabsButtons;window.addEventListener("touchstart",listener,!1),MM.ascii2tex=new AsciiMathParser,MM.resetCarts(),document.querySelectorAll("#header-menu .tabs-menu-link").forEach(element=>{element.onclick=function(){utils.showTab(element)}}),document.getElementById("btnaccueil").onclick=function(element){utils.showTab(element.target)},utils.checkValues(),utils.initializeAlea(Date()),library.openContents(),sound.getPlayer(),document.getElementById("chooseParamType").value="paramsdiapo",MM.setDispositionEnonce(utils.getRadioChecked("Enonces")),window.localStorage&&(document.querySelector("#tab-historique ol").innerHTML=localStorage.getItem("history"));for(let i=0;i<4;i++){let leparent=document.getElementById("sddiv"+(i+1));MM.colorSelectors[i]=new Picker({parent:leparent,color:"#FFFFFF"}),MM.colorSelectors[i].onChange=function(color){leparent.style.background=color.rgbaString,MM.colors[i]=color.rgbaString}}};class cart{constructor(id){this.id=id,this.activities=[],this.ordered=!0,this.sortable=void 0,this.editedActivityId=-1,this.target=[id],this.nbq=0,this.time=0,this.title="Diapo "+(id+1),this.loaded=!1}export(){let urlString="&p="+this.id+"~t="+encodeURI(this.title)+"~c="+this.target+"~o="+this.ordered;for(let i=0,l=this.activities.length;i<l;i++)urlString+="_"+this.activities[i].export();return urlString}import(obj,start=!1){this.title=obj.t,this.target=obj.c,"false"!==obj.o&&obj.o?this.ordered=!0:this.ordered=!1;let activities=[];for(const i in obj.a)activities.push(activity.import(obj.a[i],i));return Promise.all(activities).then(data=>{data.forEach(table=>{this.activities[table[0]]=table[1]}),this.loaded=!0,this.display(),start&&MM.checkLoadedCarts()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger tous les exercices :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert),setTimeout(()=>{let div=document.getElementById("messageerreur");div.parentNode.removeChild(div)},3e3)})}duplicate(){if(MM.carts.length<4){MM.addCart();let cart=MM.carts[MM.carts.length-1];for(let i=0;i<this.activities.length;i++)cart.addActivity(this.activities[i]);cart.display()}}addActivity(obj){this.editedActivityId=-1;let temp=new activity(obj);this.activities.push(temp),this.display()}removeActivity(index){this.activities.splice(index,1),this.display()}exchange(oldIndex,newIndex){let indexes=this.activities.getKeys(),tempindexes=indexes[oldIndex],temp=this.activities[oldIndex];this.activities.splice(oldIndex,1),indexes.splice(oldIndex,1),this.activities.splice(newIndex,0,temp),indexes.splice(newIndex,0,tempindexes),this.editedActivityId=indexes.indexOf(this.editedActivityId),this.display()}display(){document.querySelector("#cart"+this.id+" h3").innerText=this.title;let dom=document.getElementById("cart"+this.id+"-list");dom.innerHTML="",this.time=0,this.nbq=0;for(let i=0,l=this.activities.length;i<l;i++){let li=document.createElement("li"),activity=this.activities[i];this.time+=Number(activity.tempo)*Number(activity.nbq),this.nbq+=Number(activity.nbq),li.innerHTML="<img src='img/editcart.png' align='left' onclick='MM.editActivity("+i+")' title=\"Editer l'activité\">"+activity.title+" (<span>"+activity.tempo+"</span> s. / <span>"+activity.nbq+"</span> quest.)",MM.carts[this.id].editedActivityId===i&&(li.className="active"),dom.appendChild(li)}let spans=document.querySelectorAll("#cart"+this.id+" div.totaux span");spans[0].innerHTML=math.sToMin(this.time),spans[1].innerHTML=this.nbq,spans[2].innerHTML=this.target,this.sortable=new Sortable(dom,{animation:150,ghostClass:"ghost-movement",onEnd:evt=>MM.carts[this.id].exchange(evt.oldIndex,evt.newIndex)})}changeOrder(objImage){"true"===objImage.dataset.ordered?(objImage.src="img/iconfinder_windy_1054934.png",objImage.title="Affichage mélangé des questions",objImage.dataset.ordered="false",this.ordered=!1):(objImage.src="img/iconfinder_stack_1054970.png",objImage.title="Affichage dans l'ordre des activités",objImage.dataset.ordered="true",this.ordered=!0)}}class draw{constructor(tgt,btnId){const target=document.getElementById(tgt);let c=utils.create("canvas",{id:"painting",width:target.offsetWidth,height:target.offsetHeight+30});this.btn=document.querySelector("#"+btnId+" img"),this.btn.src="img/iconfinder_pencil_activ.png",target.appendChild(c),this.canvas=c,btnId.indexOf("btn-sample")>-1?(this.canvas.style.top=0,this.canvas.style.left=0):(this.canvas.style.top=target.offsetTop+"px",this.canvas.style.left=target.offsetLeft+"px"),this.mouse={x:0,y:0};const mouvement=event=>{let target=event.target,evt=event;MM.touched&&(target=event.touches[0].target,evt=event.touches[0]),this.mouse.x=evt.pageX-target.getBoundingClientRect().x,this.mouse.y=evt.pageY-target.getBoundingClientRect().y,this.enableDraw&&(this.started?(this.ctx.lineTo(this.mouse.x,this.mouse.y),this.ctx.stroke()):(this.started=!0,this.ctx.beginPath(),this.ctx.moveTo(this.mouse.x,this.mouse.y))),event.touches&&event.preventDefault()},yesDraw=event=>{this.enableDraw=!0,event.touches&&event.preventDefault()},noDraw=event=>{this.enableDraw=!1,this.started=!1,event.touches&&event.preventDefault()};this.ctx=this.canvas.getContext("2d"),this.ctx.strokeStyle="grey",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.stroke(),this.ctx.strokeStyle="blue",this.ctx.lineWidth=1,this.ctx.shadowBlur=1,this.ctx.shadowColor="blue",this.ctx.lineJoin="round",this.ctx.lineCap="round",this.canvas.addEventListener("mousemove",mouvement,!1),this.canvas.addEventListener("mousedown",yesDraw,!1),this.canvas.addEventListener("mouseup",noDraw,!1),this.canvas.addEventListener("mouseout",noDraw,!1),MM.touched&&(this.canvas.addEventListener("touchmove",mouvement,!1),this.canvas.addEventListener("touchstart",yesDraw,!1),this.canvas.addEventListener("touchend",noDraw,!1))}destroy(){this.btn.src="img/iconfinder_pencil_1055013.png",this.canvas.parentNode.removeChild(this.canvas),this.canvas=void 0,this.ctx=void 0}}class steps{constructor(obj){this.step=0,this.size=Number(obj.size),this.container=obj.container}addSize(value){this.size+=Number(value)}display(){let ul=document.createElement("ul");ul.className="steps is-balanced has-gaps is-medium is-horizontal has-content-above has-content-centered";for(let i=0;i<this.size;i++){let li=utils.create("li",{className:"steps-segment"}),span=document.createElement("span");i===this.step?(span.className="steps-marker is-hollow",span.innerHTML=this.step+1,li.appendChild(span),li.className+=" is-active"):(span.className="steps-marker",li.appendChild(span)),ul.appendChild(li)}if(this.container.hasChildNodes()){let node=this.container.childNodes[0];this.container.replaceChild(ul,node)}else this.container.appendChild(ul)}nextStep(){return this.step++,this.display(),!(this.step>=this.size)&&this.step}}class Zoom{constructor(id,targetSelector){this.target=targetSelector,this.id=id}changeSize(value,obj=!1){let dest;10===value&&obj&&(obj.value=10),document.querySelectorAll(this.target).forEach(elt=>elt.style.fontSize=math.round(Number(value)/10,1)+"em")}createCursor(){let div=utils.create("div",{id:this.id,className:"zoom"}),span=utils.create("span",{className:"zoom-a0",innerText:"A"}),span2=utils.create("span",{className:"zoom-A1",innerText:"A"}),cursor=`<input id="zoom${this.id}" type="range" min="6" max="60" step="2" value="10" oninput="MM.zooms['${this.id}'].changeSize(this.value)" ondblclick="MM.zooms['${this.id}'].changeSize(10,this)">`;return div.appendChild(span),div.innerHTML+=cursor,div.appendChild(span2),div}}class Figure{constructor(obj,id,target,size){this.type=obj.type,this.content=obj.content,this.boundingbox=obj.boundingbox,this.axis=obj.axis,this.grid=obj.grid,this.id=id,this.size=size,this.imgSrc=obj.imgSrc||!1,this.figure=void 0,this.displayed=!1,this.create(target)}create(destination){if("chart"===this.type){let div=utils.create("div",{id:"div-dest-canvas-"+this.id}),canvas=document.createElement("canvas");canvas.id=this.id,void 0!==this.size&&(div.style.width=this.size[0]+"px",div.style.height=this.size[1]+"px"),div.appendChild(canvas),destination.appendChild(div)}else if("graph"===this.type){let div=document.createElement("div");div.id=this.id,div.className="jsxbox fig",destination.appendChild(div)}}static copyFig(figure,target){return!(!figure instanceof Figure)&&new this(figure,figure.id,target,figure.size)}toggle(){let elt,cln;"chart"===this.type?elt=document.getElementById(this.id).parentNode:"graph"===this.type&&(elt=document.getElementById(this.id)),elt.className.indexOf("visible")<0?(utils.addClass(elt,"visible"),this.display()):utils.removeClass(elt,"visible")}display(destination){if(!this.displayed)if(this.displayed=!0,"chart"===this.type){let target;target=void 0===destination?document.getElementById(this.id):destination.document.getElementById(this.id),this.figure=new Chart(target,this.content)}else if("graph"===this.type)try{this.figure=void 0===destination?JXG.JSXGraph.initBoard(this.id,{boundingbox:this.boundingbox,keepaspectratio:!0,showNavigation:!1,showCopyright:!1,registerEvents:!1,axis:this.axis,grid:this.grid}):destination.JXG.JSXGraph.initBoard(this.id,{boundingbox:this.boundingbox,keepaspectratio:!0,showNavigation:!1,showCopyright:!1,registerEvents:!1,axis:this.axis,grid:this.grid});let content=utils.clone(this.content),elements=[];for(let i=0,len=content.length;i<len;i++){let type=content[i][0],commande=content[i][1],options=!1,reference=!1;if(void 0!==content[i][2]&&(options=content[i][2]),void 0!==content[i][3]&&(reference=elements[content[i][3]],commande.forEach((function(elt,index){"string"==typeof elt&&0===elt.indexOf("ref")&&(commande[index]=elements[Number(elt.substr(3))])}))),"functiongraph"===type){let formule=commande;options?this.figure.create("functiongraph",[function(x){return eval(formule)}],options):this.figure.create("functiongraph",[function(x){return eval(formule)}],{strokeWidth:2})}else"jessiescript"===type?(void 0===this.figure.jc&&(this.figure.jc=new JXG.JessieCode,this.figure.jc.use(this.figure)),this.figure.jc.parse(commande)):["text","point","axis","line","segment","angle","polygon","transform","intersection"].indexOf(type)>-1&&(elements[i]=options?this.figure.create(type,commande,options):this.figure.create(type,commande))}}catch(error){debug("Figure",error,this)}}}class timer{constructor(slideid){this.durations=[],this.durationId=0,this.startTime=0,this.endTime=0,this.timeLeft=0,this.percent=0,this.id=slideid,this.break=!1,this.timer=!1,this.ended=!1}getTimeLeft(){this.timeLeft=this.endTime-Date.now(),this.percent=Math.round(100-this.timeLeft/10/this.durations[this.durationId]),this.display(),this.timeLeft<=0&&(this.stop(),MM.nextSlide(this.id))}addDuration(value){this.durations.push(value)}start(id){if(this.stop(),this.ended)return!1;if(this.break=!1,"no"===MM.onlineState){let btnPause=document.querySelectorAll("#slider"+this.id+" .slider-nav img")[1];btnPause.src="img/slider-pause.png",utils.removeClass(btnPause,"blink_me")}id>-1&&(this.timeLeft=1e3*this.durations[id],this.durationId=id),this.startTime=Date.now(),this.endTime=this.startTime+this.timeLeft,this.timer&&(clearInterval(this.timer),this.timer=!1),this.timer=setInterval(this.getTimeLeft.bind(this),50)}pause(){if(this.ended)return!1;if(this.break)return this.break=!1,this.start(),!1;{this.break=!0,this.stop();let btnPause=document.querySelectorAll("#slider"+this.id+" .slider-nav img")[1];btnPause.src="img/slider-play.png",utils.addClass(btnPause,"blink_me")}}stop(){this.timer&&(clearInterval(this.timer),this.timer=!1)}end(){this.stop(),this.ended=!0,MM.messageEndSlide(this.id,this.durationId),setTimeout(MM.endSliders,3e3)}display(){document.querySelector("#slider"+this.id+" progress").value=this.percent}}class ficheToPrint{constructor(type,cart,orientation="portrait"){this.type=type,this.activities=cart.activities,this.wsheet="portrait"===orientation?window.open("pagetoprint.html","mywindow","location=no,menubar=no,titlebar=no,width=794"):window.open("pagetoprintlandscape.html","mywindow","location=no,menubar=no,titlebar=no,width=1123"),this.wsheet.onload=function(){MM.fiche.populate()},this.nbq=void 0,"whogots"===this.type&&1===this.activities.length?this.nbq=document.getElementById("cardsNbValue").value:"dominos"===this.type&&1===this.activities.length&&(this.nbq=document.getElementById("dominosNbValue").value)}generateQuestions(){for(let index=0;index<this.activities.length;index++){const activity=this.activities[index];activity.generate(this.nbq)}}populate(){this.wsheet.document.getElementsByTagName("html")[0].className="s"+document.getElementById("exTxtSizeValue").value.replace(".",""),this.content=this.wsheet.document.getElementById("creator-content"),this.docsheet=this.wsheet.document,utils.setSeed(),"exo"===this.type?this.createExoSheet():"exam"===this.type?this.createInterroSheet():"ceinture"===this.type?this.createCeintureSheet():"flashcard"===this.type?(this.generateQuestions(),this.createFlashCards()):"whogots"===this.type?(this.generateQuestions(),this.createWhoGots()):"dominos"===this.type&&(this.generateQuestions(),this.createDominos()),utils.mathRender(this.wsheet),1===MM.carts.length&&1===MM.carts[0].activities.length&&(MM.resetCarts(),MM.editedActivity.display())}create(type,params){let elm=this.docsheet.createElement(type);for(let i in params)elm[i]=params[i];return elm}createExoSheet(){let correction="end",radios=document.getElementsByName("excorr");for(let index=0;index<radios.length;index++)radios[index].checked&&(correction=radios[index].value);let script=this.create("script",{text:"function changecols(dest,nb){document.getElementById(dest).className=\"grid g\"+nb};\n        function pagebreak(){let cor=document.querySelectorAll('.correction'),btn=document.getElementById('btn-break');if(cor[0].className===\"correction\"){for(i=0;i<cor.length;i++){cor[i].className=\"correction pagebreak\";}btn.innerText='Corrigé à la suite des énoncés';}else {for(i=0;i<cor.length;i++){cor[i].className=\"correction\";}btn.innerText='Corrigé sur page séparée';}}\n        "});this.docsheet.head.appendChild(script),"end"===correction&&(this.docsheet.getElementById("creator-menu").innerHTML+="<button id='btn-break' onclick='pagebreak();'>Corrigé sur page séparée</button>"),MM.memory={};for(let qty=0;qty<document.getElementById("exQtyValue").value;qty++){this.generateQuestions(),qty>0&&this.content.appendChild(this.create("footer"));let aleaCode=this.create("div",{className:"floatright",innerHTML:"Clé : "+MM.seed+" p."+(qty+1)});this.content.appendChild(aleaCode);let sheetTitle=document.getElementById("extitle").value||"Fiche d'exercices",header=this.create("header",{innerHTML:sheetTitle});this.content.appendChild(header);let exTitle=document.getElementById("exeachex").value||"Exercice n°",correctionContent=this.create("div",{className:"correction"}),titleCorrection=this.create("header",{className:"clearfix",innerHTML:"Correction des exercices"});"end"===correction&&correctionContent.appendChild(titleCorrection);let divclear=this.create("div",{className:"clearfix"});for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];let sectionEnonce=this.create("section",{id:"enonce"+qty+"-"+i,className:"enonce"}),sectionCorrection=this.create("section",{id:"corrige"+qty+"-"+i}),input=`<input id="nbcols${qty}-${i}" class="noprint fright" value="2" title="Nb de colonnes" type="number" size="2" min="1" max="6" oninput="changecols('ol${qty}-${i}',this.value)">`;sectionEnonce.innerHTML+=input;let h3=this.create("h3",{className:"exercice-title",innerHTML:exTitle+(i+1)+" : "+activity.title});sectionEnonce.appendChild(h3);let ol=this.create("ol",{id:"ol"+qty+"-"+i,className:"grid g2"}),olCorrection=this.create("ol",{className:"corrige"});for(let j=0;j<activity.questions.length;j++){let li=this.create("li",{className:"c3"}),liCorrection=this.create("li");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=this.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=this.create("span",{className:"math",innerHTML:activity.answers[j]});li.appendChild(span),liCorrection.appendChild(spanCorrection)}else li.innerHTML=activity.questions[j],liCorrection.innerHTML=activity.answers[j];ol.appendChild(li),void 0!==activity.figures[j]&&(0===i&&0===j&&(MM.memory.dest=this.wsheet),MM.memory[qty+"-f"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),qty+"-f"+i+"-"+j,li)),olCorrection.appendChild(liCorrection)}sectionEnonce.appendChild(ol);let ds=divclear.cloneNode(!0);if(sectionEnonce.appendChild(ds),"end"!==correction){let hr=this.docsheet.createElement("hr");hr.style.width="50%",sectionEnonce.appendChild(hr),sectionEnonce.appendChild(olCorrection)}else{let h3correction=h3.cloneNode(!0);sectionCorrection.appendChild(h3correction),sectionCorrection.appendChild(olCorrection),correctionContent.appendChild(sectionCorrection)}this.content.appendChild(sectionEnonce)}if(correctionContent.hasChildNodes){this.content.appendChild(correctionContent);let ds=divclear.cloneNode(!0);this.content.appendChild(ds)}}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}createInterroSheet(){MM.memory={};let script=this.create("script",{text:'\n        function changecols(dest,nb){document.getElementById(dest).className="grid g"+nb};\n        function changeheight(dest,nb){\n            let elts = document.querySelectorAll("#"+dest+" .interro article");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.height = nb+"pt";\n            }\n        }\n        '});this.docsheet.head.appendChild(script);for(let qty=0;qty<document.getElementById("intQtyValue").value;qty++){this.generateQuestions(),qty>0&&this.content.appendChild(this.create("footer"));let aleaCode=this.create("div",{className:"floatright",innerHTML:"Clé : "+MM.seed+" p."+(qty+1)});this.content.appendChild(aleaCode);let sheetTitle=document.getElementById("inttitle").value||"Interrogation écrite",header=this.create("header",{innerHTML:sheetTitle});this.content.appendChild(header);let div1=this.create("div",{className:"studenName",innerHTML:"Nom, prénom, classe :"});this.content.appendChild(div1);let div2=this.create("div",{className:"remarques",innerHTML:"Remarques :"});this.content.appendChild(div2);let exTitle=document.getElementById("inteachex").value||"Exercice n°",correctionContent=this.create("div",{className:"correction"}),titleCorrection=this.create("header",{className:"clearfix",innerHTML:"Correction des exercices"});correctionContent.appendChild(titleCorrection);let divclear=this.create("div",{className:"clearfix"});for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];let sectionEnonce=this.create("section",{id:"section"+qty+"-"+i}),sectionCorrection=this.create("section"),input=`<input id="nbcols${qty}-${i}" class="noprint fright" value="30" title="Taille réponse" type="number" size="3" min="10" max="200" oninput="changeheight('ol${qty}-${i}',this.value)">`;sectionEnonce.innerHTML+=input,input=`<input id="nbcols${qty}-${i}" class="noprint fright" value="2" title="Nb de colonnes" type="number" size="2" min="1" max="6" oninput="changecols('ol${qty}-${i}',this.value)">`,sectionEnonce.innerHTML+=input;let h3=this.create("h3",{className:"exercice-title",innerHTML:exTitle+(i+1)+" : "+activity.title});sectionEnonce.appendChild(h3);let ol=this.create("ol",{id:"ol"+qty+"-"+i,className:"grid g2"}),olCorrection=this.create("ol",{className:"corrige"});for(let j=0;j<activity.questions.length;j++){let li=this.create("li",{className:"interro"}),liCorrection=this.create("li");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=this.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=this.create("span",{className:"math",innerHTML:activity.answers[j]});li.appendChild(span),liCorrection.appendChild(spanCorrection)}else li.innerHTML=activity.questions[j],liCorrection.innerHTML=activity.answers[j];ol.appendChild(li),void 0!==activity.figures[j]&&(0===i&&0===j&&(MM.memory.dest=this.wsheet),MM.memory["f"+qty+"-"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),"f"+qty+"-"+i+"-"+j,li));let article=this.create("article");li.appendChild(article),olCorrection.appendChild(liCorrection)}sectionEnonce.appendChild(ol);let ds=divclear.cloneNode(!0);sectionEnonce.appendChild(ds);let h3correction=h3.cloneNode(!0);sectionCorrection.appendChild(h3correction),sectionCorrection.appendChild(olCorrection),correctionContent.appendChild(sectionCorrection),this.content.appendChild(sectionEnonce)}this.content.appendChild(this.create("footer",{innerHTML:"Fin"})),this.content.appendChild(correctionContent);let ds=divclear.cloneNode(!0);this.content.appendChild(ds)}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}createCeintureSheet(){MM.memory={};const nbCeintures=document.getElementById("ceintqtyvalue").value,nbcols=Number(document.getElementById("ceintcolsval").value),nbrows=Number(document.getElementById("ceintrowsval").value),posCorrection=utils.getRadioChecked("ceintcorrpos");let script=this.create("script",{text:`\n        let exercicesColumn = Array(${nbcols}).fill("column");\n        let nbcols = ${nbcols};\n        /*\n        * change la hauteur des cases réponses, et de l'élément question si réponse dessous plutôt que dessus\n        */\n        function changeHeight(nb){\n            let elts = document.querySelectorAll(".ans");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.height = nb+"pt";\n            }\n        }\n        /*\n        * change la taille des caractères d'une colonne\n        */\n        function changeFontSize(dest,value){\n            // il peut y avoir plusieurs sujets, donc on doit faire un traitement multiple\n            let elts = document.querySelectorAll(".question"+dest);\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.fontSize = value+"pt";\n            }\n        }\n        /*\n        * change la disposition des lignes d'exercices d'une colonne\n        * dest : id de la colonne où changer la place des réponses.\n        * (String) how : column/columnv pour colonnes en ligne ou verticales\n        */\n        function setDispositionReponse(dest,how){\n            let setr="auto auto",setc="none";\n            if(how==="row"){\n                setr="none";setc="max-content auto";\n            }\n            // il peut y avoir plusieurs sujets, donc on doit faire un traitement multiple\n            let elts = document.querySelectorAll(".col"+dest);\n            for(let i=0;i<elts.length;i++){\n                elts[i].style["grid"] = setr+" / "+setc;\n            }\n        }\n        /*\n        * Change la disposition de toutes les lignes d'exercices\n        */\n        function setDispositionReponseAll(how){\n            let setr="auto auto",setc="none";\n            let selindex = 1;\n            if(how==="row"){\n                setr="none";setc="max-content auto";\n                selindex = 0;\n            }\n            // on sélectionne toutes colonnes\n            let elts = document.querySelectorAll(".ceinture .grid .grid");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style["grid"] = setr+" / "+setc;\n            }\n            // on met les valeurs des autres input à cette valeur\n            let inputs = document.querySelectorAll(".selectpos");\n            for(let i=0;i<inputs.length;i++){\n                inputs[i].selectedIndex = selindex;\n            }\n        }\n        /*\n        * Change la largeur des colonnes\n        */\n        function changeWidth(dest,nb){\n            let elts = document.querySelectorAll(".ceinture-content");\n            if(elts[0].style["grid-template-columns"].indexOf("auto")>-1){\n                for(let i=0;i<elts.length;i++){\n                    let stylecols = elts[i].style["grid-template-columns"].split(" ");\n                    let style = Array(stylecols.length).fill("1fr").join(" ");\n                    elts[i].style["grid-template-columns"] = style;\n                }\n            }\n            for(let i=0;i<elts.length;i++){\n                let style = elts[i].style["grid-template-columns"];\n                let stylecols = style.split(" ");\n                stylecols[dest-1] = nb+"fr";\n                style = stylecols.join(" ");\n                elts[i].style["grid-template-columns"] = style;\n            }\n        }\n        /*\n        * change la couleur du fond des réponses\n        * what : bg (background) || bd (border)\n        */\n       function changeColor(hexa,what){\n           let elts = document.querySelectorAll(".ans");\n           let styleAttr = "background-color";\n           let styleVal = hexa;\n           if(what==="bd"){\n                styleAttr="border";\n                if(hexa==="none")styleVal = "none";\n                else styleVal="1pt solid "+hexa;\n           }\n           for(let i=0;i<elts.length;i++){\n               elts[i].style[styleAttr] = styleVal;\n           }\n       }\n       function changeBorder(bool){\n        if(bool){\n            changeColor(document.getElementById("colorpicker2").value,'bd');\n        } else {\n            changeColor('none','bd');\n        }\n       }\n       `});this.docsheet.head.appendChild(script);let headnoprint=utils.create("section",{className:"noprint",id:"headnoprint"}),correction;headnoprint.innerHTML+='<span>Lignes :</span><input id="inputheight" value="20" title="Hauteur en pt" type="number" size="3" min="10" max="200" oninput="changeHeight(this.value)">',headnoprint.innerHTML+="<span>Texte</span>";for(let i=1;i<=nbcols;i++){let input=`<input id="fsize${i}" value="12" title="Taille énoncé colonne ${i}" type="number" size="3" min="8" max="16" step="0.5" oninput="changeFontSize('${i}',this.value)">`;headnoprint.innerHTML+=input}headnoprint.innerHTML+="<span>Largeur colonne</span>";for(let i=1;i<=nbcols;i++){let input=`<input id="asize${i}" value="1" title="Taille colonne ${i}" type="number" size="3" min="0.5" max="4" step="0.1" oninput="changeWidth(${i},this.value)">`;headnoprint.innerHTML+=input}headnoprint.appendChild(utils.create("br")),headnoprint.innerHTML+="<strong>Réponse</strong> ";for(let i=1;i<=nbcols;i++){let input=`<select class="selectpos" oninput="setDispositionReponse(${i},this.value)">\n            <option value="row">à côté</option>\n            <option value="column">dessous</option>\n            </select>`;headnoprint.innerHTML+=input}headnoprint.innerHTML+='<span>Tous</span> \n        <select oninput="setDispositionReponseAll(this.value)">\n            <option value="row">à côté</option>\n            <option value="column">dessous</option>\n            </select>',headnoprint.innerHTML+=' Coul <input type="color" id="colorpicker" oninput="changeColor(this.value,\'bg\')" value="#ECECEC"> Cadre avec <input type="checkbox" value="true" onclick="changeBorder(this.checked)"> <input type="color" value="#111111" id="colorpicker2" oninput="changeColor(this.value,\'bd\')" size="8">',this.content.appendChild(headnoprint),"fin"===posCorrection&&(correction=utils.create("div",{id:"correction",className:"pagebreak"}),correction.appendChild(utils.create("div",{innerHTML:"Correction"})));for(let qty=0;qty<nbCeintures;qty++){let ceinture=utils.create("div",{className:"ceinture"}),corrige=utils.create("div",{className:"ceintCorrige corrige"});this.generateQuestions();let header=utils.create("div",{className:"ceinture-header"}),bloc1=utils.create("div",{className:"border-black ceinture-titre",innerHTML:document.getElementById("ceinttitle").value||"Ceinture"}),bloc2=utils.create("div",{className:"border-black",innerHTML:"NOM :<br>Classe :"}),cleseed="";document.getElementById("ceintprintToEnonce").checked&&(cleseed="Clé : "+MM.seed+"<br> ");let bloc3=this.create("div",{className:"border-black",innerHTML:cleseed+"grille "+(qty+1)});header.appendChild(bloc1),header.appendChild(bloc2),header.appendChild(bloc3),ceinture.appendChild(header),cleseed=document.getElementById("ceintprintToCorrige").checked?"Clé : "+MM.seed+" / ":"",corrige.appendChild(utils.create("div",{innerHTML:(document.getElementById("ceinttitle").value||"Ceinture")+"<br>"+cleseed+"grille : "+(qty+1),className:"border-black"}));let colsid=0,stylecols=Array(nbcols).fill("auto").join(" "),stylerows=Array(nbrows).fill("auto").join(" ");const divColonnes=utils.create("div",{className:"ceinture-content grid",style:"grid-template-columns:"+stylecols+";grid-template-rows:"+(stylerows+1)});let divColsCorrige=utils.create("div",{className:"ceinture-corrige grid",style:"grid-template-columns:"+stylecols+";grid-template-rows:"+stylerows}),divCorr={},cols={},nbq=0;for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){if(nbq%nbrows==0){colsid++,cols[colsid]=[],divCorr[colsid]=[];let titre=document.getElementById("ceinttitlecol"+colsid).value;""!==titre&&cols[colsid].push(utils.create("div",{innerHTML:titre,className:"ceinture-titre-colonne border-black"}))}nbq++;let ligne=utils.create("div",{className:"grid border-black col"+colsid,style:"grid-column:"+colsid}),ligneCorr=utils.create("div",{className:"grid border-black"});if("latex"===activity.type||""===activity.type||void 0===activity.type){let divq=utils.create("div",{className:"question"+colsid+" quest"}),span=utils.create("span",{className:"math",innerHTML:activity.shortQuestions[j]||activity.questions[j]});divq.appendChild(span),ligne.appendChild(divq)}else ligne.appendChild(utils.create("div",{innerHTML:activity.shortQuestions[j]||activity.questions[j],className:"question"+colsid+" quest"}));let value=activity.values[j];Array.isArray(value)&&(value=value[0]);let spanc=utils.create("span",{className:"math",innerHTML:value});ligneCorr.appendChild(spanc),divCorr[colsid].push(ligneCorr);let divans=utils.create("div",{className:"bg-grey ans answer"+colsid,style:"height:20pt;"});if(ligne.appendChild(divans),cols[colsid].push(ligne),nbq%nbrows==0&&nbrows>0){let pied=document.getElementById("ceintpiedcol").value;""!==pied&&cols[colsid].push(utils.create("div",{innerHTML:pied,className:"ceinture-pied-colonne border-black"}))}}}for(let i=0;i<cols[1].length;i++)for(let j=1;j<=nbcols;j++)divColonnes.appendChild(cols[j][i]);ceinture.appendChild(divColonnes),this.content.appendChild(ceinture);for(let i=0;i<divCorr[1].length;i++)for(let j=1;j<=nbcols;j++)divColsCorrige.appendChild(divCorr[j][i]);corrige.appendChild(divColsCorrige),"fin"===posCorrection?correction.appendChild(corrige):this.content.appendChild(corrige)}"fin"===posCorrection&&this.content.appendChild(correction)}createFlashCards(){MM.memory={};let script=this.create("script",{text:'\n        function changeheight(nb){\n            let elts = document.querySelectorAll(".card");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.height = nb+"mm";\n            }\n        }\n        '});this.docsheet.head.appendChild(script);let aleaCode=this.create("div",{className:"floatright",innerHTML:"Clé : "+MM.seed});this.content.appendChild(aleaCode);let input='<input class="noprint fright" value="55" title="Taille cartes" type="number" size="3" min="30" max="180" oninput="changeheight(this.value)">';this.content.innerHTML+=input;let sheetTitle=document.getElementById("FCtitle").value||"Cartes Flash",header=this.create("header",{innerHTML:sheetTitle});this.content.appendChild(header);let sectionCartes=this.create("section",{className:"flash-section grid g2"});for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){let artQuestion=this.create("article",{className:"flash-question card"}),divq=this.create("div"),artCorrection=this.create("article",{className:"flash-reponse card"}),divr=this.create("div");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=this.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=this.create("span",{className:"math",innerHTML:activity.answers[j]});divq.appendChild(span),divr.appendChild(spanCorrection)}else divq.innerHTML=activity.questions[j],divr.innerHTML=activity.answers[j];artQuestion.appendChild(divq),artCorrection.appendChild(divr),sectionCartes.appendChild(artQuestion),void 0!==activity.figures[j]&&(0===i&&0===j&&(MM.memory.dest=this.wsheet),MM.memory["f"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),"f"+i+"-"+j,divq)),sectionCartes.appendChild(artCorrection)}}this.content.appendChild(sectionCartes),utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}createWhoGots(){MM.memory={};let script=this.create("script",{text:'\n        function changeheight(nb){\n            let elts = document.querySelectorAll(".whogot-carte");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.height = nb+"mm";\n            }\n        }\n        function changewidth(nb){\n            let elts = document.querySelectorAll(".whogot-carte");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.width = nb+"mm";\n            }\n        }\n        '}),WGquestion=document.getElementById("WGquestion").value?document.getElementById("WGquestion").value:"Qui a ?",WGaffirmation=document.getElementById("WGaffirmation").value?document.getElementById("WGaffirmation").value:"J'ai ...";this.docsheet.head.appendChild(script);let aleaCode=this.create("div",{className:"floatright",innerHTML:"Clé : "+MM.seed});this.content.appendChild(aleaCode);let input='<input class="noprint fright" value="55" title="Hauteur cartes" type="number" size="3" min="30" max="180" oninput="changeheight(this.value)">\n        <input class="noprint fright" value="55" title="Largeur cartes" type="number" size="3" min="30" max="180" oninput="changewidth(this.value)">';this.content.innerHTML+=input;let sheetTitle=document.getElementById("FCtitle").value||"J'ai / Qui a ?",header=this.create("header",{innerHTML:sheetTitle});this.content.appendChild(header);let sectionCartes=this.create("section",{className:"whogot-section"}),nbOfCards=0;for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){nbOfCards++;let carte=this.create("article",{className:"whogot-carte",id:"carte"+nbOfCards}),artQuestion=this.create("article",{className:"whogot-question",innerHTML:"<h3>"+WGquestion+"</h3>"}),divq=this.create("div");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=this.create("span",{className:"math",innerHTML:activity.questions[j]});divq.appendChild(span)}else divq.innerHTML=activity.questions[j];artQuestion.appendChild(divq),carte.appendChild(artQuestion),void 0!==activity.figures[j]&&(void 0===MM.memory.dest&&(MM.memory.dest=this.wsheet),MM.memory["f"+nbOfCards]=new Figure(utils.clone(activity.figures[j]),"f"+nbOfCards,divq)),sectionCartes.appendChild(carte)}}this.content.appendChild(sectionCartes);let numAnswer=1;for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){numAnswer++;let carte=this.docsheet.getElementById("carte"+(numAnswer>nbOfCards?1:numAnswer)),artCorrection=this.create("article",{className:"whogot-reponse",innerHTML:"<h3>"+WGaffirmation+"</h3"}),divr=this.create("div"),answer=activity.values[j];if(_.isArray(answer)&&(answer=answer[0]),"latex"===activity.type||""===activity.type||void 0===activity.type){let spanCorrection=this.create("span",{className:"math",innerHTML:answer});divr.appendChild(spanCorrection)}else divr.innerHTML="<span class='math'>"+answer+"</span>";artCorrection.appendChild(divr);let hr=this.create("hr");carte.prepend(hr),carte.prepend(artCorrection)}}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}createDominos(){MM.memory={};let script=this.create("script",{text:'\n        function changeheight(nb){\n            let elts = document.querySelectorAll(".dominos-carte");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.height = nb+"mm";\n            }\n        }\n        function changewidth(nb){\n            let elts = document.querySelectorAll(".dominos-carte");\n            for(let i=0;i<elts.length;i++){\n                elts[i].style.width = nb+"mm";\n            }\n        }\n        '});this.docsheet.head.appendChild(script);let aleaCode=this.create("div",{className:"floatright",innerHTML:"Clé : "+MM.seed});this.content.appendChild(aleaCode);let input='<div class="noprint fright">Largeur : \n        <input value="60" title="Largeur domino" type="number" size="3" min="60" max="180" oninput="changewidth(this.value)">\n        Hauteur :\n        <input value="25" title="Hauteur domino" type="number" size="3" min="25" max="180" oninput="changeheight(this.value)">\n        </div>';this.content.innerHTML+=input;let sheetTitle="<h1>Dominos</h1>",header=this.create("header",{innerHTML:sheetTitle});this.content.appendChild(header);let sectionCartes=this.create("section",{className:"dominos-section"}),nbOfCards=0;for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){nbOfCards++;let carte=this.create("article",{className:"dominos-carte",id:"domino"+nbOfCards}),hr=this.create("div",{className:"barrev",innerHTML:"&nbsp;"});carte.appendChild(hr);let artQuestion=this.create("article",{className:"dominos-question"}),divq=this.create("div");if("latex"===activity.type||""===activity.type||void 0===activity.type){let span=this.create("span",{className:"math",innerHTML:activity.questions[j]});divq.appendChild(span)}else divq.innerHTML=activity.questions[j];artQuestion.appendChild(divq),carte.appendChild(artQuestion),void 0!==activity.figures[j]&&(void 0===MM.memory.dest&&(MM.memory.dest=this.wsheet),MM.memory["f"+nbOfCards]=new Figure(utils.clone(activity.figures[j]),"f"+nbOfCards,divq)),sectionCartes.appendChild(carte)}}this.content.appendChild(sectionCartes);let numAnswer=1;for(let i=0;i<this.activities.length;i++){const activity=this.activities[i];for(let j=0;j<activity.questions.length;j++){numAnswer++;let carte=this.docsheet.getElementById("domino"+(numAnswer>nbOfCards?1:numAnswer)),artCorrection=this.create("article",{className:"dominos-reponse"}),divr=this.create("div"),answer=activity.values[j];if(_.isArray(answer)&&(answer=answer[0]),"latex"===activity.type||""===activity.type||void 0===activity.type){let spanCorrection=this.create("span",{className:"math",innerHTML:answer});divr.appendChild(spanCorrection)}else divr.innerHTML="<span class='math'>"+answer+"</span>";artCorrection.appendChild(divr),carte.prepend(artCorrection)}}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display(MM.memory.dest)}),300)}}var MM={version:5,content:void 0,introType:"321",endType:"nothing",touched:!1,selectedCart:0,seed:"",editedActivity:void 0,slidersOrientation:"",onlineState:"no",carts:[],steps:[],timers:[],figs:{},userAnswers:[],slidersNumber:1,faceToFace:"n",colorSelectors:[],colors:[],setEndType(value){this.endType=value},setIntroType(value){this.introType=value},setOnlineState(value){this.onlineState=value,document.querySelector("input[name='online'][value='"+value+"']").checked=!0},getOnlineState(){this.onlineState=utils.getRadioChecked("online")},editActivity:function(index){MM.editedActivity=MM.carts[MM.selectedCart].activities[index],MM.setTempo(MM.editedActivity.tempo),MM.setNbq(MM.editedActivity.nbq),MM.carts[MM.selectedCart].editedActivityId=index,MM.carts[MM.selectedCart].display(),MM.editedActivity.display(),document.getElementById("unlinkCart").className="",document.getElementById("addToCart").className="hidden",document.getElementById("removeFromCart").className=""},uneditActivity:function(){document.getElementById("addToCart").className="",document.getElementById("removeFromCart").className="hidden",document.getElementById("unlinkCart").className="hidden"},unlinkActivity:function(){this.uneditActivity(),MM.editedActivity=new activity(utils.clone(MM.editedActivity)),MM.editedActivity.display(),MM.carts[MM.selectedCart].editedActivityId=-1,MM.carts[MM.selectedCart].display()},changeSizeText(value,obj=!1){10===value&&obj&&(obj.value=10);const elts=document.querySelectorAll("#slideshow .slide");elts.forEach(elt=>elt.style.fontSize=math.round(Number(value)/10,1)+"em")},setTempo:function(value){document.getElementById("tempo-slider").value=value,document.getElementById("tempo-value").innerHTML=value+" s."},setNbq:function(value){document.getElementById("nbq-slider").value=value,document.getElementById("nbq-value").innerHTML=value},resetCarts:function(){let Cart=new cart(0);MM.carts=[Cart],MM.setMinimalDisposition(0),MM.steps=[],MM.timers=[],MM.figs={},MM.resetInterface()},resetInterface(){document.getElementById("divcarts").className="hidden",document.getElementById("phantom").className="",document.getElementById("divparams").className="col-2 row-3",utils.checkRadio("direction",MM.slidersOrientation),utils.checkRadio("beforeSlider",MM.introType),utils.checkRadio("endOfSlideRadio",MM.endType),utils.checkRadio("online",MM.onlineState),utils.checkRadio("facetoface",MM.faceToFace),utils.checkRadio("Enonces",MM.slidersNumber)},showCartInterface(){document.getElementById("divcarts").className="row-4",document.getElementById("phantom").className="hidden",document.getElementById("divparams").className="row-3"},addCart:function(){this.uneditActivity();let cartsNb=MM.carts.length+1;if(cartsNb>4)return!1;MM.carts[cartsNb-1]=new cart(cartsNb-1),MM.setMinimalDisposition(cartsNb-1);let button=document.createElement("button");button.value=cartsNb,button.className="tabs-menu-link",button.innerHTML='<img src="img/cart'+cartsNb+'.png">',button.id="button-cart"+cartsNb,button.onclick=function(elt){let value="";value="img"===elt.target.nodeName.toLowerCase()?elt.target.parentNode.value:elt.target.value,MM.showCart(value)};let addcart=document.getElementById("addcart"),cartsMenu=document.getElementById("cartsMenu"),lastButton=cartsMenu.removeChild(addcart);cartsMenu.appendChild(button).click(),cartsNb<4&&cartsMenu.appendChild(lastButton)},getCartsContent:function(){let div=utils.create("div",{style:"display:flex;"});for(let i=0;i<MM.carts.length;i++){let ul=utils.create("ul",{innerHTML:"<span class='bold'>"+MM.carts[i].title+"</span>"}),acts=MM.carts[i].activities;for(let j=0;j<acts.length;j++){let li=utils.create("li",{innerText:acts[j].title});ul.appendChild(li)}div.appendChild(ul)}return div},restoreCartsInterface:function(){let cartsMenu=document.getElementById("cartsMenu");cartsMenu.innerHTML='<button onclick="MM.showCart(this.value);" class="tabs-menu-link is-active" value="1" id="button-cart1"><img src="img/cart1.png"></button>\n        <button id="addcart" title="Ajouter un panier" onclick="MM.addCart();"><img src="img/cartadd.png"></button>';for(let i=1;i<this.carts.length;i++){let btnnb=i+1,button=utils.create("button",{value:btnnb,className:"tab-menu-link",innerHTML:'<img src="img/cart'+btnnb+'.png">',id:"button-cart"+btnnb});button.onclick=function(elt){let value="";value="img"===elt.target.nodeName.toLowerCase()?elt.target.parentNode.value:elt.target.value,MM.showCart(value)};let addcart=document.getElementById("addcart"),lastButton=cartsMenu.removeChild(addcart);cartsMenu.appendChild(button),btnnb<4&&cartsMenu.appendChild(lastButton)}},removeCart:function(index){if(!window.confirm("Vous êtes sur le point de supprimer ce panier.\nConfirmez-vous ?"))return!1;let buttonCartToremove=document.getElementById("button-cart"+MM.carts.length),cartsMenu=document.getElementById("cartsMenu");if(cartsMenu.removeChild(buttonCartToremove),!document.getElementById("addcart")){let buttonAddCart=document.createElement("button");buttonAddCart.id="addcart",buttonAddCart.innerHTML='<img src="img/cartadd.png">',buttonAddCart.onclick=function(){MM.addCart()},cartsMenu.appendChild(buttonAddCart)}MM.carts.splice(index-1,1),MM.setMinimalDisposition(MM.carts.length-1),MM.showCart(1)},showCart(index){this.uneditActivity(),index=Number(index),MM.selectedCart=index-1;for(let i=1,nb=MM.carts.length,btn;i<=4;i++){i<=nb&&(btn=document.getElementById("button-cart"+i));let div=document.getElementById("cart"+(i-1));i!==index?(div.className="hidden",i<=nb&&utils.removeClass(btn,"is-active")):(div.className="cartcontent",i<=nb&&utils.addClass(btn,"is-active"))}MM.carts[MM.selectedCart].editedActivityId>-1&&(MM.carts[MM.selectedCart].activities[MM.carts[MM.selectedCart].editedActivityId].display(),this.editActivity(MM.carts[MM.selectedCart].editedActivityId))},emptyCart(index){if(!window.confirm("Vous êtes sur le point de vider ce panier.\nConfirmez-vous ?"))return!1;MM.carts[index-1].activities=[],MM.carts[index-1].editedActivityId=-1,MM.carts[index-1].display()},addToCart(){MM.carts[MM.selectedCart].addActivity(MM.editedActivity),MM.showCartInterface()},removeFromCart(){let cart=MM.carts[MM.selectedCart];cart.removeActivity(cart.editedActivityId),cart.editedActivityId=-1,document.getElementById("addToCart").className="",document.getElementById("removeFromCart").className="hidden"},checkLoadedCarts(start=!1){let loaded=!0;for(const panier of this.carts)panier.loaded||(loaded=!1);if(loaded)if(start)MM.start();else{let message='Tu as suivi un lien d\'activité préconfigurée MathsMentales.<br>Clique ci-dessous pour démarrer.<br><br><button class="button--primary" onclick="utils.closeMessage(\'messageinfo\');MM.start()"> Démarrer le diaporama </button>';1===MM.carts.length&&"null"===sound.selected&&(message+='<br><br><button class="button--info" onclick="sound.next();">Avec du son</button>'),1===MM.carts.length&&1===MM.carts[0].target.length&&(message+="<br><br> ou <button class=\"button--success\" onclick=\"utils.closeMessage('messageinfo');MM.setOnlineState('yes');MM.start()\"> Commencer (interactif)</button>");let alert=utils.create("div",{id:"messageinfo",className:"message",innerHTML:message});document.getElementById("tab-accueil").appendChild(alert)}else{let messageinfo=document.getElementById("messageinfo");null!==messageinfo&&(messageinfo.innerHTML+="<br><br>Le chargement n'est pas encore terminé. Patience...")}},populateQuestionsAndAnswers(withAnswer){void 0===withAnswer&&(withAnswer=!0),MM.figs={},MM.steps=[],MM.timers=[],MM.memory={};let length=MM.carts.length,enonces=document.getElementById("enonce-content"),corriges=document.getElementById("corrige-content");length>1&&(enonces.className="grid-"+length,corriges.className="grid-"+length),enonces.innerHTML="",corriges.innerHTML="",utils.setSeed(),MM.copyURLtoHistory();for(let i=0;i<length;i++){MM.carts[i].actsArrays=[];for(let kk=0,clen=MM.carts[i].target.length;kk<clen;kk++){let indiceSlide=0,slideNumber=MM.carts[i].target[kk]-1,slider=document.getElementById("slider"+slideNumber);void 0!==MM.colors[slideNumber]&&(slider.style.background=MM.colors[slideNumber]);let addTitle="";clen>1&&(addTitle="-"+(kk+1));let titleSlider=MM.carts[i].title+addTitle;document.querySelector("#slider"+slideNumber+" .slider-title").innerHTML=titleSlider;let sliderSteps=document.querySelector("#slider"+slideNumber+" .steps-container"),dive=utils.create("div",{id:"de"+i+"-"+kk}),divc=utils.create("div",{id:"dc"+i+"-"+kk});MM.zooms["zc"+i+"-"+kk]=new Zoom("zc"+i+"-"+kk,"#dc"+i+"-"+kk+" ol"),MM.zooms["ze"+i+"-"+kk]=new Zoom("ze"+i+"-"+kk,"#de"+i+"-"+kk+" ol"),dive.appendChild(MM.zooms["ze"+i+"-"+kk].createCursor()),divc.appendChild(MM.zooms["zc"+i+"-"+kk].createCursor());let h3e=utils.create("h3",{innerText:titleSlider}),h3c=utils.create("h3",{innerText:titleSlider});dive.append(h3e),divc.append(h3c);let ole=utils.create("ol"),olc=utils.create("ol");MM.steps[slideNumber]=new steps({size:0,container:sliderSteps}),MM.timers[slideNumber]=new timer(slideNumber);let actsArray=[];for(let z=0,alen=MM.carts[i].activities.length;z<alen;z++){let activity=MM.carts[i].activities[z];activity.generate(),MM.steps[slideNumber].addSize(activity.nbq);for(let j=0;j<activity.questions.length;j++)actsArray.push([z,j])}MM.carts[i].ordered||(actsArray=_.shuffle(actsArray)),MM.carts[i].actsArrays[kk]=actsArray;for(let ff=0;ff<actsArray.length;ff++){let activity=MM.carts[i].activities[actsArray[ff][0]],j=actsArray[ff][1],question=activity.questions[j],answer=activity.answers[j],color=ff%2?" pair":" impair",div=utils.create("div",{className:"slide w3-animate-top"+(indiceSlide>0?" hidden":"")+color,id:"slide"+slideNumber+"-"+indiceSlide}),span=utils.create("span",{innerHTML:question}),spanAns=utils.create("span",{className:"answerInSlide hidden",innerHTML:answer});MM.timers[slideNumber].addDuration(activity.tempo);let lie=utils.create("li",{innerHTML:question}),lic=document.createElement("li");void 0!==activity.type&&""!==activity.type&&"latex"!==activity.type||(lie.className="math",lic.className="math",span.className="math",spanAns.className+=" math"),div.appendChild(span),"yes"!==MM.onlineState&&div.appendChild(spanAns),slider.appendChild(div),lic.innerHTML+=answer,void 0!==activity.figures[j]&&(lic.innerHTML+="<button onclick=\"MM.memory['c"+slideNumber+"-"+indiceSlide+"'].toggle()\">Figure</button>",MM.figs[slideNumber+"-"+indiceSlide]=new Figure(utils.clone(activity.figures[j]),"c"+slideNumber+"-"+indiceSlide,div),MM.memory["e"+slideNumber+"-"+indiceSlide]=new Figure(utils.clone(activity.figures[j]),"en"+slideNumber+"-"+indiceSlide,lie,[300,150]),MM.memory["c"+slideNumber+"-"+indiceSlide]=new Figure(utils.clone(activity.figures[j]),"cor"+slideNumber+"-"+indiceSlide,lic,[450,225])),ole.appendChild(lie),olc.appendChild(lic),indiceSlide++}dive.append(ole),divc.append(olc),enonces.append(dive),corriges.append(divc),MM.steps[slideNumber].display(),utils.isEmpty(MM.figs)||setTimeout((function(){for(let j=0;j<indiceSlide;j++)void 0!==MM.memory["e"+slideNumber+"-"+j]&&MM.memory["e"+slideNumber+"-"+j].display()}))}}utils.mathRender()},createUserInputs:function(){MM.mf={};for(let slider=0,len=MM.carts[0].target.length;slider<len;slider++)for(let slide=0,len2=MM.carts[0].actsArrays[slider].length;slide<len2;slide++){const MFTARGET=document.getElementById("slider"+slider),element=document.getElementById("slide"+slider+"-"+slide),ID="ansInput"+slider+"-"+slide;MM.mf[ID]=new MathfieldElement({smartMode:!0,virtualKeyboardMode:"manual",virtualKeyboards:"numeric",fontsDirectory:"../katex/fonts",virtualKeyboardContainer:MFTARGET,virtualKeyboardTheme:"material"}),MM.mf[ID].id=ID,MM.mf[ID].target=element,MM.mf[ID].addEventListener("keyup",(function(event){"Enter"!==event.key&&9!==event.keyCode||(MM.nextSlide(0),event.preventDefault())})),element.appendChild(MM.mf[ID]),element.appendChild(utils.create("div",{style:"height:270px;"})),MM.mf[ID].addEventListener("virtual-keyboard-toggle",evt=>{console.log(evt)})}},setFacetoFace(etat){this.faceToFace=etat,"y"===etat?(utils.addClass(document.getElementById("sddiv1"),"return"),MM.slidersNumber>2&&utils.addClass(document.getElementById("sddiv2"),"return")):(utils.removeClass(document.getElementById("sddiv1"),"return"),utils.removeClass(document.getElementById("sddiv2"),"return"))},getFacetoFace(){this.faceToFace=utils.getRadioChecked("facetoface")},createExercicesSheet:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.fiche=new ficheToPrint("exo",MM.carts[0])},createExamSheet:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.fiche=new ficheToPrint("exam",MM.carts[0])},createCeintureSheet:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity);let nbq=0;for(let i=0;i<MM.carts[0].activities.length;i++)nbq+=Number(MM.carts[0].activities[i].nbq);let nbqc=Number(document.getElementById("ceintcolsval").value)*Number(document.getElementById("ceintrowsval").value);nbq<nbqc?alert("Pas assez de questions dans le panier pour alimenter la ceinture\nde "+document.getElementById("ceintcolsval").value+"×"+document.getElementById("ceintrowsval").value+"="+nbqc+" emplacements"):nbq>nbqc&&!confirm("Vous allez créé une ceinture de "+nbqc+" emplacements\nalors que vous avez créé un panier de"+nbq+"questions.\nToutes ne seront donc pas imprimées. Continuer ?")||(MM.fiche=new ficheToPrint("ceinture",MM.carts[0],utils.getRadioChecked("ceintorientation")))},createFlashCards:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.fiche=new ficheToPrint("flashcard",MM.carts[0])},createWhoGots:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.fiche=new ficheToPrint("whogots",MM.carts[0])},createDominos:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.fiche=new ficheToPrint("dominos",MM.carts[0])},start:function(){if(MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.getOnlineState(),"yes"===MM.onlineState&&(MM.userAnswers=[],MM.carts.length>1))for(let i=1,len=MM.carts.length;i<len;i++)delete MM.carts[i];utils.showTab("none"),MM.checkIntro(),MM.createSlideShows(),MM.populateQuestionsAndAnswers(),"321"===MM.introType?(document.getElementById("countdown-container").className="",setTimeout((function(){document.getElementById("countdown-container").className="hidden","yes"===MM.onlineState&&MM.createUserInputs(),MM.showSlideShows(),MM.startTimers()}),3600)):"example"===MM.introType?(MM.showSampleQuestion(),MM.showSlideShows()):("yes"===MM.onlineState&&MM.createUserInputs(),MM.showSlideShows(),MM.startTimers())},paramsToURL(withAleaSeed=!1){let colors=MM.colors.join("~").replace(/\,/g,"_");return"i="+MM.introType+",e="+MM.endType+",o="+MM.onlineState+",s="+MM.slidersNumber+",so="+MM.slidersOrientation+",f="+MM.faceToFace+",a="+(withAleaSeed?MM.seed:"")+",colors="+colors+",snd="+sound.selected+this.export()},copyURL(){let modalMessage=utils.create("div",{id:"urlCopy",className:"message",style:"padding:1.5rem",innerHTML:'<div>Adresse longue<div>\n                <textarea readonly="true" id="bigurl" cols="38" onfocus="utils.copy(this);"></textarea><br>\n                <button onclick="MM.getQR();">Raccourcir l\'url</button><br>\n                <input readonly="true" type="url" id="shorturl" size="38" onfocus="utils.copy(this)">\n                <div id="shortQRdiv"></div>\n                '}),withSeed=!1;document.getElementById("aleaInURL").checked&&(withSeed=!0);let params=this.paramsToURL(withSeed),close=utils.create("button",{innerHTML:"<img src='img/closebutton32.png'>",style:"position:absolute;top:0.5rem;right:0.5rem;padding:0;background:transparent"});close.onclick=()=>{let m=document.getElementById("urlCopy");m.parentNode.removeChild(m)},modalMessage.appendChild(close),document.getElementById("colparameters").appendChild(modalMessage);let input=document.getElementById("bigurl");input.value=this.setURL(params),input.className="",input.select(),input.setSelectionRange(0,99999),document.execCommand("copy")},copyURLtoHistory(){let withSeed=!0,params=this.paramsToURL(!0),url=this.setURL(params),paramsSansSeed=this.paramsToURL(!1),urlSansSeed=this.setURL(paramsSansSeed),li=utils.create("li"),span=utils.create("span",{innerText:"Panier du "+utils.getDate()+": ",className:"bold"});li.appendChild(span);const a=utils.create("a",{href:url,innerText:"🎯 lien (mêmes données)"});li.appendChild(a);const a2=utils.create("a",{href:urlSansSeed,innerText:"🎯 lien (autres données)"});li.appendChild(a2);let button=`\n        <span class="pointer underline" data-url="${url}" onclick="utils.checkURL(this.dataset['url'],false,true)">\n            🛠 éditer\n        </span>\n        <span class="pointer underline" onclick="MM.removeFromHistory(this.parentNode)">❌ Supprimer</span>\n        `;li.innerHTML+=button,li.appendChild(this.getCartsContent());let lis=document.querySelectorAll("#tab-historique span[data-url='"+url+"']");for(let k=0;k<lis.length;k++){let parent=lis[k].parentNode;document.querySelector("#tab-historique ol").removeChild(parent)}document.querySelector("#tab-historique ol").prepend(li),window.localStorage&&localStorage.setItem("history",document.querySelector("#tab-historique ol").innerHTML)},removeFromHistory(elem){if(!confirm("Supprimer cet élément : \n"+elem.childNodes[0].innerText+" ?"))return!1;document.querySelector("#tab-historique ol").removeChild(elem),window.localStorage&&localStorage.setItem("history",document.querySelector("#tab-historique ol").innerHTML)},removeSelectionFromHistory(){const CHECKED=document.querySelectorAll("#tab-historique input[class='checkhistoric']:checked");for(let i=CHECKED.length-1;i>=0;i--){let parent=CHECKED[i].parentNode;parent.parentNode.removeChild(parent)}window.localStorage&&(this.createSelectHistory(),localStorage.setItem("history",document.querySelector("#tab-historique ol").innerHTML),this.createSelectHistory())},createSelectHistory(){if(this.historySelectCreated)this.destroySelectHistory(),document.getElementById("actionsSelectHist").className="hidden";else{this.historySelectCreated=!0;const LISTE=document.querySelectorAll("#tab-historique > ol > li");for(let i=0;i<LISTE.length;i++){let input=utils.create("input",{type:"checkbox",value:i,selected:!1,className:"checkhistoric"});LISTE[i].prepend(input)}document.getElementById("actionsSelectHist").className=""}},destroySelectHistory(){this.historySelectCreated=!1;const LISTE=document.querySelectorAll("#tab-historique > ol > li > input");for(let i=0;i<LISTE.length;i++)LISTE[i].parentNode.removeChild(LISTE[i])},emptyHistory(){if(!confirm("Confirmez-vous la suppression de tout l'historique ?"))return!1;document.querySelector("#tab-historique ol").innerHTML="",window.localStorage&&localStorage.setItem("history","")},generatePage(){window.alert("Fonctionalité en cours de développement.")},generateCode(){window.alert("Fonctionnalité en cours de développement")},getQR(){MM.carts.length<2&&MM.carts[0].activities.length<2&&(MM.carts[0].activities=[],MM.carts[0].addActivity(MM.editedActivity));let withSeed=!1;document.getElementById("aleaInURL").checked&&(withSeed=!0);let params=this.paramsToURL(withSeed),url=this.setURL(params),alert=document.getElementById("shortQRdiv");alert.innerHTML="";let div=utils.create("div",{className:"lds-ellipsis",innerHTML:"<div></div><div></div><div></div><div></div>"}),div2=utils.create("div",{innerHTML:"Génération en cours"});alert.appendChild(div),alert.appendChild(div2);let shorter=new XMLHttpRequest;shorter.onload=function(){alert.removeChild(div),alert.removeChild(div2);let shorturl=shorter.responseText;if(0!==shorturl.indexOf("http:"))return void alert.appendChild(utils.create("h2",{innertext:"Problème de récupération de l'url courte"}));alert.appendChild(utils.create("h2",{innerText:"QRcode de l'exercice"}));let qrdest=utils.create("img",{id:"qrious",title:"Clic droit pour copier l'image"});alert.appendChild(qrdest);let inputShortUrl=document.getElementById("shorturl");inputShortUrl.value=shorturl,inputShortUrl.select(),inputShortUrl.setSelectionRange(0,99999),document.execCommand("copy");let QR=new QRious({element:qrdest,value:shorturl,size:200,padding:12})},shorter.open("get","getshort.php?url="+encodeURIComponent(url)),shorter.send()},export(){let urlString="";MM.carts[0].activities.length<2&&1===MM.carts.length&&(MM.carts[0].activities=[],MM.carts[0].addActivity(MM.editedActivity)),MM.checkIntro(),utils.setSeed();for(let i=0;i<this.carts.length;i++)urlString+=this.carts[i].export();return urlString},setURL:string=>utils.baseURL+"index.html?"+string,checkIntro:function(){MM.introType=utils.getRadioChecked("beforeSlider"),MM.endType=utils.getRadioChecked("endOfSlideRadio")},startTimers:function(){"yes"!==MM.onlineState||MM.touched||document.getElementById("ansInput0-0").focus();for(let i=0,k=MM.timers.length;i<k;i++)MM.timers[i].start(0)},showSampleQuestion:function(){let nb=MM.slidersNumber;utils.setSeed("sample");let container=document.getElementById("slideshow"),assocSliderActivity=[];for(let i=0,len=MM.carts.length;i<len;i++){MM.carts[i].activities[0].generateSample();for(let j=0;j<MM.carts[i].target.length;j++)assocSliderActivity[MM.carts[i].target[j]-1]=i}let divSample=utils.create("div",{id:"sampleLayer",className:"sample"});for(let i=0;i<nb;i++){let div=utils.create("div",{id:"sample"+i});div.className=1===nb?"slider-1":2===nb?"slider-2":"slider-34";let nextActivity="";MM.carts[assocSliderActivity[i]].activities.length>1&&(nextActivity=`<button title="Activité suivante du panier" data-actid="0" onclick="MM.newSample(${i},true)" id="ButtonNextAct${i}"><img src="img/slider-next.png"></button>`),div.innerHTML=`Exemple <div class="slider-nav">\n            <button title="Annoter l'exemple" id="btn-sample-annotate${i}" onclick="utils.annotate('sampleSlide${i}',this.id);"><img src="img/iconfinder_pencil_1055013.png"></button>\n            <button title="Montrer la réponse" onclick="MM.showSampleAnswer(${i});"><img src="img/slider-solution.png"></button>\n            <button title="Autre exemple" onclick="MM.newSample(${i});"><img src="img/newsample.png"></button>\n            ${nextActivity}\n            <button title="Démarrer le diaporama" onclick="MM.startSlideShow(${i});"><img src="img/fusee.png"></button>\n            </div>`;let divContent=utils.create("div",{className:"slide",id:"sampleSlide"+i}),span=utils.create("span",{id:"sample"+i+"-enonce"}),spanAnswer=utils.create("span",{id:"sample"+i+"-corr",className:"hidden"});divContent.appendChild(span),divContent.appendChild(spanAnswer),div.appendChild(divContent),divSample.appendChild(div)}container.appendChild(divSample);for(let i=0;i<MM.carts.length;i++)for(let y=0;y<MM.carts[i].target.length;y++){let sN=MM.carts[i].target[y]-1,act=MM.carts[i].activities[0];if(document.getElementById("sample"+sN+"-enonce").innerHTML=act.sample.question,document.getElementById("sample"+sN+"-corr").innerHTML=act.sample.answer,void 0!==act.type&&""!==act.type&&"latex"!==act.type||(document.getElementById("sample"+sN+"-enonce").className="math",document.getElementById("sample"+sN+"-corr").className+=" math"),void 0!==act.sample.figure){let fig=new Figure(utils.clone(act.sample.figure),"sample-c"+sN,document.getElementById("sampleSlide"+sN));setTimeout((function(){fig.display()}),100)}}utils.mathRender()},showQuestions:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.createSlideShows(),MM.populateQuestionsAndAnswers(),utils.showTab(document.querySelector("[numero='#tab-enonce'].tabs-menu-link")),1===MM.carts.length&&1===MM.carts[0].activities.length&&(MM.resetCarts(),MM.editedActivity.display())},showAnswers:function(){MM.carts[0].activities.length||MM.carts[0].addActivity(MM.editedActivity),MM.createSlideShows(),MM.populateQuestionsAndAnswers(),utils.showTab(document.querySelector("[numero='#tab-corrige'].tabs-menu-link")),1===MM.carts.length&&1===MM.carts[0].activities.length&&(MM.resetCarts(),MM.editedActivity.display())},createSlideShows:function(){if(MM.zooms={},isNaN(MM.slidersNumber)){let nb=0;for(let i=0;i<MM.carts.length;i++)nb+=MM.carts[i].target.length;nb<5&&(MM.slidersNumber=nb)}let nb=MM.slidersNumber,container=document.getElementById("slideshow");container.innerHTML="","v"===MM.slidersOrientation?container.className="hidden vertical":container.className="hidden";for(let i=0;i<nb;i++){let div=document.createElement("div");div.id="slider"+i,div.className=1===nb?"slider-1":2===nb?"slider-2":"slider-34",nb>1&&"y"===MM.faceToFace&&0===i?div.className+=" return":nb>2&&"y"===MM.faceToFace&&1===i&&(div.className+=" return");let innerH=`<div class="slider-head"><div class="slider-nav">\n            <button title="Arrêter le diaporama" onclick="MM.timers[${i}].end()"><img src="img/slider-stop.png" /></button>`;"no"===MM.onlineState&&(innerH+=`<button title="Mettre le diapo en pause" onclick="MM.timers[${i}].pause()"><img src="img/slider-pause.png" /></button>\n                <button title="Montrer la réponse" onclick="MM.showTheAnswer(${i});"><img src="img/slider-solution.png" /></button>`),innerH+=`<button title="Passer la diapo" onclick="MM.nextSlide(${i});"><img src="img/slider-next.png" /></button>\n            </div>\n            <div class="slider-title"></div>\n            <div class="slider-chrono"><progress class="progress is-link is-large" value="0" max="100"></progress></div>\n            <div id="zs${i}" class="zoom">\n                <span class="zoom-a0">A</span>\n                <input type="range" min="6" max="60" step="2" value="10" oninput="MM.zooms['zs${i}'].changeSize(this.value)" ondblclick="MM.zooms['zs${i}'].changeSize(10)">\n                <span class="zoom-A1">A</span>\n            </div></div>\n            <div class="steps-container"></div>`,div.innerHTML=innerH,container.appendChild(div),MM.zooms["zs"+i]=new Zoom("zs"+i,"#slider"+i+" .slide")}},showSlideShows:function(){utils.removeClass(document.getElementById("slideshow-container"),"hidden"),utils.addClass(document.getElementById("app-container"),"hidden"),utils.isEmpty(MM.figs)||MM.displayFirstFigs()},displayFirstFigs:function(){for(let i=0;i<4;i++)"object"==typeof MM.figs[i+"-0"]&&MM.figs[i+"-0"].display()},hideSlideshows:function(){utils.addClass(document.getElementById("slideshow-container"),"hidden"),utils.removeClass(document.getElementById("app-container"),"hidden");let whatToDo=utils.getRadioChecked("endOfSlideRadio");if("yes"===MM.onlineState){let alert=utils.create("div",{id:"messagefin",className:"message",innerHTML:"L'activité MathsMentales est terminée.<br>Pour consulter les résultats, cliquer sur le bouton ci-dessous.<br><br>\n            <button onclick=\"utils.closeMessage('messagefin');utils.showTab('tab-corrige');\"> Voir le corrigé \n            </button>"});document.body.appendChild(alert)}else"correction"===whatToDo?utils.showTab("tab-corrige"):"list"===whatToDo&&utils.showTab("tab-enonce")},showTheAnswer(id){let answerToShow=document.querySelector("#slide"+id+"-"+MM.steps[id].step+" .answerInSlide");answerToShow&&(answerToShow.className.indexOf("hidden")>-1?(MM.timers[id].pause(),utils.removeClass(answerToShow,"hidden")):(utils.addClass(answerToShow,"hidden"),MM.timers[id].start()))},showSampleAnswer(id){let answerToShow=document.getElementById("sample"+id+"-corr");answerToShow.className.indexOf("hidden")>-1?utils.removeClass(answerToShow,"hidden"):utils.addClass(answerToShow,"hidden")},newSample(id,next=!1){for(let i=0,len=MM.carts.length;i<len;i++)if(MM.carts[i].target.indexOf(id+1)>-1){let nbActivities=MM.carts[i].activities.length,actId=0;MM.carts[i].activities.length>1&&(actId=document.getElementById("ButtonNextAct"+id).dataset.actid,next&&(actId++,actId>=nbActivities&&(actId=0),document.getElementById("ButtonNextAct"+id).dataset.actid=actId));let act=MM.carts[i].activities[actId];if(act.generateSample(),document.getElementById("sample"+id+"-enonce").innerHTML=act.sample.question,document.getElementById("sample"+id+"-corr").innerHTML=act.sample.answer,void 0!==act.type&&""!==act.type&&"latex"!==act.type||(document.getElementById("sample"+id+"-enonce").className="math",document.getElementById("sample"+id+"-corr").className+=" math"),void 0!==act.sample.figure){let item;item="chart"===act.sample.figure.type?document.getElementById("div-dest-canvas-sample-c"+id):document.getElementById("sample-c"+id),item.parentNode.removeChild(item);let fig=new Figure(utils.clone(act.sample.figure),"sample-c"+id,document.getElementById("sampleSlide"+id));setTimeout((function(){fig.display()}),100)}utils.mathRender()}},removeSample(){let item=document.getElementById("sampleLayer");item.parentNode.removeChild(item)},startSlideShow(){MM.removeSample(),"yes"===MM.onlineState&&MM.createUserInputs(),"yes"!==MM.onlineState||MM.touched||document.getElementById("ansInput0-0").focus(),MM.startTimers()},nextSlide:function(id){"yes"===MM.onlineState&&(MM.userAnswers[MM.steps[id].step]=MM.mf["ansInput"+id+"-"+MM.steps[id].step].value);let step=MM.steps[id].nextStep();if(!1===step)return MM.timers[id].end(),!1;1===MM.carts.length&&sound.play(),MM.timers[id].start(step);let slidetoHide=document.querySelector("#slide"+id+"-"+(step-1)),slide=document.querySelector("#slide"+id+"-"+step);utils.addClass(slidetoHide,"hidden"),slide&&(utils.removeClass(slide,"hidden"),void 0!==MM.figs[id+"-"+step]&&MM.figs[id+"-"+step].display(),"yes"!==MM.onlineState||MM.touched?"yes"===MM.onlineState&&MM.touched&&(MM.mf["ansInput"+id+"-"+step].setOptions({virtualKeyboardMode:"onfocus"}),MM.mf["ansInput"+id+"-"+step].focus()):MM.mf["ansInput"+id+"-"+step].focus())},messageEndSlide:function(id,nth){let sliderMessage;document.querySelectorAll("#slider"+id+" .slide")[nth].innerHTML="<span>Fin du diaporama</span>"},endSliders:function(){let ended=!0;for(let i=0,l=MM.timers.length;i<l;i++)!1===MM.timers[i].ended&&(ended=!1);if(ended){if(MM.hideSlideshows(),"yes"===MM.onlineState){let score=0,div=document.createElement("div"),ol=document.createElement("ol");ol.innerHTML="<b>Tes réponses</b>";let ia=0;for(let slider=0,len=MM.carts[0].actsArrays.length;slider<len;slider++)for(let slide=0,len2=MM.carts[0].actsArrays[slider].length;slide<len2;slide++){let refs=MM.carts[0].actsArrays[slider][slide],li=document.createElement("li"),span=document.createElement("span"),userAnswer=MM.userAnswers[ia].replace(",",".").trim();0===userAnswer.indexOf("\\text")&&(userAnswer=userAnswer.substring(6,userAnswer.length-1)),userAnswer=userAnswer.replace("\\text{ }"," ");const expectedAnswer=MM.carts[0].activities[refs[0]].values[refs[1]];if(Array.isArray(expectedAnswer))for(let i=0;i<expectedAnswer.length;i++){if(String(userAnswer).toLowerCase()==String(expectedAnswer[i]).toLowerCase()){li.className="good",score++;break}{const expr1=KAS.parse(expectedAnswer[i]).expr,expr2=KAS.parse(String(userAnswer).replace("²","^2")).expr;try{if(KAS.compare(expr1,expr2,{form:!0,simplify:!1}).equal){li.className="good",score++;break}li.className="wrong"}catch(error){li.className="wrong"}}}else if(String(userAnswer).toLowerCase()==String(expectedAnswer).toLowerCase())li.className="good",score++;else{const expr1=KAS.parse(expectedAnswer).expr,expr2=KAS.parse(String(userAnswer).replace("²","^2")).expr;try{KAS.compare(expr1,expr2,{form:!0,simplify:!1}).equal?(li.className="good",score++):li.className="wrong"}catch(error){li.className="wrong"}}/[^-\d\.]/.test(userAnswer)&&!/\\/.test(userAnswer)||(span.className="math",userAnswer="\\displaystyle "+userAnswer),span.textContent=userAnswer,ia++,li.appendChild(span),ol.appendChild(li)}div.appendChild(ol);let section=document.createElement("section");section.innerHTML="<b>Score :</b> "+score+"/"+ia,div.appendChild(section),document.getElementById("corrige-content").appendChild(div),utils.mathRender()}1===MM.carts.length&&1===MM.carts[0].activities.length&&(MM.resetCarts(),MM.editedActivity.display())}},pauseAllSliders(){for(let i=0,l=MM.timers.length;i<l;i++)MM.timers[i].pause()},stopAllSliders:function(){for(let i=0,l=MM.timers.length;i<l;i++)MM.timers[i].end()},nextAllSliders:function(){for(let i=0,l=MM.steps.length;i<l;i++)MM.nextSlide(i)},setMinimalDisposition:function(index){let radios=document.querySelectorAll("input[name='Enonces']");for(let i=0,l=radios.length;i<l;i++)radios[i].disabled=i<index,i===index&&MM.slidersNumber<=index+1&&(radios[i].checked=!0,MM.setDispositionEnonce(index+1))},setDispositionEnonce:function(value){if(value=Number(value),MM.slidersNumber=value,document.getElementById("facetofaceOption").className="",1===value)document.getElementById("sddiv1").className="sddiv1",document.getElementById("sddiv2").className="hidden",document.getElementById("sddiv3").className="hidden",document.getElementById("sddiv4").className="hidden",document.getElementById("divisionsOption").className="hidden",document.getElementById("onlinechoice").className="",MM.setDispositionDoubleEnonce("h"),MM.carts[0].target=[1],document.getElementById("facetofaceOption").className="hidden";else if(2===value){let directions;document.querySelectorAll("input[name='direction']")[0].checked?MM.setDispositionDoubleEnonce("h"):MM.setDispositionDoubleEnonce("v"),"y"===MM.faceToFace?document.getElementById("sddiv1").className="sddiv2 return":document.getElementById("sddiv1").className="sddiv2",document.getElementById("sddiv2").className="sddiv2",document.getElementById("sddiv3").className="hidden",document.getElementById("sddiv4").className="hidden",document.getElementById("divisionsOption").className="",document.querySelector("input[name='online'][value='no']").checked=!0,document.getElementById("onlinechoice").className="hidden",value>MM.carts.length?MM.carts[0].target=[1,2]:(MM.carts[0].target=[1],MM.carts[1].target=[2])}else 3===value?("y"===MM.faceToFace?(document.getElementById("sddiv1").className="sddiv34 return",document.getElementById("sddiv2").className="sddiv34 return"):(document.getElementById("sddiv1").className="sddiv34",document.getElementById("sddiv2").className="sddiv34"),document.getElementById("sddiv3").className="sddiv34",document.getElementById("sddiv4").className="hidden",document.getElementById("divisionsOption").className="hidden",document.querySelector("input[name='online'][value='no']").checked=!0,document.getElementById("onlinechoice").className="hidden",MM.setDispositionDoubleEnonce("h"),1===MM.carts.length?MM.carts[0].target=[1,2,3]:2===MM.carts.length?(MM.carts[0].target=[1,2],MM.carts[1].target=[3]):(MM.carts[0].target=[1],MM.carts[1].target=[2],MM.carts[2].target=[3])):4===value&&("y"===MM.faceToFace?(document.getElementById("sddiv1").className="sddiv34 return",document.getElementById("sddiv2").className="sddiv34 return"):(document.getElementById("sddiv1").className="sddiv34",document.getElementById("sddiv2").className="sddiv34"),document.getElementById("sddiv3").className="sddiv34",document.getElementById("sddiv4").className="sddiv34",document.getElementById("onlinechoice").className="hidden",document.querySelector("input[name='online'][value='no']").checked=!0,document.getElementById("divisionsOption").className="hidden",MM.setDispositionDoubleEnonce("h"),1===MM.carts.length?MM.carts[0].target=[1,2,3,4]:2===MM.carts.length?(MM.carts[0].target=[1,2],MM.carts[1].target=[3,4]):3===MM.carts.length?(MM.carts[0].target=[1,2],MM.carts[1].target=[3],MM.carts[2].target=[4]):(MM.carts[0].target=[1],MM.carts[1].target=[2],MM.carts[2].target=[3],MM.carts[3].target=[4]));for(let i=0,l=MM.carts.length;i<l;i++)MM.carts[i].display()},setDispositionDoubleEnonce:function(option){"h"===option?(MM.slidersOrientation="h",document.getElementById("screen-division").className=""):(MM.slidersOrientation="v",document.getElementById("screen-division").className="vertical",document.querySelector("input[name='direction'][value='v']").checked=!0)}},library={ordre:{"grille-ecole":["11","10","9","8","7"],"grille-college":["6","5","4","3"],"grille-lycee":["2","G","T"]},open:function(json){let obj=new activity(json);MM.editedActivity=obj;var tab=document.querySelector("a[numero$='parameters'].tabs-menu-link");utils.resetAllTabs(),utils.addClass(tab,"is-active"),document.getElementById("tab-parameters").style.display="",document.getElementById("addToCart").className="",document.getElementById("removeFromCart").className="hidden",obj.display()},load:function(url){let reader=new XMLHttpRequest;reader.onload=()=>{let json=JSON.parse(reader.responseText),regexp;url=/\/(.*)\./.exec(url)[1],utils.setHistory("Exercice","u="+url),this.open(json)},reader.open("get","library/"+url+"?v"+MM.version),reader.send()},import:function(url){return new Promise((resolve,reject)=>{let reader=new XMLHttpRequest;reader.onload=function(){resolve(JSON.parse(reader.responseText))},reader.onerror=err=>{reject(err)},reader.open("get","library/"+url+"?v"+MM.version),reader.send()})},openContents:function(){let reader=new XMLHttpRequest;reader.onload=function(){MM.content=JSON.parse(reader.responseText),utils.createTuiles(),utils.createSearchCheckboxes(),utils.checkURL()},reader.open("get","library/content.json?v"+MM.version,!0),reader.send()},displayContent:function(level,base=!1){if(void 0===MM.content)return console.log("Pas de bibliothèque"),!1;let niveau={nom:"Recherche",themes:{}};if(_.isObject(level)){niveau.nom="Cette activité a été répartie en plusieurs";for(let exo in level){let found=!1;for(let niv in MM.content){if(found)break;if(_.isObject(MM.content[niv]))for(let theme in MM.content[niv].themes){if(found)break;for(let chap in MM.content[niv].themes[theme].chapitres){if(found)break;if(MM.content[niv].themes[theme].chapitres[chap].e.length>0){if(found)break;for(let i=0;i<MM.content[niv].themes[theme].chapitres[chap].e.length;i++)if(MM.content[niv].themes[theme].chapitres[chap].e[i].u===level[exo].u){level[exo].t=MM.content[niv].themes[theme].chapitres[chap].e[i].t,found=!0;break}}}}}}niveau.themes[0]={nom:"Cliquer pour ouvrir une activité",chapitres:{MM1:{n:"Cliquer sur Rechercher pour revenir ici",e:level}}}}else if(base)niveau=MM.content[level];else{if(level.length<3)return!1;const levels=document.querySelectorAll("#searchLevels input[name='searchlevel']:checked"),selectedLevels=[];levels.forEach(elt=>{selectedLevels.push(elt.value)});for(let niv in MM.content)if(!(selectedLevels.length>0&&selectedLevels.indexOf(niv)<0)&&_.isObject(MM.content[niv]))for(let theme in MM.content[niv].themes)for(let chap in MM.content[niv].themes[theme].chapitres){let chapExo=[];for(let exo=0,lene=MM.content[niv].themes[theme].chapitres[chap].e.length;exo<lene;exo++){let lexo=MM.content[niv].themes[theme].chapitres[chap].e[exo];if(lexo.t.toLowerCase().indexOf(level.toLowerCase())>-1){let reg=new RegExp(level.toLowerCase(),"gi");chapExo.push({u:lexo.u,t:lexo.t.replace(reg,(function(x){return"<mark>"+x+"</mark>"}))})}else lexo.u.toLowerCase().indexOf(level.toLowerCase())>-1?chapExo.push({u:lexo.u,t:lexo.t}):void 0!==lexo.d&&lexo.d.toLowerCase().indexOf(level.toLowerCase())>-1&&chapExo.push({u:lexo.u,t:lexo.t})}chapExo.length>0&&(niveau.themes[theme]||(niveau.themes[theme]={nom:MM.content[niv].nom+"/"+MM.content[niv].themes[theme].nom,chapitres:{}}),niveau.themes[theme].chapitres[chap]={n:MM.content[niv].themes[theme].chapitres[chap].n,e:chapExo})}}let html="";base||_.isObject(level)?_.isObject(level)?html="<h2>Cette activité MathsMentales v1 a été répartie en plusieurs activités</h2>":(html="<h1 class='pointer moins' onclick='utils.deploy(this)'>Niveau "+niveau.nom+" ("+niveau.activitiesNumber+" act.)</h1>",document.getElementById("searchinput").value=""):html="<h1 class='pointer moins' onclick='utils.deploy(this)'>Résultat de la recherche</h1>",base&&!_.isObject(level)&&utils.setHistory(niveau.nom,"n="+level);let itemsNumber=0;for(let i in niveau.themes){let theme=!1,htmlt="";htmlt+="<h2 class='pointer moins' onclick='utils.deploy(this)'>"+niveau.themes[i].nom+"</h2>";for(let j in niveau.themes[i].chapitres){let chapitre=!1,htmlc="";htmlc+="<h3 onclick='utils.deploy(this)' class='pointer moins'>"+niveau.themes[i].chapitres[j].n+"</h3>",htmlc+="<ul>";let nbexos=niveau.themes[i].chapitres[j].e.length;if(nbexos){itemsNumber+=nbexos,theme=!0,chapitre=!0;for(let k=0,len=nbexos;k<len;k++)htmlc+="<li onclick=\"library.load('"+niveau.themes[i].chapitres[j].e[k].u+"')\">"+niveau.themes[i].chapitres[j].e[k].t+"</li>"}else htmlc+="<li>Pas encore d'exercice</li>";htmlc+="</ul>",chapitre&&(htmlt+=htmlc)}theme&&(html+=htmlt)}document.getElementById("resultat-chercher").innerHTML=html;let target=document.getElementById("tab-chercher");target.className="tabs-content-item",itemsNumber>40&&utils.pageWidth()>1e3?utils.addClass(target,"cols3"):itemsNumber>20&&utils.pageWidth()>840&&utils.addClass(target,"cols2"),document.querySelector("#header-menu a[numero='#tab-chercher']").click()}};class keyBoard{constructor(target,keys){this.targetField=target,this.keys=keys}defaut(){}show(){}hide(){}}class activity{constructor(obj){_.isObject(obj)?this.setParams(obj):_.isString(obj)&&(this.id=obj)}setParams(obj){this.id=obj.id||obj.ID,this.type=obj.type,this.figure=obj.figure,this.title=obj.title,this.description=obj.description,this.vars=obj.vars,this.consts=obj.consts,this.canrepeat=obj.repeat||!1,this.options=utils.clone(obj.options)||void 0,this.questionPatterns=utils.clone(obj.questionPatterns)||obj.question,this.shortQuestionPatterns=utils.clone(obj.shortQuestionPatterns)||obj.shortq||!1,this.answerPatterns=utils.clone(obj.answerPatterns)||obj.answer,this.valuePatterns=utils.clone(obj.valuePatterns)||obj.value,this.questions=utils.clone(obj.questions)||[],this.shortQuestions=utils.clone(obj.shortQuestions)||[],this.answers=utils.clone(obj.answers)||[],this.samples=utils.clone(obj.samples)||[],this.values=utils.clone(obj.values)||[],this.figures=utils.clone(obj.figures)||[],this.examplesFigs={},this.chosenOptions=utils.clone(obj.chosenOptions)||[],this.chosenQuestions=utils.clone(obj.chosenQuestions)||{},this.chosenQuestionTypes=utils.clone(obj.chosenQuestionTypes)||[],this.tempo=utils.clone(obj.tempo)||Number(document.getElementById("tempo-slider").value),this.nbq=utils.clone(obj.nbq)||Number(document.getElementById("nbq-slider").value),this.getOptionHistory=[],this.getPatternHistory={global:[]}}initialize(){this.questions=[],this.shortQuestions=[],this.answers=[],this.values=[],this.figures=[],this.examplesFigs={}}setTempo(value){this.tempo=Number(value)}setNbq(value){this.nbq=Number(value)}export(){return"i="+this.id+"~o="+utils.tableToText(this.chosenOptions)+"~q="+utils.objToText(this.chosenQuestions)+"~p="+this.chosenQuestionTypes+"~t="+this.tempo+"~n="+this.nbq}static import(obj,id){let regexp,level,url="N"+/(^[\d*TG])/.exec(obj.i)[0]+"/"+obj.i+".json";return library.import(url).then(json=>{let act=new this(json);return act.chosenOptions=obj.o,act.chosenQuestionTypes=obj.p,act.chosenQuestions=obj.q,act.tempo=obj.t,act.nbq=obj.n,[id,act]},err=>{debug(err)})}getOption(){if(!this.options)return!1;let ret=0;return 0===this.getOptionHistory.length&&(this.chosenOptions.length>0?this.getOptionHistory=utils.shuffle(utils.clone(this.chosenOptions)):this.getOptionHistory=utils.shuffle(Array.from(Array(this.options.length).keys()))),ret=this.getOptionHistory[0],this.getOptionHistory.shift(),ret}setMath(content){return void 0===this.type||"latex"===this.type?'<span class="math">'+content+"</span>":content}display(cle="sample"){this.initialize(),document.getElementById("param-title-act").innerHTML=this.id,document.getElementById("activityTitle").innerHTML=this.title,this.description?document.getElementById("activityDescription").innerHTML=this.description:document.getElementById("activityDescription").innerHTML="";var examples=document.getElementById("activityOptions");if(examples.innerHTML="",utils.setSeed(cle),void 0!==this.options&&this.options.length>0){let colors=[""," red"," orange"," blue"," green"," grey"],p=utils.create("span",{className:"bold"}),hr=utils.create("hr"),input=utils.create("input",{type:"checkbox",id:"checkalloptions",className:"checkbox blue"});input.setAttribute("onclick","MM.editedActivity.setOption('all',this.checked)"),p.appendChild(input),p.appendChild(document.createTextNode(" Tout (dé)sélectionner")),examples.appendChild(p),examples.appendChild(hr);let optionsLen=0;for(let i=0;i<this.options.length;i++){this.generate(1,i,!1);let p=utils.create("span"),input=utils.create("input",{id:"o"+i,type:"checkbox",value:i,defaultChecked:this.chosenOptions.indexOf(i)>-1,className:"checkbox"+colors[i%colors.length]});input.setAttribute("onclick","MM.editedActivity.setOption(this.value, this.checked);"),p.appendChild(input),p.innerHTML+=" "+this.options[i].name+" :";let ul=document.createElement("ul");if(Array.isArray(this.questions[0]))for(let jj=0;jj<this.questions[0].length;jj++){optionsLen++;let li=utils.create("li",{className:"tooltip"}),checked="";this.chosenQuestions[i]&&this.chosenQuestions[i].indexOf(jj)>-1&&(checked="checked"),li.innerHTML="<input class='checkbox"+colors[i%colors.length]+"' type='checkbox' id='o"+i+"-"+jj+"' value='"+i+"-"+jj+"' onclick='MM.editedActivity.setOption(this.value, this.checked);'"+checked+"> "+this.setMath(this.questions[0][jj]);let span=utils.create("span",{className:"tooltiptext"});Array.isArray(this.answers[0])?span.innerHTML=this.setMath(String(this.answers[0][jj]).replace(this.questions[0],this.questions[0][jj])):span.innerHTML=this.setMath(String(this.answers[0]).replace(this.questions[0],this.questions[0][jj])),li.appendChild(span),ul.appendChild(li)}else{optionsLen++;let li=utils.create("li",{className:"tooltip",innerHTML:this.setMath(this.questions[0])});this.figures[0]&&(this.examplesFigs[i]=new Figure(utils.clone(this.figures[0]),"fig-ex"+i,li));let span=utils.create("span",{className:"tooltiptext",innerHTML:this.setMath(this.answers[0])});li.appendChild(span),ul.appendChild(li)}p.appendChild(ul),examples.appendChild(p)}optionsLen>3&&""===document.getElementById("phantom").className&&utils.addClass(document.getElementById("divparams"),"colsx2")}else{this.generate(1);let p=document.createElement("span"),ul=document.createElement("ul");if(Array.isArray(this.questions[0]))for(let jj=0;jj<this.questions[0].length;jj++){let li=document.createElement("li");li.className="tooltip",li.innerHTML="<input type='checkbox' class='checkbox' value='"+jj+"' onclick='MM.editedActivity.setQuestionType(this.value, this.checked);' ><span class='math'>"+this.questions[0][jj]+"</span>";let span=document.createElement("span");span.className="tooltiptext",Array.isArray(this.answers[0])?span.innerHTML=this.setMath(this.answers[0][jj].replace(this.questions[0],this.questions[0][jj])):span.innerHTML=this.setMath(this.answers[0].replace(this.questions[0],this.questions[0][jj])),li.appendChild(span),ul.appendChild(li)}else{let li=document.createElement("li");li.className="tooltip",li.innerHTML=this.setMath(this.questions[0]),this.figures[0]&&(this.examplesFigs[0]=new Figure(utils.clone(this.figures[0]),"fig-ex0",li));let span=document.createElement("span");span.className="tooltiptext",span.innerHTML=this.setMath(this.answers[0]),li.appendChild(span),ul.appendChild(li)}p.appendChild(ul),examples.appendChild(p)}utils.isEmpty(this.examplesFigs)||setTimeout(()=>{for(let i in this.examplesFigs)this.examplesFigs[i].display()},300),utils.mathRender()}getPattern(option){if(this.chosenQuestionTypes.length>0){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(utils.clone(this.chosenQuestionTypes)));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(!1===option&&Array.isArray(this.questionPatterns)){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(Array.from(Array(this.questionPatterns.length).keys())));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(!1===option)return!1;if(Array.isArray(this.chosenQuestions[option])||(this.chosenQuestions[option]=[]),Array.isArray(this.getPatternHistory[option])||(this.getPatternHistory[option]=[]),0===this.chosenQuestions[option].length&&Array.isArray(this.options[option].question)){0===this.getPatternHistory[option].length&&(this.getPatternHistory[option]=utils.shuffle(Array.from(Array(this.options[option].question.length).keys())));let ret=this.getPatternHistory[option][0];return this.getPatternHistory[option].shift(),ret}if(0===this.chosenQuestions[option].length&&!this.options[option].question&&Array.isArray(this.questionPatterns)){0===this.getPatternHistory.global.length&&(this.getPatternHistory.global=utils.shuffle(Array.from(Array(this.questionPatterns.length).keys())));let ret=this.getPatternHistory.global[0];return this.getPatternHistory.global.shift(),ret}if(this.chosenQuestions[option].length>0){0===this.getPatternHistory[option].length&&(this.getPatternHistory[option]=utils.shuffle(utils.clone(this.chosenQuestions[option])));let ret=this.getPatternHistory[option][0];return this.getPatternHistory[option].shift(),ret}return!1}setOption(value,check){var optionId,renderId;if("all"===value){this.chosenOptions=[];for(let i=0,len=this.options.length;i<len;i++){this.chosenQuestions[i]=[];let lenq=0;if("object"==typeof this.options[i].question?lenq=this.options[i].question.length:"object"==typeof this.questionPatterns&&(lenq=this.questionPatterns.length),check){this.chosenOptions.push(i);for(let j=0;j<lenq;j++)this.chosenQuestions[i].push(j),document.getElementById("o"+i+"-"+j).checked=!0;document.getElementById("o"+i).checked=!0}else{for(let j=0;j<lenq;j++)document.getElementById("o"+i+"-"+j).checked=!1;document.getElementById("o"+i).checked=!1}}}else if(value.indexOf("-")>-1){let Ids=value.split("-");optionId=Number(Ids[0]),renderId=Number(Ids[1]),check?(document.getElementById("o"+optionId).checked=!0,this.chosenOptions.indexOf(optionId)<0&&this.chosenOptions.push(optionId),Array.isArray(this.chosenQuestions[optionId])?this.chosenQuestions[optionId].indexOf(renderId)<0&&this.chosenQuestions[optionId].push(renderId):this.chosenQuestions[optionId]=[renderId]):this.chosenQuestions[optionId].removeValue(renderId)&&0===this.chosenQuestions[optionId].length&&(this.chosenOptions.removeValue(optionId),document.getElementById("o"+optionId).checked=!1)}else if(optionId=Number(value),check){if(this.chosenOptions.indexOf(optionId)<0&&this.chosenOptions.push(optionId),this.chosenQuestions[optionId]=[],"object"==typeof this.options[optionId].question)for(let i=0;i<this.options[optionId].question.length;i++)this.chosenQuestions[optionId].push(i),document.getElementById("o"+optionId+"-"+i).checked=!0;else if(Array.isArray(this.questionPatterns))for(let i=0;i<this.questionPatterns.length;i++)this.chosenQuestions[optionId].push(i),document.getElementById("o"+optionId+"-"+i).checked=!0}else if(this.chosenOptions.removeValue(optionId))if("object"==typeof this.options[optionId].question){for(let i=0;i<this.options[optionId].question.length;i++)document.getElementById("o"+optionId+"-"+i).checked=!1;delete this.chosenQuestions[optionId]}else if(Array.isArray(this.questionPatterns)){for(let i=0;i<this.questionPatterns.length;i++)document.getElementById("o"+optionId+"-"+i).checked=!1;delete this.chosenQuestions[optionId]}}setQuestionType(value,check){let questionId=Number(value);check?this.chosenQuestionTypes.indexOf(questionId)<0&&this.chosenQuestionTypes.push(questionId):this.chosenQuestionTypes.removeValue(questionId)}replaceVars(chaine,questiontext){function onlyVarw(all,p1,p2,decal,chaine){return"this.wVars['"+p1+"']"+p2}function onlyVarc(all,p1,p2,decal,chaine){return"this.cConsts['"+p1+"']"+p2}if("string"==typeof chaine){for(const c in this.wVars){let regex=new RegExp(":("+c+")([^\\w\\d])","g");chaine=chaine.replace(regex,onlyVarw)}for(const c in this.cConsts){let regex=new RegExp(":("+c+")([^\\w\\d])","g");chaine=chaine.replace(regex,onlyVarc)}if(void 0!==questiontext){let regex=/:question/g;chaine=chaine.replace(regex,questiontext)}let result="";try{result=eval("`"+chaine.replace(/\\/g,"\\\\")+"`")}catch(error){debug(error,"Erreur avec "+chaine)}return isNaN(result)?result:parseFloat(result)}if("object"==typeof chaine){if(_.isArray(chaine))for(let i=0;i<chaine.length;++i)chaine[i]=this.replaceVars(chaine[i],questiontext);else for(const i in chaine)chaine[i]=this.replaceVars(chaine[i],questiontext);return chaine}return chaine}generate(n=this.nbq,opt,patt,sample){let optionNumber,patternNumber,lenQ=!1;this.wVars={};let loopProtect=0,maxLoop=100;this.figures=[];for(let i=0;i<n;i++){this.cFigure=void 0,optionNumber=void 0!==opt?opt:this.getOption(),patternNumber=void 0!==patt?patt:this.getPattern(optionNumber),!1!==optionNumber?(void 0===this.options[optionNumber].vars?this.cVars=this.vars:this.cVars=this.options[optionNumber].vars,void 0===this.options[optionNumber].consts?this.cConsts=utils.clone(this.consts):this.cConsts=utils.clone(this.options[optionNumber].consts),!1!==patternNumber?void 0!==this.options[optionNumber].question?(this.cQuestion=this.options[optionNumber].question[patternNumber],lenQ=this.options[optionNumber].question.length,void 0!==this.options[optionNumber].shortq&&(this.cShortQ=this.options[optionNumber].shortq[patternNumber]||!1)):(this.cQuestion=this.questionPatterns[patternNumber],this.cShortQ=this.shortQuestionPatterns[patternNumber]||!1,lenQ=this.questionPatterns.length):void 0===this.options[optionNumber].question?(this.cQuestion=this.questionPatterns,this.cShortQ=this.shortQuestionPatterns||!1):(this.cQuestion=this.options[optionNumber].question,this.cShortQ=this.options[optionNumber].shortq||!1),void 0===this.options[optionNumber].answer?this.cAnswer=this.answerPatterns:this.cAnswer=this.options[optionNumber].answer,void 0===this.options[optionNumber].value?this.cValue=this.valuePatterns:this.cValue=this.options[optionNumber].value,Array.isArray(this.cAnswer)&&lenQ&&(this.cAnswer.length===lenQ?this.cAnswer=this.cAnswer[patternNumber]:this.cAnswer=this.cAnswer[math.aleaInt(0,this.cAnswer.length-1)],this.cValue.length===lenQ&&(this.cValue=this.cValue[patternNumber])),void 0!==this.options[optionNumber].figure?this.cFigure=utils.clone(this.options[optionNumber].figure):void 0!==this.figure&&(this.cFigure=utils.clone(this.figure))):(this.cVars=this.vars,this.cConsts=utils.clone(this.consts),!1!==patternNumber?(this.cQuestion=this.questionPatterns[patternNumber],this.cShortQ=this.shortQuestionPatterns[patternNumber]||!1):(this.cQuestion=this.questionPatterns,this.cShortQ=this.shortQuestionPatterns||!1),Array.isArray(this.answerPatterns)&&this.answerPatterns.length===this.questionPatterns.length?this.cAnswer=this.answerPatterns[patternNumber]:this.cAnswer=this.answerPatterns,this.cValue=this.valuePatterns,void 0!==this.figure&&(this.cFigure=utils.clone(this.figure)));for(const name in this.cVars)if(this.wVars[name]=this.cVars[name],"string"==typeof this.wVars[name]&&this.wVars[name].indexOf("${")>-1&&(this.wVars[name]=this.replaceVars(this.wVars[name])),"object"==typeof this.wVars[name])this.wVars[name]=this.replaceVars(this.wVars[name][math.aleaInt(0,this.wVars[name].length-1)]);else if("string"==typeof this.wVars[name]&&this.wVars[name].indexOf("_")>-1){var bornes=this.wVars[name].split("_");bornes[0].indexOf("d")>-1?this.wVars[name]=math.aleaFloat(Number(bornes[0].substring(1)),Number(bornes[1]),Number(bornes[2]),bornes[3],bornes[4]):this.wVars[name]=math.aleaInt(Number(bornes[0]),Number(bornes[1]),bornes[2],bornes[3])}if(void 0!==this.cConsts&&(this.cConsts=this.replaceVars(this.cConsts)),sample)this.sample={question:this.replaceVars(this.cQuestion)},this.cShortQ&&(this.sample.shortQuestion=this.replaceVars(this.cShortQ)),this.sample.answer=this.replaceVars(this.cAnswer,this.sample.question),void 0!==this.cFigure&&(this.sample.figure={type:this.cFigure.type,content:this.replaceVars(this.cFigure.content),boundingbox:this.cFigure.boundingbox,axis:this.cFigure.axis,grid:!!this.cFigure.grid});else{let thequestion=this.replaceVars(utils.clone(this.cQuestion)),thevalue=this.replaceVars(utils.clone(this.cValue)),theshort=!1;if(this.cShortQ&&(theshort=this.replaceVars(utils.clone(this.cShortQ))),loopProtect++,!(this.questions.indexOf(thequestion)<0||this.values.indexOf(thevalue)<0||this.canrepeat)){if(i--,loopProtect<100)continue;debug("Pas assez de données pour éviter les répétitions");break}if(this.canrepeat){let last5Questions=this.questions.slice(-5),last5values=this.values.slice(-5);if(last5Questions.indexOf(thequestion)>-1&&last5values.indexOf(thevalue)>-1){if(i--,loopProtect<100)continue;debug("Pas assez de données pour éviter les répétitions");break}}this.questions[i]=thequestion,this.shortQuestions[i]=theshort,this.answers[i]=this.replaceVars(utils.clone(this.cAnswer),thequestion),this.values[i]=thevalue,void 0!==this.cFigure&&(this.figures[i]={type:this.cFigure.type,content:this.replaceVars(utils.clone(this.cFigure.content)),boundingbox:this.cFigure.boundingbox,axis:this.cFigure.axis,grid:!!this.cFigure.grid})}}}generateSample(){let option=this.getOption();this.generate(1,option,this.getPattern(option),!0)}}